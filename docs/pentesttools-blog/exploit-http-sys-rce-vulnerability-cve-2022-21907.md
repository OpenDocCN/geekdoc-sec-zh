# 如何利用 HTTP.sys 远程代码执行漏洞(CVE-2022-21907)| Pentest-Tools.com

> 原文：<https://pentest-tools.com/blog/exploit-http-sys-rce-vulnerability-cve-2022-21907>

模式识别是我们社区中数百名安全专家[投票选择的](https://www.linkedin.com/feed/update/urn:li:activity:6896775866714841088)[](https://www.linkedin.com/feed/update/urn:li:activity:6896775866714841088)*[技能](https://www.linkedin.com/feed/update/urn:li:activity:6896775866714841088)来培养一个有价值的信息安全职业。虽然我们有一些与生俱来的模式识别能力，但发展它们是必不可少的——这是一个实践的问题。*

*在攻击性安全领域工作给了你很多机会去做这件事，新的漏洞已经成熟，可以仔细检查了。因此，让我们继续这样做，同时发现这个 CVE 如何携带来自前一段时间的另一个漏洞的回声。*

## ***什么是 CVE-2022-21907？***

*CVE-2022-21907 (CVSSv3 9.8)是一个影响 HTTP 协议栈(HTTP.sys)的严重漏洞。*

*等等，HTTP.sys 是什么？HTTP.sys 是现代微软视窗操作系统中的一个内核设备驱动程序，负责处理微软 IIS 等服务中的 HTTP 流量。*

*对该漏洞的大部分研究表明，您可以在运行未打补丁的 HTTP.sys 驱动程序的底层机器中触发臭名昭著的蓝屏死机。*

*这听起来有点耳熟吧？是的，它是！你们中的一些人可能已经想到了 [CVE-2021-31166](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-31166) ，这与我们当前的漏洞非常相似。*

*对于那些不记得 2021 年 5 月 21 日 CVE 的人来说，这是 HTTP 协议栈中的另一个漏洞，由一种释放后使用类型的错误引起，攻击者也可以“武器化”——通过适当的利用——并再次导致蓝屏死亡。*

*就该漏洞的传播范围而言，[微软指出](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907)这种 CVE 可以在 Windows 10、Windows 11、Windows Server 2019 和 Windows Server 2022 的各种版本中找到。*

*虽然 Windows 10 1809 和 Windows Server 2019 在默认情况下不容易受到攻击，但如果通过 EnableTrailerSupport 注册表值启用 HTTP 拖车支持，它们仍可能受到攻击，该注册表值可以在 HKEY*LOCAL*MACHINE \ System \ current control set \ Services \ HTTP \ Parameters 下找到。*

*该漏洞可能造成的破坏相当严重，尽管系统可能会在一次攻击后重新启动并正常运行，**后续攻击可能会导致完全拒绝服务**。*

## *CVE-2022-21907 是如何工作的？*

*根据 [Trellix](https://www.trellix.com/en-us/about/newsroom/stories/threat-labs/worming-your-way-in-through-iis-cve-2022-21907.html) 的研究人员进行的更深入的分析，使 CVE-2022-21907 打勾的是以下函数中的一个**未初始化的内存漏洞**:UlpAlllocateFactTracker&UlAllocateFastTrackerToLookaside。*

*通过不将 UlpAlllocateFactTracker 和 UlAllocateFastTrackerToLookaside 中分配的内存清零，攻击者可以将恶意负载注入未初始化的区域。*

 ***带有易受攻击的 HTTP.sys 驱动程序的 Windows 版本***

| 释放；排放；发布 | 默认情况下易受攻击 |
| --- | --- |
| Windows 10 20H2 | ✔ |
| Windows 10 21H1 | ✔ |
| Windows 10 21H2 | ✔ |
| Windows 11 | ✔ |
| Windows Server 20H2 | ✔ |
| Windows Server 2022 | ✔ |
| Windows 10 1809 | 需要启用 HTTP 尾部支持 |
| Windows Server 2019 | 需要启用 HTTP 尾部支持 |

## ***CVE-2022-21907 的业务影响***

*到目前为止，还没有发现可用于远程访问易受攻击目标的漏洞。但是，有一些公开的 PoC 漏洞可能会导致拒绝服务。*

*不想失去对任何关键系统和敏感数据的访问权的企业所有者和组织需要**保持他们的设备更新**，以消除威胁参与者造成的 DoS 风险。*

## ***如何用 CVE-2022-21907** 手动触发 BSoD*

*如果您想看看这个 CVE 的运行情况，并且有一个备用的 Windows 虚拟机，那么您可以在虚拟机的 IP 地址上使用 curl 执行以下请求。*

```
*`curl 192.168.0.164:80 -sH "Accept-encoding: 354429474810858105277502,753225473272192695969091599085146218998458873428858279498120&68&**82302744837636557755**9,2120453047251623940869443373783750655190662992171177571578371548748405709,03504570598828001819032433815484769110241925758402724193417475718971298,895259892660286842061499776,****************************267816, *, ,"`*
```

*我要感谢[nu11 security](https://github.com/nu11secur1ty)发布了第一个利用的 Python 概念证明，这有助于启动我们对这个 CVE 的研究。*

*下面是实际运行的命令:*

*要复制屏幕截图中的事件，您只需要一个易受攻击的 Windows 版本和一个使用 HTTP.sys 的服务，如 Microsoft IIS。*

*上表将帮助您确定您可用的机器是否易受攻击，或者指导您选择易受攻击的版本以供进一步研究。*

## ***如何缓解 CVE-2022-21907***

*检查完这些要求后，您现在就可以开始破解‘n’roll 了。双关语😁。*

*如果您有一台运行 Windows Server 2019 或 Windows 10 版本 1809 的机器，则有一个快速缓解方法可用。*

*如上所述，如果启用了 HTTP 拖车支持，这两个版本都很容易受到攻击，因此为了减轻攻击，可以**简单地修改 EnableTrailerSupport 注册表**。*

*为了消除漏洞，用户应该安装微软发布的[安全更新](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907#securityUpdates)来修补这个问题。*

## ***对你的“疯狂”有一个过程***

*有一种方法来满足你的好奇心总是对你有好处的。这就是为什么我鼓励你“窃取”我们发布的安全测试和道德开发指南中提供的方法。没有必要从零开始，如果你在一个给定的框架上迭代和改进，你可以取得更快的进展。真正经过你的考验！*

*很快会看到更多像这样的指南！*

*PS:我们还会不时更新它们，所以把这本书或者其他你想回头看的书做个书签吧。*