["```py\nfrom [bookutils](https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils) import YouTubeVideo\nYouTubeVideo('9htOliNwopc') \n```", "```py\n>>> from [fuzzingbook.ProbabilisticGrammarFuzzer](ProbabilisticGrammarFuzzer.html) import <identifier> \n```", "```py\n(S, opts(prob=X)) \n```", "```py\n>>> from [Grammars](Grammars.html) import US_PHONE_GRAMMAR, extend_grammar, opts\n>>> PROBABILISTIC_US_PHONE_GRAMMAR: Grammar = extend_grammar(US_PHONE_GRAMMAR,\n>>> {\n>>>       \"<lead-digit>\": [\n>>>                           \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\",\n>>>                           (\"9\", opts(prob=0.9))\n>>>                       ],\n>>> }) \n```", "```py\n>>> probabilistic_us_phone_fuzzer = ProbabilisticGrammarFuzzer(PROBABILISTIC_US_PHONE_GRAMMAR)\n>>> [probabilistic_us_phone_fuzzer.fuzz() for i in range(5)]\n['(918)925-2501',\n '(981)925-0792',\n '(934)995-5029',\n '(955)999-7801',\n '(964)927-0877'] \n```", "```py\ndef first_digit_via_string(x: int) -> int:\n    return ord(repr(x)[0]) - ord('0') \n```", "```py\nfirst_digit_via_string(2001) \n```", "```py\n2\n\n```", "```py\nimport [math](https://docs.python.org/3/library/math.html) \n```", "```py\ndef first_digit_via_log(x: int) -> int:\n    frac, whole = math.modf(math.log10(x))\n    return int(10 ** frac) \n```", "```py\nfirst_digit_via_log(2001) \n```", "```py\n2\n\n```", "```py\n(math.log10(1), math.log10(2)) \n```", "```py\n(0.0, 0.3010299956639812)\n\n```", "```py\n(math.log10(2), math.log10(3)) \n```", "```py\n(0.3010299956639812, 0.47712125471966244)\n\n```", "```py\ndef prob_leading_digit(d: int) -> float:\n    return math.log10(d + 1) - math.log10(d) \n```", "```py\ndigit_probs = [prob_leading_digit(d) for d in range(1, 10)]\n[(d, \"%.2f\" % digit_probs[d - 1]) for d in range(1, 10)] \n```", "```py\n[(1, '0.30'),\n (2, '0.18'),\n (3, '0.12'),\n (4, '0.10'),\n (5, '0.08'),\n (6, '0.07'),\n (7, '0.06'),\n (8, '0.05'),\n (9, '0.05')]\n\n```", "```py\n\"<expr>\":\n        [(\"<term> + <expr>\", opts(prob=0.1)),\n         (\"<term> - <expr>\", opts(prob=0.2)),\n         \"<term>\"] \n```", "```py\nimport [bookutils.setup](https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils) \n```", "```py\nfrom [Fuzzer](Fuzzer.html) import Fuzzer \n```", "```py\nfrom [GrammarFuzzer](GrammarFuzzer.html) import GrammarFuzzer, all_terminals, display_tree, DerivationTree \n```", "```py\nfrom [Grammars](Grammars.html) import is_valid_grammar, EXPR_GRAMMAR, START_SYMBOL, crange\nfrom [Grammars](Grammars.html) import opts, exp_string, exp_opt, set_opts\nfrom [Grammars](Grammars.html) import Grammar, Expansion \n```", "```py\nfrom [typing](https://docs.python.org/3/library/typing.html) import List, Dict, Set, Optional, cast, Any, Tuple \n```", "```py\nPROBABILISTIC_EXPR_GRAMMAR: Grammar = {\n    \"<start>\":\n        [\"<expr>\"],\n\n    \"<expr>\":\n        [(\"<term> + <expr>\", opts(prob=0.1)),\n         (\"<term> - <expr>\", opts(prob=0.2)),\n         \"<term>\"],\n\n    \"<term>\":\n        [(\"<factor> * <term>\", opts(prob=0.1)),\n         (\"<factor> / <term>\", opts(prob=0.1)),\n         \"<factor>\"\n         ],\n\n    \"<factor>\":\n        [\"+<factor>\", \"-<factor>\", \"(<expr>)\",\n            \"<leadinteger>\", \"<leadinteger>.<integer>\"],\n\n    \"<leadinteger>\":\n        [\"<leaddigit><integer>\", \"<leaddigit>\"],\n\n    # Benford's law: frequency distribution of leading digits\n    \"<leaddigit>\":\n        [(\"1\", opts(prob=0.301)),\n         (\"2\", opts(prob=0.176)),\n         (\"3\", opts(prob=0.125)),\n         (\"4\", opts(prob=0.097)),\n         (\"5\", opts(prob=0.079)),\n         (\"6\", opts(prob=0.067)),\n         (\"7\", opts(prob=0.058)),\n         (\"8\", opts(prob=0.051)),\n         (\"9\", opts(prob=0.046)),\n         ],\n\n    # Remaining digits are equally distributed\n    \"<integer>\":\n        [\"<digit><integer>\", \"<digit>\"],\n\n    \"<digit>\":\n        [\"0\", \"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\"],\n} \n```", "```py\nassert is_valid_grammar(PROBABILISTIC_EXPR_GRAMMAR, supported_opts={'prob'}) \n```", "```py\nleaddigits: List[Expansion] = PROBABILISTIC_EXPR_GRAMMAR[\"<leaddigit>\"]\nleaddigits \n```", "```py\n[('1', {'prob': 0.301}),\n ('2', {'prob': 0.176}),\n ('3', {'prob': 0.125}),\n ('4', {'prob': 0.097}),\n ('5', {'prob': 0.079}),\n ('6', {'prob': 0.067}),\n ('7', {'prob': 0.058}),\n ('8', {'prob': 0.051}),\n ('9', {'prob': 0.046})]\n\n```", "```py\nleaddigit_expansion = leaddigits[0]\nleaddigit_expansion \n```", "```py\n('1', {'prob': 0.301})\n\n```", "```py\nexp_string(leaddigit_expansion) \n```", "```py\n'1'\n\n```", "```py\ndef exp_prob(expansion: Expansion) -> float:\n  \"\"\"Return the options of an expansion\"\"\"\n    return exp_opt(expansion, 'prob') \n```", "```py\nexp_prob(leaddigit_expansion) \n```", "```py\n0.301\n\n```", "```py\nf = GrammarFuzzer(PROBABILISTIC_EXPR_GRAMMAR)\nf.fuzz() \n```", "```py\n'4 + ++--7.0 - -7 - +++7.3 * (1 * 3 + 5 / 3 / 5 + 2) * 38 * (2 + 8)'\n\n```", "```py\nfrom [GrammarCoverageFuzzer](GrammarCoverageFuzzer.html) import GrammarCoverageFuzzer  # minor dependency \n```", "```py\nf = GrammarCoverageFuzzer(PROBABILISTIC_EXPR_GRAMMAR)\nf.fuzz() \n```", "```py\n'1.30'\n\n```", "```py\ndef exp_probabilities(expansions: List[Expansion],\n                      nonterminal: str =\"<symbol>\") \\\n        -> Dict[Expansion, float]:\n    probabilities = [exp_prob(expansion) for expansion in expansions]\n    prob_dist = prob_distribution(probabilities, nonterminal)\n\n    prob_mapping: Dict[Expansion, float] = {}\n    for i in range(len(expansions)):\n        expansion = exp_string(expansions[i])\n        prob_mapping[expansion] = prob_dist[i]\n\n    return prob_mapping \n```", "```py\ndef prob_distribution(probabilities: List[Optional[float]],\n                      nonterminal: str = \"<symbol>\"):\n    epsilon = 0.00001\n\n    number_of_unspecified_probabilities = probabilities.count(None)\n    if number_of_unspecified_probabilities == 0:\n        sum_probabilities = cast(float, sum(probabilities))\n        assert abs(sum_probabilities - 1.0) < epsilon, \\\n            nonterminal + \": sum of probabilities must be 1.0\"\n        return probabilities\n\n    sum_of_specified_probabilities = 0.0\n    for p in probabilities:\n        if p is not None:\n            sum_of_specified_probabilities += p\n    assert 0 <= sum_of_specified_probabilities <= 1.0, \\\n        nonterminal + \": sum of specified probabilities must be between 0.0 and 1.0\"\n\n    default_probability = ((1.0 - sum_of_specified_probabilities)\n                           / number_of_unspecified_probabilities)\n    all_probabilities = []\n    for p in probabilities:\n        if p is None:\n            p = default_probability\n        all_probabilities.append(p)\n\n    assert abs(sum(all_probabilities) - 1.0) < epsilon\n    return all_probabilities \n```", "```py\nprint(exp_probabilities(PROBABILISTIC_EXPR_GRAMMAR[\"<leaddigit>\"])) \n```", "```py\n{'1': 0.301, '2': 0.176, '3': 0.125, '4': 0.097, '5': 0.079, '6': 0.067, '7': 0.058, '8': 0.051, '9': 0.046}\n\n```", "```py\nprint(exp_probabilities(PROBABILISTIC_EXPR_GRAMMAR[\"<digit>\"])) \n```", "```py\n{'0': 0.1, '1': 0.1, '2': 0.1, '3': 0.1, '4': 0.1, '5': 0.1, '6': 0.1, '7': 0.1, '8': 0.1, '9': 0.1}\n\n```", "```py\nexp_probabilities(PROBABILISTIC_EXPR_GRAMMAR[\"<expr>\"]) \n```", "```py\n{'<term> + <expr>': 0.1, '<term> - <expr>': 0.2, '<term>': 0.7}\n\n```", "```py\ndef is_valid_probabilistic_grammar(grammar: Grammar,\n                                   start_symbol: str = START_SYMBOL) -> bool:\n    if not is_valid_grammar(grammar, start_symbol):\n        return False\n\n    for nonterminal in grammar:\n        expansions = grammar[nonterminal]\n        _ = exp_probabilities(expansions, nonterminal)\n\n    return True \n```", "```py\nassert is_valid_probabilistic_grammar(PROBABILISTIC_EXPR_GRAMMAR) \n```", "```py\nassert is_valid_probabilistic_grammar(EXPR_GRAMMAR) \n```", "```py\nfrom [ExpectError](ExpectError.html) import ExpectError \n```", "```py\nwith ExpectError():\n    assert is_valid_probabilistic_grammar({\"<start>\": [(\"1\", opts(prob=0.5))]}) \n```", "```py\nTraceback (most recent call last):\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/1729613243.py\", line 2, in <module>\n    assert is_valid_probabilistic_grammar({\"<start>\": [(\"1\", opts(prob=0.5))]})\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/3185228479.py\", line 8, in is_valid_probabilistic_grammar\n    _ = exp_probabilities(expansions, nonterminal)\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/4013279880.py\", line 5, in exp_probabilities\n    prob_dist = prob_distribution(probabilities, nonterminal)  # type: ignore\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/1431748745.py\", line 8, in prob_distribution\n    assert abs(sum_probabilities - 1.0) < epsilon, \\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: <start>: sum of probabilities must be 1.0 (expected)\n\n```", "```py\nwith ExpectError():\n    assert is_valid_probabilistic_grammar(\n        {\"<start>\": [(\"1\", opts(prob=1.5)), \"2\"]}) \n```", "```py\nTraceback (most recent call last):\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/2913569331.py\", line 2, in <module>\n    assert is_valid_probabilistic_grammar(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/3185228479.py\", line 8, in is_valid_probabilistic_grammar\n    _ = exp_probabilities(expansions, nonterminal)\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/4013279880.py\", line 5, in exp_probabilities\n    prob_dist = prob_distribution(probabilities, nonterminal)  # type: ignore\n                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_11325/1431748745.py\", line 16, in prob_distribution\n    assert 0 <= sum_of_specified_probabilities <= 1.0, \\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: <start>: sum of specified probabilities must be between 0.0 and 1.0 (expected)\n\n```", "```py\nimport [random](https://docs.python.org/3/library/random.html) \n```", "```py\nclass ProbabilisticGrammarFuzzer(GrammarFuzzer):\n  \"\"\"A grammar-based fuzzer respecting probabilities in grammars.\"\"\"\n\n    def check_grammar(self) -> None:\n        super().check_grammar()\n        assert is_valid_probabilistic_grammar(self.grammar, self.start_symbol)\n\n    def supported_opts(self) -> Set[str]:\n        return super().supported_opts() | {'prob'} \n```", "```py\nclass ProbabilisticGrammarFuzzer(ProbabilisticGrammarFuzzer):\n    def choose_node_expansion(self, node: DerivationTree,\n                              children_alternatives: List[Any]) -> int:\n        (symbol, tree) = node\n        expansions = self.grammar[symbol]\n        probabilities = exp_probabilities(expansions)\n\n        weights: List[float] = []\n        for children in children_alternatives:\n            expansion = all_terminals((symbol, children))\n            children_weight = probabilities[expansion]\n            if self.log:\n                print(repr(expansion), \"p =\", children_weight)\n            weights.append(children_weight)\n\n        if sum(weights) == 0:\n            # No alternative (probably expanding at minimum cost)\n            return random.choices(\n                range(len(children_alternatives)))[0]\n        else:\n            return random.choices(\n                range(len(children_alternatives)), weights=weights)[0] \n```", "```py\nnatural_fuzzer = ProbabilisticGrammarFuzzer(\n    PROBABILISTIC_EXPR_GRAMMAR, start_symbol=\"<leadinteger>\")\nprint([natural_fuzzer.fuzz() for i in range(20)]) \n```", "```py\n['2588', '106', '10', '2', '7', '1', '95', '4', '192', '8', '2', '1', '1', '2', '2', '208', '1036', '5592', '157', '1442']\n\n```", "```py\ninteger_fuzzer = GrammarFuzzer(\n    PROBABILISTIC_EXPR_GRAMMAR, start_symbol=\"<leadinteger>\")\nprint([integer_fuzzer.fuzz() for i in range(20)]) \n```", "```py\n['3', '1', '56', '5', '408251024', '7', '27', '2', '9', '6456', '7', '32', '1', '4', '7', '19', '2', '6', '2', '5']\n\n```", "```py\nleaddigit_fuzzer = ProbabilisticGrammarFuzzer(\n    PROBABILISTIC_EXPR_GRAMMAR, start_symbol=\"<leaddigit>\")\nleaddigit_fuzzer.fuzz() \n```", "```py\n'8'\n\n```", "```py\ntrials = 10000\n\ncount = {}\nfor c in crange('0', '9'):\n    count[c] = 0\n\nfor i in range(trials):\n    count[leaddigit_fuzzer.fuzz()] += 1\n\nprint([(digit, count[digit] / trials) for digit in count]) \n```", "```py\n[('0', 0.0), ('1', 0.3003), ('2', 0.1756), ('3', 0.1222), ('4', 0.0938), ('5', 0.0816), ('6', 0.0651), ('7', 0.06), ('8', 0.0537), ('9', 0.0477)]\n\n```", "```py\ndef set_prob(grammar: Grammar, symbol: str, \n             expansion: Expansion, prob: Optional[float]) -> None:\n  \"\"\"Set the probability of the given expansion of grammar[symbol]\"\"\"\n    set_opts(grammar, symbol, expansion, opts(prob=prob)) \n```", "```py\nfrom [Grammars](Grammars.html) import URL_GRAMMAR, extend_grammar \n```", "```py\nprobabilistic_url_grammar = extend_grammar(URL_GRAMMAR)\nset_prob(probabilistic_url_grammar, \"<scheme>\", \"ftps\", 0.8)\nassert is_valid_probabilistic_grammar(probabilistic_url_grammar) \n```", "```py\nprobabilistic_url_grammar[\"<scheme>\"] \n```", "```py\n['http', 'https', 'ftp', ('ftps', {'prob': 0.8})]\n\n```", "```py\nprob_url_fuzzer = ProbabilisticGrammarFuzzer(probabilistic_url_grammar)\nfor i in range(10):\n    print(prob_url_fuzzer.fuzz()) \n```", "```py\nftps://cispa.saarland:80\nftps://user:password@cispa.saarland/\nftps://fuzzingbook.com/abc\nftps://fuzzingbook.com/x48\nftps://user:password@fuzzingbook.com/\nftps://www.google.com:2?x18=8\nftps://user:password@www.google.com:6\nftps://user:password@cispa.saarland/def\nftps://user:password@cispa.saarland/def?def=52\nftps://user:password@cispa.saarland/\n\n```", "```py\nset_prob(probabilistic_url_grammar, \"<scheme>\", \"ftps\", 0.0)\nassert is_valid_probabilistic_grammar(probabilistic_url_grammar) \n```", "```py\nprob_url_fuzzer = ProbabilisticGrammarFuzzer(probabilistic_url_grammar)\nfor i in range(10):\n    print(prob_url_fuzzer.fuzz()) \n```", "```py\nftp://user:password@cispa.saarland/x00\nhttps://user:password@www.google.com/?def=6&def=x18&def=def\nhttps://user:password@fuzzingbook.com:7/?def=abc\nhttps://user:password@www.google.com:8080/\nftp://www.google.com/?abc=36&x34=5\nhttp://user:password@cispa.saarland/\nhttps://www.google.com/\nhttps://user:password@www.google.com:85/?def=18\nhttp://user:password@www.google.com:80/\nhttp://fuzzingbook.com:80/?abc=def\n\n```", "```py\nfrom [Grammars](Grammars.html) import EXPR_GRAMMAR \n```", "```py\nprobabilistic_expr_grammar = extend_grammar(EXPR_GRAMMAR)\nprobabilistic_expr_grammar[\"<expr>\"] \n```", "```py\n['<term> + <expr>', '<term> - <expr>', '<term>']\n\n```", "```py\nset_prob(probabilistic_expr_grammar, \"<expr>\", \"<term>\", 0.0)\nassert is_valid_probabilistic_grammar(probabilistic_expr_grammar) \n```", "```py\nprob_expr_fuzzer = ProbabilisticGrammarFuzzer(probabilistic_expr_grammar)\nprob_expr_fuzzer.fuzz() \n```", "```py\n'44 / 7 / 1 * 3 / 6 - +1.63 + 3 * 7 + 1 - 2'\n\n```", "```py\ndef decrange(start: int, end: int) -> List[Expansion]:\n  \"\"\"Return a list with string representations of numbers in the range [start, end)\"\"\"\n    return [repr(n) for n in range(start, end)] \n```", "```py\nIP_ADDRESS_GRAMMAR: Grammar = {\n    \"<start>\": [\"<address>\"],\n    \"<address>\": [\"<octet>.<octet>.<octet>.<octet>\"],\n    # [\"0\", \"1\", \"2\", ..., \"255\"]\n    \"<octet>\": decrange(0, 256)\n} \n```", "```py\nprint(IP_ADDRESS_GRAMMAR[\"<octet>\"][:20]) \n```", "```py\n['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19']\n\n```", "```py\nassert is_valid_grammar(IP_ADDRESS_GRAMMAR) \n```", "```py\nip_fuzzer = ProbabilisticGrammarFuzzer(IP_ADDRESS_GRAMMAR)\nip_fuzzer.fuzz() \n```", "```py\n'34.155.77.136'\n\n```", "```py\nprobabilistic_ip_address_grammar = extend_grammar(IP_ADDRESS_GRAMMAR)\nset_prob(probabilistic_ip_address_grammar, \"<octet>\", \"127\", 0.8) \n```", "```py\nprobabilistic_ip_fuzzer = ProbabilisticGrammarFuzzer(\n    probabilistic_ip_address_grammar)\nprobabilistic_ip_fuzzer.fuzz() \n```", "```py\n'127.127.127.127'\n\n```", "```py\nfrom [GrammarCoverageFuzzer](GrammarCoverageFuzzer.html) import duplicate_context  # minor dependency \n```", "```py\nprobabilistic_ip_address_grammar = extend_grammar(IP_ADDRESS_GRAMMAR)\nduplicate_context(probabilistic_ip_address_grammar, \"<address>\") \n```", "```py\nprobabilistic_ip_address_grammar[\"<address>\"] \n```", "```py\n['<octet-1>.<octet-2>.<octet-3>.<octet-4>']\n\n```", "```py\nset_prob(probabilistic_ip_address_grammar, \"<octet-1>\", \"127\", 1.0)\nset_prob(probabilistic_ip_address_grammar, \"<octet-2>\", \"0\", 1.0) \n```", "```py\nassert is_valid_probabilistic_grammar(probabilistic_ip_address_grammar) \n```", "```py\nprobabilistic_ip_fuzzer = ProbabilisticGrammarFuzzer(\n    probabilistic_ip_address_grammar)\n[probabilistic_ip_fuzzer.fuzz() for i in range(5)] \n```", "```py\n['127.0.201.77',\n '127.0.98.36',\n '127.0.12.232',\n '127.0.146.161',\n '127.0.245.151']\n\n```", "```py\nfrom [Parser](Parser.html) import Parser, EarleyParser \n```", "```py\nIP_ADDRESS_TOKENS = {\"<octet>\"}  # EarleyParser needs explicit tokens \n```", "```py\nparser = EarleyParser(IP_ADDRESS_GRAMMAR) \n```", "```py\ntree, *_ = parser.parse(\"127.0.0.1\")\ndisplay_tree(tree) \n```", "```py\nfrom [GrammarCoverageFuzzer](GrammarCoverageFuzzer.html) import expansion_key  # minor dependency \n```", "```py\nfrom [Grammars](Grammars.html) import is_nonterminal \n```", "```py\nclass ExpansionCountMiner:\n    def __init__(self, parser: Parser, log: bool = False) -> None:\n        assert isinstance(parser, Parser)\n        self.grammar = extend_grammar(parser.grammar())\n        self.parser = parser\n        self.log = log\n        self.reset() \n```", "```py\nclass ExpansionCountMiner(ExpansionCountMiner):\n    def reset(self) -> None:\n        self.expansion_counts: Dict[str, int] = {}\n\n    def add_coverage(self, symbol: str, children: List[DerivationTree]) -> None:\n        key = expansion_key(symbol, children)\n\n        if self.log:\n            print(\"Found\", key)\n\n        if key not in self.expansion_counts:\n            self.expansion_counts[key] = 0\n        self.expansion_counts[key] += 1\n\n    def add_tree(self, tree: DerivationTree) -> None:\n        (symbol, children) = tree\n        if not is_nonterminal(symbol):\n            return\n        assert children is not None\n\n        direct_children: List[DerivationTree] = [\n            (symbol, None) if is_nonterminal(symbol) \n            else (symbol, []) for symbol, c in children]\n        self.add_coverage(symbol, direct_children)\n\n        for c in children:\n            self.add_tree(c) \n```", "```py\nclass ExpansionCountMiner(ExpansionCountMiner):\n    def count_expansions(self, inputs: List[str]) -> None:\n        for inp in inputs:\n            tree, *_ = self.parser.parse(inp)\n            self.add_tree(tree)\n\n    def counts(self) -> Dict[str, int]:\n        return self.expansion_counts \n```", "```py\nexpansion_count_miner = ExpansionCountMiner(EarleyParser(IP_ADDRESS_GRAMMAR)) \n```", "```py\nexpansion_count_miner.count_expansions([\"127.0.0.1\", \"1.2.3.4\"])\nexpansion_count_miner.counts() \n```", "```py\n{'<start> -> <address>': 2,\n '<address> -> <octet>.<octet>.<octet>.<octet>': 2,\n '<octet> -> 127': 1,\n '<octet> -> 0': 2,\n '<octet> -> 1': 2,\n '<octet> -> 2': 1,\n '<octet> -> 3': 1,\n '<octet> -> 4': 1}\n\n```", "```py\nclass ProbabilisticGrammarMiner(ExpansionCountMiner):\n    def set_probabilities(self, counts: Dict[str, int]):\n        for symbol in self.grammar:\n            self.set_expansion_probabilities(symbol, counts)\n\n    def set_expansion_probabilities(self, symbol: str, counts: Dict[str, int]):\n        expansions = self.grammar[symbol]\n        if len(expansions) == 1:\n            set_prob(self.grammar, symbol, expansions[0], None)\n            return\n\n        expansion_counts = [\n            counts.get(\n                expansion_key(\n                    symbol,\n                    expansion),\n                0) for expansion in expansions]\n        total = sum(expansion_counts)\n        for i, expansion in enumerate(expansions):\n            p = expansion_counts[i] / total if total > 0 else None\n            # if self.log:\n            #     print(\"Setting\", expansion_key(symbol, expansion), p)\n            set_prob(self.grammar, symbol, expansion, p) \n```", "```py\nclass ProbabilisticGrammarMiner(ProbabilisticGrammarMiner):\n    def mine_probabilistic_grammar(self, inputs: List[str]) -> Grammar:\n        self.count_expansions(inputs)\n        self.set_probabilities(self.counts())\n        return self.grammar \n```", "```py\nprobabilistic_grammar_miner = ProbabilisticGrammarMiner(\n    EarleyParser(IP_ADDRESS_GRAMMAR)) \n```", "```py\nprobabilistic_ip_address_grammar = probabilistic_grammar_miner.mine_probabilistic_grammar([\n                                                                                          \"127.0.0.1\", \"1.2.3.4\"]) \n```", "```py\nassert is_valid_probabilistic_grammar(probabilistic_ip_address_grammar) \n```", "```py\n[expansion for expansion in probabilistic_ip_address_grammar['<octet>']\n    if exp_prob(expansion) > 0] \n```", "```py\n[('0', {'prob': 0.25}),\n ('1', {'prob': 0.25}),\n ('2', {'prob': 0.125}),\n ('3', {'prob': 0.125}),\n ('4', {'prob': 0.125}),\n ('127', {'prob': 0.125})]\n\n```", "```py\nprobabilistic_ip_fuzzer = ProbabilisticGrammarFuzzer(\n    probabilistic_ip_address_grammar)\n[probabilistic_ip_fuzzer.fuzz() for i in range(10)] \n```", "```py\n['4.2.2.0',\n '2.1.4.0',\n '0.1.3.127',\n '0.3.0.127',\n '4.0.2.1',\n '3.127.0.0',\n '2.2.1.1',\n '4.0.1.0',\n '2.4.0.1',\n '0.0.3.127']\n\n```", "```py\nURL_SAMPLE: List[str] = [\n    \"https://user:password@cispa.saarland:80/\",\n    \"https://fuzzingbook.com?def=56&x89=3&x46=48&def=def\",\n    \"https://cispa.saarland:80/def?def=7&x23=abc\",\n    \"https://fuzzingbook.com:80/\",\n    \"https://fuzzingbook.com:80/abc?def=abc&abc=x14&def=abc&abc=2&def=38\",\n    \"ftps://fuzzingbook.com/x87\",\n    \"https://user:password@fuzzingbook.com:6?def=54&x44=abc\",\n    \"http://fuzzingbook.com:80?x33=25&def=8\",\n    \"http://fuzzingbook.com:8080/def\",\n] \n```", "```py\nURL_TOKENS: Set[str] = {\"<scheme>\", \"<userinfo>\", \"<host>\", \"<port>\", \"<id>\"} \n```", "```py\nurl_parser = EarleyParser(URL_GRAMMAR, tokens=URL_TOKENS)\nurl_input = URL_SAMPLE[2]\nprint(url_input)\ntree, *_ = url_parser.parse(url_input)\ndisplay_tree(tree) \n```", "```py\nhttps://cispa.saarland:80/def?def=7&x23=abc\n\n```", "```py\nprobabilistic_grammar_miner = ProbabilisticGrammarMiner(url_parser)\nprobabilistic_url_grammar = probabilistic_grammar_miner.mine_probabilistic_grammar(\n    URL_SAMPLE) \n```", "```py\nprint(probabilistic_grammar_miner.counts()) \n```", "```py\n{'<start> -> <url>': 9, '<url> -> <scheme>://<authority><path><query>': 9, '<scheme> -> https': 6, '<authority> -> <userinfo>@<host>:<port>': 2, '<userinfo> -> user:password': 2, '<host> -> cispa.saarland': 2, '<port> -> 80': 5, '<path> -> /': 2, '<query> -> <query>': 4, '<authority> -> <host>': 2, '<host> -> fuzzingbook.com': 7, '<path> -> <path>': 3, '<query> -> ?<params>': 5, '<params> -> <param>&<params>': 10, '<param> -> <id>=<nat>': 9, '<id> -> def': 11, '<nat> -> <digit><digit>': 5, '<digit> -> 5': 3, '<digit> -> 6': 1, '<id> -> x89': 1, '<nat> -> <digit>': 4, '<digit> -> 3': 2, '<id> -> x46': 1, '<digit> -> 4': 2, '<digit> -> 8': 3, '<params> -> <param>': 5, '<param> -> <id>=<id>': 6, '<authority> -> <host>:<port>': 5, '<path> -> /<id>': 4, '<digit> -> 7': 1, '<id> -> x23': 1, '<id> -> abc': 7, '<id> -> x14': 1, '<digit> -> 2': 2, '<scheme> -> ftps': 1, '<id> -> x87': 1, '<port> -> 6': 1, '<id> -> x44': 1, '<scheme> -> http': 2, '<id> -> x33': 1, '<port> -> 8080': 1}\n\n```", "```py\nprobabilistic_url_grammar['<scheme>'] \n```", "```py\n[('http', {'prob': 0.2222222222222222}),\n ('https', {'prob': 0.6666666666666666}),\n ('ftp', {'prob': 0.0}),\n ('ftps', {'prob': 0.1111111111111111})]\n\n```", "```py\nprobabilistic_url_grammar['<params>'] \n```", "```py\n[('<param>', {'prob': 0.3333333333333333}),\n ('<param>&<params>', {'prob': 0.6666666666666666})]\n\n```", "```py\ng = ProbabilisticGrammarFuzzer(probabilistic_url_grammar)\n[g.fuzz() for i in range(10)] \n```", "```py\n['https://fuzzingbook.com/def?def=abc&def=abc&def=def&def=abc&abc=def&def=def&abc=def',\n 'http://fuzzingbook.com:80/def?def=7&def=abc&abc=88',\n 'https://cispa.saarland/def?def=2',\n 'http://user:password@fuzzingbook.com:80/def?abc=abc&def=78',\n 'http://cispa.saarland:80/?def=54&def=abc',\n 'https://fuzzingbook.com:80/def?def=def',\n 'http://fuzzingbook.com:80/abc?abc=abc&abc=def&def=85&abc=7&def=6&abc=2&def=abc',\n 'https://fuzzingbook.com/abc?def=32&def=3&abc=4',\n 'http://fuzzingbook.com/def?abc=24&def=def&def=48',\n 'https://cispa.saarland:80/?abc=abc']\n\n```", "```py\nimport [copy](https://docs.python.org/3/library/copy.html) \n```", "```py\ndef invert_expansion(expansion: List[Expansion]) -> List[Expansion]:\n    def sort_by_prob(x: Tuple[int, float]) -> float:\n        index, prob = x\n        return prob if prob is not None else 0.0\n\n    inverted_expansion: List[Expansion] = copy.deepcopy(expansion)\n    indexes_and_probs = [(index, exp_prob(alternative))\n                         for index, alternative in enumerate(expansion)]\n    indexes_and_probs.sort(key=sort_by_prob)\n    indexes = [i for (i, _) in indexes_and_probs]\n\n    for j in range(len(indexes)):\n        k = len(indexes) - 1 - j\n        # print(indexes[j], \"gets\", indexes[k])\n        inverted_expansion[indexes[j]][1]['prob'] = expansion[indexes[k]][1]['prob']\n\n    return inverted_expansion \n```", "```py\nprobabilistic_url_grammar['<scheme>'] \n```", "```py\n[('http', {'prob': 0.2222222222222222}),\n ('https', {'prob': 0.6666666666666666}),\n ('ftp', {'prob': 0.0}),\n ('ftps', {'prob': 0.1111111111111111})]\n\n```", "```py\ninvert_expansion(probabilistic_url_grammar['<scheme>']) \n```", "```py\n[('http', {'prob': 0.1111111111111111}),\n ('https', {'prob': 0.0}),\n ('ftp', {'prob': 0.6666666666666666}),\n ('ftps', {'prob': 0.2222222222222222})]\n\n```", "```py\ninvert_expansion(invert_expansion(probabilistic_url_grammar['<scheme>'])) \n```", "```py\n[('http', {'prob': 0.2222222222222222}),\n ('https', {'prob': 0.6666666666666666}),\n ('ftp', {'prob': 0.0}),\n ('ftps', {'prob': 0.1111111111111111})]\n\n```", "```py\ndef invert_probs(grammar: Grammar) -> Grammar:\n    inverted_grammar = extend_grammar(grammar)\n    for symbol in grammar:\n        inverted_grammar[symbol] = invert_expansion(grammar[symbol])\n    return inverted_grammar \n```", "```py\nprobabilistic_url_grammar[\"<digit>\"] \n```", "```py\n[('0', {'prob': 0.0}),\n ('1', {'prob': 0.0}),\n ('2', {'prob': 0.14285714285714285}),\n ('3', {'prob': 0.14285714285714285}),\n ('4', {'prob': 0.14285714285714285}),\n ('5', {'prob': 0.21428571428571427}),\n ('6', {'prob': 0.07142857142857142}),\n ('7', {'prob': 0.07142857142857142}),\n ('8', {'prob': 0.21428571428571427}),\n ('9', {'prob': 0.0})]\n\n```", "```py\ninverted_probabilistic_url_grammar = invert_probs(probabilistic_url_grammar)\ninverted_probabilistic_url_grammar[\"<digit>\"] \n```", "```py\n[('0', {'prob': 0.21428571428571427}),\n ('1', {'prob': 0.21428571428571427}),\n ('2', {'prob': 0.07142857142857142}),\n ('3', {'prob': 0.07142857142857142}),\n ('4', {'prob': 0.0}),\n ('5', {'prob': 0.0}),\n ('6', {'prob': 0.14285714285714285}),\n ('7', {'prob': 0.14285714285714285}),\n ('8', {'prob': 0.0}),\n ('9', {'prob': 0.14285714285714285})]\n\n```", "```py\ng = ProbabilisticGrammarFuzzer(inverted_probabilistic_url_grammar)\n[g.fuzz() for i in range(10)] \n```", "```py\n['ftp://www.google.com',\n 'ftp://www.google.com/',\n 'ftp://www.google.com/',\n 'ftp://user:password@cispa.saarland',\n 'ftps://www.google.com/',\n 'ftp://user:password@www.google.com/',\n 'ftp://user:password@www.google.com',\n 'ftp://www.google.com/',\n 'ftp://user:password@www.google.com',\n 'ftp://user:password@www.google.com/']\n\n```", "```py\n...\n        elif c == '%':\n            digit_high, digit_low = s[i + 1], s[i + 2]\n            i += 2\n            if digit_high in hex_values and digit_low in hex_values:\n                v = hex_values[digit_high] * 16 + hex_values[digit_low] ### Line 25\n                t += chr(v)\n        ... \n```", "```py\nfrom [Coverage](Coverage.html) import Coverage, cgi_decode\nfrom [Grammars](Grammars.html) import CGI_GRAMMAR \n```", "```py\ncgi_fuzzer = GrammarFuzzer(CGI_GRAMMAR) \n```", "```py\ntrials = 100\ncoverage = {}\n\nfor i in range(trials):\n    cgi_input = cgi_fuzzer.fuzz()\n    with Coverage() as cov:\n        cgi_decode(cgi_input)\n    coverage[cgi_input] = cov.coverage() \n```", "```py\ncoverage_slice = [cgi_input for cgi_input in coverage\n                  if ('cgi_decode', 25) in coverage[cgi_input]] \n```", "```py\nprint(coverage_slice) \n```", "```py\n['%36%c1%d2c2%4f++e', '%2c%90+', 'c++%8b', 'a+%95', '%76%00', '+5', '4', '+', 'a', '%71', '%a2', '%39%51%db%7c%66', '++', '%2a', 'd', '%b9225', '++c', '%13+b', '%32', '2', '+2+', '-1%b11%d8', '%08', 'd+4', '%a3', '%fe', 'e', '1++', '+%82%ed%42', '%d5', '%5bc', '51', '%b0', '%47', 'b+%20', '%d7', '0+%17', '%a5', '%84', 'e+4%fc', 'd%6f+++1a', '3', 'd+%95+', '%1e', '%244', '%3c', '5%75+%99%3c', '+-', 'b', '%80%74+a', '%a7', '21', 'ae', '%c1%da', '%c5+', 'b%44', '%70%c4_3', '1', 'dd+ad', '4%63', '%364+', '%79%ab', '%8a%f6', '%53%43', '+++%55+b5', '%51+++', '+%28', '1%1c+', '+%41%9b', '%0d%20', '+%3d+%c2']\n\n```", "```py\nlen(coverage_slice) / trials \n```", "```py\n0.71\n\n```", "```py\nprobabilistic_grammar_miner = ProbabilisticGrammarMiner(\n    EarleyParser(CGI_GRAMMAR))\nprobabilistic_cgi_grammar = probabilistic_grammar_miner.mine_probabilistic_grammar(\n    coverage_slice) \n```", "```py\nassert is_valid_probabilistic_grammar(probabilistic_cgi_grammar) \n```", "```py\nprobabilistic_cgi_grammar['<letter>'] \n```", "```py\n[('<plus>', {'prob': 0.2556818181818182}),\n ('<percent>', {'prob': 0.42045454545454547}),\n ('<other>', {'prob': 0.32386363636363635})]\n\n```", "```py\nprobabilistic_cgi_fuzzer = ProbabilisticGrammarFuzzer(\n    probabilistic_cgi_grammar)\nprint([probabilistic_cgi_fuzzer.fuzz() for i in range(20)]) \n```", "```py\n['5', '%3e', '+4%e6', '%19+', '%da+', '%5c', '%28%5e', '%b5+', '2d4', '455%8c', '5%cb', '%4c+%5c4e5+e+%aa%db%1d', 'a%1c%13', 'e+', '%08%cc', 'b3', '3', '%c0%25', '+', '++c+%54d']\n\n```", "```py\ntrials = 100\ncoverage = {}\n\nfor i in range(trials):\n    cgi_input = probabilistic_cgi_fuzzer.fuzz()\n    with Coverage() as cov:\n        cgi_decode(cgi_input)\n    coverage[cgi_input] = cov.coverage() \n```", "```py\ncoverage_slice: List[str] = [cgi_input for cgi_input in coverage\n                             if ('cgi_decode', 25) in coverage[cgi_input]] \n```", "```py\nlen(coverage_slice) / trials \n```", "```py\n0.88\n\n```", "```py\nfor run in range(3):\n    probabilistic_cgi_grammar = probabilistic_grammar_miner.mine_probabilistic_grammar(\n        coverage_slice)\n    probabilistic_cgi_fuzzer = ProbabilisticGrammarFuzzer(\n        probabilistic_cgi_grammar)\n\n    trials = 100\n    coverage = {}\n\n    for i in range(trials):\n        cgi_input = probabilistic_cgi_fuzzer.fuzz()\n        with Coverage() as cov:\n            cgi_decode(cgi_input)\n        coverage[cgi_input] = cov.coverage()\n\n    coverage_slice = [cgi_input for cgi_input in coverage\n                      if ('cgi_decode', 25) in coverage[cgi_input]] \n```", "```py\nlen(coverage_slice) / trials \n```", "```py\n0.83\n\n```", "```py\nsample_size = 1000\nrandom_integer_fuzzer = GrammarFuzzer(\n    PROBABILISTIC_EXPR_GRAMMAR,\n    start_symbol=\"<leaddigit>\")\nrandom_integers = [random_integer_fuzzer.fuzz() for i in range(sample_size)] \n```", "```py\nrandom_counts = [random_integers.count(str(c)) for c in crange('1', '9')]\nrandom_counts \n```", "```py\n[112, 104, 106, 103, 133, 97, 126, 120, 99]\n\n```", "```py\nexpected_prob_counts = [\n    exp_prob(\n        PROBABILISTIC_EXPR_GRAMMAR[\"<leaddigit>\"][i]) *\n    sample_size for i in range(9)]\nprint(expected_prob_counts) \n```", "```py\n[301.0, 176.0, 125.0, 97.0, 79.0, 67.0, 58.0, 51.0, 46.0]\n\n```", "```py\nexpected_random_counts = [sample_size / 9 for i in range(9)]\nprint(expected_random_counts) \n```", "```py\n[111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111, 111.11111111111111]\n\n```", "```py\nfrom [scipy.stats](https://docs.scipy.org/doc/scipy/reference/) import chisquare \n```", "```py\nchisquare(random_counts, expected_prob_counts) \n```", "```py\nPower_divergenceResult(statistic=np.float64(435.87462280458345), pvalue=np.float64(3.925216460200427e-89))\n\n```", "```py\nchisquare(random_counts, expected_random_counts) \n```", "```py\nPower_divergenceResult(statistic=np.float64(11.42), pvalue=np.float64(0.17901776899017763))\n\n```", "```py\nfrom [bookutils](https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils) import inheritance_conflicts \n```", "```py\ninheritance_conflicts(GrammarCoverageFuzzer, ProbabilisticGrammarFuzzer) \n```", "```py\n['choose_node_expansion']\n\n```", "```py\n@incollection{fuzzingbook2024:ProbabilisticGrammarFuzzer,\n    author = {Andreas Zeller and Rahul Gopinath and Marcel B{\\\"o}hme and Gordon Fraser and Christian Holler},\n    booktitle = {The Fuzzing Book},\n    title = {Probabilistic Grammar Fuzzing},\n    year = {2024},\n    publisher = {CISPA Helmholtz Center for Information Security},\n    howpublished = {\\url{https://www.fuzzingbook.org/html/ProbabilisticGrammarFuzzer.html}},\n    note = {Retrieved 2024-11-09 17:07:29+01:00},\n    url = {https://www.fuzzingbook.org/html/ProbabilisticGrammarFuzzer.html},\n    urldate = {2024-11-09 17:07:29+01:00}\n}\n\n```"]