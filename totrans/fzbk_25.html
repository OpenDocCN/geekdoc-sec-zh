<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Tracking Information Flow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Tracking Information Flow</h1>
<blockquote>原文：<a href="http://www.fuzzingbook.org/html/InformationFlow.html">http://www.fuzzingbook.org/html/InformationFlow.html</a></blockquote>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We have explored how one could generate better inputs that can penetrate deeper into the program in question. While doing so, we have relied on program crashes to tell us that we have succeeded in finding problems in the program. However, that is rather simplistic. What if the behavior of the program is simply incorrect, but does not lead to a crash? Can one do better?</p>
<p>In this chapter, we explore in depth how to track information flows in Python, and how these flows can be used to determine whether a program behaved as expected.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">'WZi0dTvJ2Ug'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

        

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Prerequisites</strong></p>
<ul>
<li>You should have read the <a href="Coverage.html">chapter on coverage</a>.</li>
<li>You should have read the <a href="ProbabilisticGrammarFuzzer.html">chapter on probabilistic fuzzing</a>.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We first set up our infrastructure so that we can make use of previously defined functions.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils.setup</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/typing.html" class="import" target="_blank">typing</a></span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><div class="synopsis"><h2 id="Synopsis">Synopsis</h2><!-- Automatically generated. Do not edit. -->

<p>To <a href="Importing.html">use the code provided in this chapter</a>, write</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="InformationFlow.html" class="import" target="_blank">fuzzingbook.InformationFlow</a></span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
<p>and then make use of the following features.</p>
<p>This chapter provides two wrappers to Python <em>strings</em> that allow one to track various properties. These include information on the security properties of the input, and information on originating indexes of the input string.</p>
<h3 id="Tracking-String-Taints">Tracking String Taints</h3><p><code>tstr</code> objects are replacements for Python strings that allows tracking and checking <em>taints</em> – that is, information on from where a string originated. For instance, one can mark strings that originate from third party input with a taint of "LOW", meaning that they have a low security level. The taint is passed in the constructor of a <code>tstr</code> object:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">thello</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'LOW'</span><span class="p">)</span>
</pre></div>
<p>A <code>tstr</code> object is fully compatible with original Python strings. For instance, we can index it and access substrings:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">thello</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
<span class="s1">'hell'</span>
</pre></div>
<p>However, the <code>tstr</code> object also stores the taint, which can be accessed using the <code>taint</code> attribute:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
<span class="s1">'LOW'</span>
</pre></div>
<p>The neat thing about taints is that they propagate to all strings derived from the original tainted string.
Indeed, any operation from a  <code>tstr</code> string that results in a string fragment produces another <code>tstr</code> object that includes the original taint. For example:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">thello</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
<span class="s1">'LOW'</span>
</pre></div>
<p><code>tstr</code> objects duplicate most <code>str</code> methods, as indicated in the class diagram:</p>
<p>

<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="270pt" height="562pt" viewbox="0.00 0.00 269.62 562.25" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 558.25)">
<g id="a_graph0"><a xlink:title="tstr class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-558.25 265.62,-558.25 265.62,4 -4,4"/>
</a>
</g>
<!-- tstr -->
<g id="node1" class="node">
<title>tstr</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class tstr:&#10;Wrapper for strings, saving taint information">
<polygon fill="none" stroke="black" points="0,-0.5 0,-480.75 124,-480.75 124,-0.5 0,-0.5"/>
<text text-anchor="start" x="51.12" y="-464.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">tstr</text>
<polyline fill="none" stroke="black" points="0,-454.75 124,-454.75"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="tstr">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__add__(self, *args, **kwargs):&#10;Return self+value.">
<text text-anchor="start" x="8" y="-442.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__add__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="__format__(self, *args, **kwargs):&#10;Return a formatted version of the string as described by format_spec.">
<text text-anchor="start" x="8" y="-429.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__format__()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="__getitem__(self, *args, **kwargs):&#10;Return self[key].">
<text text-anchor="start" x="8" y="-416.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__getitem__()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="__init__(self, value: Any, taint: Any = None, **kwargs) -&gt; None:&#10;Constructor.&#10;`value` is the string value the `tstr` object is to be constructed from.&#10;`taint` is an (optional) taint to be propagated to derived strings.">
<text text-anchor="start" x="8" y="-404" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="__mod__(self, *args, **kwargs):&#10;Return self%value.">
<text text-anchor="start" x="8" y="-391.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mod__()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="__mul__(self, *args, **kwargs):&#10;Return self*value.">
<text text-anchor="start" x="8" y="-378.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mul__()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="__new__(cls, value, *args, **kw):&#10;Create a tstr() instance. Used internally.">
<text text-anchor="start" x="8" y="-365.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__new__()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="__radd__(self, value):&#10;Return value + self, as a `tstr` object">
<text text-anchor="start" x="8" y="-353" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__radd__()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="__repr__(self) -&gt; tstr:&#10;Return a representation.">
<text text-anchor="start" x="8" y="-340.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="__rmod__(self, *args, **kwargs):&#10;Return value%self.">
<text text-anchor="start" x="8" y="-327.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmod__()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="__rmul__(self, *args, **kwargs):&#10;Return value*self.">
<text text-anchor="start" x="8" y="-314.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmul__()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="__str__(self) -&gt; str:&#10;Convert to string">
<text text-anchor="start" x="8" y="-302" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__str__()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="capitalize(self, *args, **kwargs):&#10;Return a capitalized version of the string.&#10;&#10;More specifically, make the first character have upper case and the rest lower&#10;case.">
<text text-anchor="start" x="8" y="-289.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">capitalize()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="casefold(self, *args, **kwargs):&#10;Return a version of the string suitable for caseless comparisons.">
<text text-anchor="start" x="8" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">casefold()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="center(self, *args, **kwargs):&#10;Return a centered string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-263.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">center()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="clear_taint(self):&#10;Remove taint">
<text text-anchor="start" x="8" y="-251" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">clear_taint()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="encode(self, *args, **kwargs):&#10;Encode the string using the codec registered for encoding.&#10;&#10;encoding&#10;The encoding in which to encode the string.&#10;errors&#10;The error handling scheme to use for encoding errors.&#10;The default is 'strict' meaning that encoding errors raise a&#10;UnicodeEncodeError.  Other possible values are 'ignore', 'replace' and&#10;'xmlcharrefreplace' as well as any other name registered with&#10;codecs.register_error that can handle UnicodeEncodeErrors.">
<text text-anchor="start" x="8" y="-238.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">encode()</text>
</a>
</g>
<g id="a_node1_18"><a xlink:href="#" xlink:title="expandtabs(self, *args, **kwargs):&#10;Return a copy where all tab characters are expanded using spaces.&#10;&#10;If tabsize is not given, a tab size of 8 characters is assumed.">
<text text-anchor="start" x="8" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">expandtabs()</text>
</a>
</g>
<g id="a_node1_19"><a xlink:href="#" xlink:title="format(self, *args, **kwargs):&#10;S.format(*args, **kwargs) -&gt; str&#10;&#10;Return a formatted version of S, using substitutions from args and kwargs.&#10;The substitutions are identified by braces ('{' and '}').">
<text text-anchor="start" x="8" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">format()</text>
</a>
</g>
<g id="a_node1_20"><a xlink:href="#" xlink:title="format_map(self, *args, **kwargs):&#10;S.format_map(mapping) -&gt; str&#10;&#10;Return a formatted version of S, using substitutions from mapping.&#10;The substitutions are identified by braces ('{' and '}').">
<text text-anchor="start" x="8" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">format_map()</text>
</a>
</g>
<g id="a_node1_21"><a xlink:href="#" xlink:title="has_taint(self):&#10;Check if taint is present">
<text text-anchor="start" x="8" y="-187.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">has_taint()</text>
</a>
</g>
<g id="a_node1_22"><a xlink:href="#" xlink:title="join(self, *args, **kwargs):&#10;Concatenate any number of strings.&#10;&#10;The string whose method is called is inserted in between each given string.&#10;The result is returned as a new string.&#10;&#10;Example: '.'.join(['ab', 'pq', 'rs']) -&gt; 'ab.pq.rs'">
<text text-anchor="start" x="8" y="-174.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">join()</text>
</a>
</g>
<g id="a_node1_23"><a xlink:href="#" xlink:title="ljust(self, *args, **kwargs):&#10;Return a left-justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-161.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ljust()</text>
</a>
</g>
<g id="a_node1_24"><a xlink:href="#" xlink:title="lower(self, *args, **kwargs):&#10;Return a copy of the string converted to lowercase.">
<text text-anchor="start" x="8" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lower()</text>
</a>
</g>
<g id="a_node1_25"><a xlink:href="#" xlink:title="lstrip(self, *args, **kwargs):&#10;Return a copy of the string with leading whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lstrip()</text>
</a>
</g>
<g id="a_node1_26"><a xlink:href="#" xlink:title="make_str_wrapper(fun):&#10;Make `fun` (a `str` method) a method in `tstr`">
<text text-anchor="start" x="8" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">make_str_wrapper()</text>
</a>
</g>
<g id="a_node1_27"><a xlink:href="#" xlink:title="replace(self, *args, **kwargs):&#10;Return a copy with all occurrences of substring old replaced by new.&#10;&#10;count&#10;Maximum number of occurrences to replace.&#10;-1 (the default value) means replace all occurrences.&#10;&#10;If the optional argument count is given, only the first count occurrences are&#10;replaced.">
<text text-anchor="start" x="8" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">replace()</text>
</a>
</g>
<g id="a_node1_28"><a xlink:href="#" xlink:title="rjust(self, *args, **kwargs):&#10;Return a right-justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-98" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rjust()</text>
</a>
</g>
<g id="a_node1_29"><a xlink:href="#" xlink:title="rstrip(self, *args, **kwargs):&#10;Return a copy of the string with trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-85.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rstrip()</text>
</a>
</g>
<g id="a_node1_30"><a xlink:href="#" xlink:title="strip(self, *args, **kwargs):&#10;Return a copy of the string with leading and trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-72.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">strip()</text>
</a>
</g>
<g id="a_node1_31"><a xlink:href="#" xlink:title="swapcase(self, *args, **kwargs):&#10;Convert uppercase characters to lowercase and lowercase characters to uppercase.">
<text text-anchor="start" x="8" y="-59.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">swapcase()</text>
</a>
</g>
<g id="a_node1_32"><a xlink:href="#" xlink:title="title(self, *args, **kwargs):&#10;Return a version of the string where each word is titlecased.&#10;&#10;More specifically, words start with uppercased characters and all remaining&#10;cased characters have lower case.">
<text text-anchor="start" x="8" y="-47" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">title()</text>
</a>
</g>
<g id="a_node1_33"><a xlink:href="#" xlink:title="translate(self, *args, **kwargs):&#10;Replace each character in the string using the given translation table.&#10;&#10;table&#10;Translation table, which must be a mapping of Unicode ordinals to&#10;Unicode ordinals, strings, or None.&#10;&#10;The table must implement lookup/indexing via __getitem__, for instance a&#10;dictionary or list.  If this operation raises LookupError, the character is&#10;left untouched.  Characters mapped to None are deleted.">
<text text-anchor="start" x="8" y="-34.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">translate()</text>
</a>
</g>
<g id="a_node1_34"><a xlink:href="#" xlink:title="upper(self, *args, **kwargs):&#10;Return a copy of the string converted to uppercase.">
<text text-anchor="start" x="8" y="-21.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">upper()</text>
</a>
</g>
<g id="a_node1_35"><a xlink:href="#" xlink:title="create(self, s)">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- str -->
<g id="node2" class="node">
<title>str</title>
<g id="a_node2"><a xlink:href="builtins.html" xlink:title="class str:&#10;str(object='') -&gt; str&#10;str(bytes_or_buffer[, encoding[, errors]]) -&gt; str&#10;&#10;Create a new string object from the given object. If encoding or&#10;errors is specified, then the object must expose a data buffer&#10;that will be decoded using the given encoding and error handler.&#10;Otherwise, returns the result of object.__str__() (if defined)&#10;or repr(object).&#10;encoding defaults to sys.getdefaultencoding().&#10;errors defaults to 'strict'.">
<polygon fill="none" stroke="black" points="35,-517.75 35,-553.75 89,-553.75 89,-517.75 35,-517.75"/>
<text text-anchor="start" x="53.5" y="-532.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">str</text>
</a>
</g>
</g>
<!-- tstr&#45;&gt;str -->
<g id="edge1" class="edge">
<title>tstr-&gt;str</title>
<path fill="none" stroke="black" d="M62,-480.99C62,-490.28 62,-498.72 62,-506.02"/>
<polygon fill="none" stroke="black" points="58.5,-506.01 62,-516.01 65.5,-506.01 58.5,-506.01"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="142.38" y="-256.62" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="142.38" y="-246.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-246.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="142.38" y="-236.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-236.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="142.38" y="-226.62" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="148.38" y="-226.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="142.38" y="-217.57" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</p>
<h3 id="Tracking-Character-Origins">Tracking Character Origins</h3><p><code>ostr</code> objects extend <code>tstr</code> objects by not only tracking a taint, but also the originating <em>indexes</em> from the input string, This allows you to exactly track where individual characters came from. Assume you have a long string, which at index 100 contains the password <code>"joshua1234"</code>. Then you can save this origin information using an <code>ostr</code> as follows:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"joshua1234"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'SECRET'</span><span class="p">)</span>
</pre></div>
<p>The <code>origin</code> attribute of an <code>ostr</code> provides access to a list of indexes:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">secret</span><span class="o">.</span><span class="n">origin</span>
<span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">secret</span><span class="o">.</span><span class="n">taint</span>
<span class="s1">'SECRET'</span>
</pre></div>
<p><code>ostr</code> objects are compatible with Python strings, except that string operations return <code>ostr</code> objects (together with the saved origin an index information). An index of <code>-1</code> indicates that the corresponding character has no origin as supplied to the <code>ostr()</code> constructor:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">secret_substr</span> <span class="o">=</span> <span class="p">(</span><span class="n">secret</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">secret</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">secret_substr</span><span class="o">.</span><span class="n">taint</span>
<span class="s1">'SECRET'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">secret_substr</span><span class="o">.</span><span class="n">origin</span>
<span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">109</span><span class="p">]</span>
</pre></div>
<p><code>ostr</code> objects duplicate most <code>str</code> methods, as indicated in the class diagram:</p>
<p>

<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="252pt" height="596pt" viewbox="0.00 0.00 251.62 595.75" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 591.75)">
<g id="a_graph0"><a xlink:title="ostr class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-591.75 247.62,-591.75 247.62,4 -4,4"/>
</a>
</g>
<!-- ostr -->
<g id="node1" class="node">
<title>ostr</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class ostr:&#10;Wrapper for strings, saving taint and origin information">
<polygon fill="none" stroke="black" points="0,-0.5 0,-514.25 106,-514.25 106,-0.5 0,-0.5"/>
<text text-anchor="start" x="41" y="-497.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ostr</text>
<polyline fill="none" stroke="black" points="0,-488.25 106,-488.25"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="ostr">
<g id="a_node1_1"><a xlink:href="#" xlink:title="DEFAULT_ORIGIN = 0">
<text text-anchor="start" x="11" y="-474.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">DEFAULT_ORIGIN</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="UNKNOWN_ORIGIN = -1">
<text text-anchor="start" x="11" y="-462" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">UNKNOWN_ORIGIN</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="0,-454.75 106,-454.75"/>
<g id="a_node1_3"><a xlink:href="#" xlink:title="ostr">
<g id="a_node1_4"><a xlink:href="#" xlink:title="__add__(self, other):&#10;Return self+value.">
<text text-anchor="start" x="8" y="-442.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__add__()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="__getitem__(self, key):&#10;Return self[key].">
<text text-anchor="start" x="8" y="-429.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__getitem__()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="__init__(self, value: Any, taint: Any = None, origin: Union[int, List[int], NoneType] = None, **kwargs) -&gt; None:&#10;Constructor.&#10;`value` is the string value the `ostr` object is to be constructed from.&#10;`taint` is an (optional) taint to be propagated to derived strings.&#10;`origin` (optional) is either&#10;- an integer denoting the index of the first character in `value`, or&#10;- a list of integers denoting the origins of the characters in `value`,">
<text text-anchor="start" x="8" y="-416.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="__iter__(self):&#10;Implement iter(self).">
<text text-anchor="start" x="8" y="-404" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__iter__()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="__mod__(self, s):&#10;Return self%value.">
<text text-anchor="start" x="8" y="-391.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__mod__()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="__new__(cls, value, *args, **kw):&#10;Create an ostr() instance. Used internally.">
<text text-anchor="start" x="8" y="-378.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__new__()</text>
</a>
</g>
<g id="a_node1_10"><a xlink:href="#" xlink:title="__repr__(self):&#10;Return repr(self).">
<text text-anchor="start" x="8" y="-365.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__repr__()</text>
</a>
</g>
<g id="a_node1_11"><a xlink:href="#" xlink:title="__rmod__(self, s):&#10;Return value%self.">
<text text-anchor="start" x="8" y="-353" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__rmod__()</text>
</a>
</g>
<g id="a_node1_12"><a xlink:href="#" xlink:title="__str__(self):&#10;Return str(self).">
<text text-anchor="start" x="8" y="-340.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__str__()</text>
</a>
</g>
<g id="a_node1_13"><a xlink:href="#" xlink:title="capitalize(self):&#10;Return a capitalized version of the string.&#10;&#10;More specifically, make the first character have upper case and the rest lower&#10;case.">
<text text-anchor="start" x="8" y="-327.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">capitalize()</text>
</a>
</g>
<g id="a_node1_14"><a xlink:href="#" xlink:title="expandtabs(self, n=8):&#10;Return a copy where all tab characters are expanded using spaces.&#10;&#10;If tabsize is not given, a tab size of 8 characters is assumed.">
<text text-anchor="start" x="8" y="-314.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">expandtabs()</text>
</a>
</g>
<g id="a_node1_15"><a xlink:href="#" xlink:title="join(self, iterable):&#10;Concatenate any number of strings.&#10;&#10;The string whose method is called is inserted in between each given string.&#10;The result is returned as a new string.&#10;&#10;Example: '.'.join(['ab', 'pq', 'rs']) -&gt; 'ab.pq.rs'">
<text text-anchor="start" x="8" y="-302" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">join()</text>
</a>
</g>
<g id="a_node1_16"><a xlink:href="#" xlink:title="ljust(self, width, fillchar=' '):&#10;Return a left-justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-289.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ljust()</text>
</a>
</g>
<g id="a_node1_17"><a xlink:href="#" xlink:title="lower(self):&#10;Return a copy of the string converted to lowercase.">
<text text-anchor="start" x="8" y="-276.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lower()</text>
</a>
</g>
<g id="a_node1_18"><a xlink:href="#" xlink:title="lstrip(self, cl=None):&#10;Return a copy of the string with leading whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-263.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">lstrip()</text>
</a>
</g>
<g id="a_node1_19"><a xlink:href="#" xlink:title="partition(self, sep):&#10;Partition the string into three parts using the given separator.&#10;&#10;This will search for the separator in the string.  If the separator is found,&#10;returns a 3-tuple containing the part before the separator, the separator&#10;itself, and the part after it.&#10;&#10;If the separator is not found, returns a 3-tuple containing the original string&#10;and two empty strings.">
<text text-anchor="start" x="8" y="-251" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">partition()</text>
</a>
</g>
<g id="a_node1_20"><a xlink:href="#" xlink:title="replace(self, a, b, n=None):&#10;Return a copy with all occurrences of substring old replaced by new.&#10;&#10;count&#10;Maximum number of occurrences to replace.&#10;-1 (the default value) means replace all occurrences.&#10;&#10;If the optional argument count is given, only the first count occurrences are&#10;replaced.">
<text text-anchor="start" x="8" y="-238.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">replace()</text>
</a>
</g>
<g id="a_node1_21"><a xlink:href="#" xlink:title="rjust(self, width, fillchar=' '):&#10;Return a right-justified string of length width.&#10;&#10;Padding is done using the specified fill character (default is a space).">
<text text-anchor="start" x="8" y="-225.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rjust()</text>
</a>
</g>
<g id="a_node1_22"><a xlink:href="#" xlink:title="rpartition(self, sep):&#10;Partition the string into three parts using the given separator.&#10;&#10;This will search for the separator in the string, starting at the end. If&#10;the separator is found, returns a 3-tuple containing the part before the&#10;separator, the separator itself, and the part after it.&#10;&#10;If the separator is not found, returns a 3-tuple containing two empty strings&#10;and the original string.">
<text text-anchor="start" x="8" y="-212.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rpartition()</text>
</a>
</g>
<g id="a_node1_23"><a xlink:href="#" xlink:title="rsplit(self, sep=None, maxsplit=-1):&#10;Return a list of the substrings in the string, using sep as the separator string.&#10;&#10;sep&#10;The separator used to split the string.&#10;&#10;When set to None (the default value), will split on any whitespace&#10;character (including \n \r \t \f and spaces) and will discard&#10;empty strings from the result.&#10;maxsplit&#10;Maximum number of splits.&#10;-1 (the default value) means no limit.&#10;&#10;Splitting starts at the end of the string and works to the front.">
<text text-anchor="start" x="8" y="-200" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rsplit()</text>
</a>
</g>
<g id="a_node1_24"><a xlink:href="#" xlink:title="rstrip(self, cl=None):&#10;Return a copy of the string with trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-187.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">rstrip()</text>
</a>
</g>
<g id="a_node1_25"><a xlink:href="#" xlink:title="split(self, sep=None, maxsplit=-1):&#10;Return a list of the substrings in the string, using sep as the separator string.&#10;&#10;sep&#10;The separator used to split the string.&#10;&#10;When set to None (the default value), will split on any whitespace&#10;character (including \n \r \t \f and spaces) and will discard&#10;empty strings from the result.&#10;maxsplit&#10;Maximum number of splits.&#10;-1 (the default value) means no limit.&#10;&#10;Splitting starts at the front of the string and works to the end.&#10;&#10;Note, str.split() is mainly useful for data that has been intentionally&#10;delimited.  With natural text that includes punctuation, consider using&#10;the regular expression module.">
<text text-anchor="start" x="8" y="-174.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">split()</text>
</a>
</g>
<g id="a_node1_26"><a xlink:href="#" xlink:title="strip(self, cl=None):&#10;Return a copy of the string with leading and trailing whitespace removed.&#10;&#10;If chars is given and not None, remove characters in chars instead.">
<text text-anchor="start" x="8" y="-161.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">strip()</text>
</a>
</g>
<g id="a_node1_27"><a xlink:href="#" xlink:title="swapcase(self):&#10;Convert uppercase characters to lowercase and lowercase characters to uppercase.">
<text text-anchor="start" x="8" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">swapcase()</text>
</a>
</g>
<g id="a_node1_28"><a xlink:href="#" xlink:title="title(self):&#10;Return a version of the string where each word is titlecased.&#10;&#10;More specifically, words start with uppercased characters and all remaining&#10;cased characters have lower case.">
<text text-anchor="start" x="8" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">title()</text>
</a>
</g>
<g id="a_node1_29"><a xlink:href="#" xlink:title="upper(self):&#10;Return a copy of the string converted to uppercase.">
<text text-anchor="start" x="8" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">upper()</text>
</a>
</g>
<g id="a_node1_30"><a xlink:href="#" xlink:title="x(self, i=0):&#10;Extract substring at index/slice `i`">
<text text-anchor="start" x="8" y="-110.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">x()</text>
</a>
</g>
<g id="a_node1_31"><a xlink:href="#" xlink:title="__radd__(self, other)">
<text text-anchor="start" x="8" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">__radd__()</text>
</a>
</g>
<g id="a_node1_32"><a xlink:href="#" xlink:title="_split_helper(self, sep, splitted)">
<text text-anchor="start" x="8" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_split_helper()</text>
</a>
</g>
<g id="a_node1_33"><a xlink:href="#" xlink:title="_split_space(self, splitted)">
<text text-anchor="start" x="8" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">_split_space()</text>
</a>
</g>
<g id="a_node1_34"><a xlink:href="#" xlink:title="clear_origin(self)">
<text text-anchor="start" x="8" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">clear_origin()</text>
</a>
</g>
<g id="a_node1_35"><a xlink:href="#" xlink:title="clear_taint(self)">
<text text-anchor="start" x="8" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">clear_taint()</text>
</a>
</g>
<g id="a_node1_36"><a xlink:href="#" xlink:title="create(self, res, origin=None)">
<text text-anchor="start" x="8" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">create()</text>
</a>
</g>
<g id="a_node1_37"><a xlink:href="#" xlink:title="has_origin(self)">
<text text-anchor="start" x="8" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">has_origin()</text>
</a>
</g>
<g id="a_node1_38"><a xlink:href="#" xlink:title="has_taint(self)">
<text text-anchor="start" x="8" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">has_taint()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- str -->
<g id="node2" class="node">
<title>str</title>
<g id="a_node2"><a xlink:href="builtins.html" xlink:title="class str:&#10;str(object='') -&gt; str&#10;str(bytes_or_buffer[, encoding[, errors]]) -&gt; str&#10;&#10;Create a new string object from the given object. If encoding or&#10;errors is specified, then the object must expose a data buffer&#10;that will be decoded using the given encoding and error handler.&#10;Otherwise, returns the result of object.__str__() (if defined)&#10;or repr(object).&#10;encoding defaults to sys.getdefaultencoding().&#10;errors defaults to 'strict'.">
<polygon fill="none" stroke="black" points="26,-551.25 26,-587.25 80,-587.25 80,-551.25 26,-551.25"/>
<text text-anchor="start" x="44.5" y="-565.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">str</text>
</a>
</g>
</g>
<!-- ostr&#45;&gt;str -->
<g id="edge1" class="edge">
<title>ostr-&gt;str</title>
<path fill="none" stroke="black" d="M53,-514.63C53,-523.94 53,-532.38 53,-539.67"/>
<polygon fill="none" stroke="black" points="49.5,-539.62 53,-549.62 56.5,-539.62 49.5,-539.62"/>
</g>
<!-- Legend -->
<g id="node3" class="node">
<title>Legend</title>
<text text-anchor="start" x="124.38" y="-273.38" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="124.38" y="-263.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-263.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="124.38" y="-253.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-253.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="124.38" y="-243.38" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="130.38" y="-243.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="124.38" y="-234.32" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</p>
</div>
</div>
</div>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="A-Vulnerable-Database">A Vulnerable Database</h2><p>Say we want to implement an <em>in-memory database</em> service in Python. Here is a rather flimsy attempt. We use the following dataset.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INVENTORY</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">1997,van,Ford,E350</span>
<span class="s2">2000,car,Mercury,Cougar</span>
<span class="s2">1999,car,Chevy,Venture</span><span class="se">\</span>
<span class="s2">"""</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">VEHICLES</span> <span class="o">=</span> <span class="n">INVENTORY</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our DB is a Python class that parses its arguments and throws <code>SQLException</code> which is defined below.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">SQLException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The database is simply a Python <code>dict</code> that is exposed only through SQL queries.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Representing-Tables">Representing Tables</h3><p>The database contains tables, which are created by a method call <code>create_table()</code>. Each table data structure is a pair of values. The first one is the meta data containing column names and types. The second value is a list of values in the table.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">defs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">defs</span><span class="p">,</span> <span class="p">[])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The table can be retrieved using the name using the <code>table()</code> method call.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">t_name</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Table (</span><span class="si">%s</span><span class="s1">) was not found'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t_name</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example of how to use both.  We fill a table <code>inventory</code> with four columns: <code>year</code>, <code>kind</code>, <code>company</code>, and <code>model</code>.  Initially, our table is empty.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">sample_db</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
    <span class="n">inventory_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'year'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'kind'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">'company'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
    <span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">,</span> <span class="n">inventory_def</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Using <code>table()</code>, we can retrieve the table definition as well as its contents.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>({'year': int, 'kind': str, 'company': str, 'model': str}, [])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We also define <code>column()</code> for retrieving the column definition from a table declaration.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_decl</span><span class="p">,</span> <span class="n">c_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c_name</span> <span class="ow">in</span> <span class="n">table_decl</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">table_decl</span><span class="p">[</span><span class="n">c_name</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Column (</span><span class="si">%s</span><span class="s1">) was not found'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">c_name</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">decl</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decl</span><span class="p">,</span> <span class="s1">'year'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>int
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Executing-SQL-Statements">Executing SQL Statements</h3><p>The <code>sql()</code> method of <code>DB</code> executes SQL statements.  It inspects its arguments, and dispatches the query based on the kind of SQL statement to be executed.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">do_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'select '</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_select</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">'update '</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_update</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">'insert into '</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_insert</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">'delete from'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_delete</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="n">query</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">):])</span>
        <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Unknown SQL (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's an example of how to use the <code>DB</code> class:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">some_db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
<span class="n">some_db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>However, at this point, the individual methods for handling SQL statements are not yet defined. Let us do this in the next steps.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Implementing-SQL-Statements">
<summary>Implementing SQL Statements</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Selecting-Data">Selecting Data</h4><p>The <code>do_select()</code> method handles SQL <code>select</code> statements to retrieve data from a table.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">FROM</span><span class="p">,</span> <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">' from '</span><span class="p">,</span> <span class="s1">' where '</span>
        <span class="n">table_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">FROM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'no table specified'</span><span class="p">)</span>

        <span class="n">where_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_start</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">where_start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">FROM</span><span class="p">):</span><span class="n">where_start</span><span class="p">]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">where_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">FROM</span><span class="p">):]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
            <span class="n">selected_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">hm</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_rows</span> <span class="o">=</span> <span class="n">table</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">selected_rows</span><span class="p">,</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="n">select</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>expression_clause()</code> method is used for two purposes:</p>
<ol>
<li>In the form <code>select</code> $x$, $y$, $z$ <code>from</code> $t$, it <em>evaluates</em> (and returns) the expressions $x$, $y$, $z$ in the contexts of the selected rows.</li>
<li>If a clause <code>where</code> $p$ is given, it also evaluates $p$ in the context of the rows and includes the rows in the selection only if $p$ holds.</li>
</ol>
<p>To evaluate expressions like $x$, $y$, $z$ or $p$, the method <code>expression_clause()</code> makes use of the Python <code>eval()</code> evaluation function.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expression_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">statement</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
            <span class="n">selected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="p">{},</span> <span class="n">hm</span><span class="p">),</span> <span class="n">hm</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">selected</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If <code>eval()</code> fails for whatever reason, we raise an exception:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid WHERE (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Note:</strong> Using <code>eval()</code> here introduces some important security issues, which we will discuss later in this chapter.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's how we can use <code>sql()</code> to issue a query.  Note that the table is yet empty.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory where year == 2018'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Inserting-Data">Inserting Data</h4><p>The <code>do_insert()</code> method handles SQL <code>insert</code> statements.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">VALUES</span> <span class="o">=</span> <span class="s1">' values '</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'('</span><span class="p">)</span>
        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">names_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">')'</span><span class="p">)</span>
        <span class="n">decls</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="n">table_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">names_end</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)]</span>

        <span class="c1"># verify columns exist</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="n">values_start</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">VALUES</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">values_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid INSERT (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query</span><span class="p">[</span><span class="n">values_start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">VALUES</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span>
                <span class="s1">'names(</span><span class="si">%s</span><span class="s1">) != values(</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span>

        <span class="c1"># dict lookups happen in C code, so we can't use that</span>
        <span class="n">kvs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">kval</span> <span class="ow">in</span> <span class="n">decls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">kvs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">kval</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kvs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In SQL, a column can come in any supported data type.  To ensure it is stored using the type originally declared, we need the ability to convert the values to specific types which is provided by <code>convert()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/ast.html" class="import" target="_blank">ast</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid Conversion </span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">cast</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example of how to use the SQL <code>insert</code> command:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'insert into inventory (year, kind, company, model) values (1997, "van", "Ford", "E350")'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>({'year': int, 'kind': str, 'company': str, 'model': str},
 [{'year': 1997, 'kind': 'van', 'company': 'Ford', 'model': 'E350'}])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With the database filled, we can also run more complex queries:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year + 1, kind from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[(1998, 'van')]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year, kind from inventory where year == 1997'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[(1997, 'van')]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Updating-Data">Updating Data</h4><p>Similarly, <code>do_update()</code> handles SQL <code>update</code> statements.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">SET</span><span class="p">,</span> <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">' set '</span><span class="p">,</span> <span class="s1">' where '</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">SET</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid UPDATE (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

        <span class="n">set_end</span> <span class="o">=</span> <span class="n">table_end</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span>
        <span class="n">decls</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">names_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">names_end</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">set_end</span><span class="p">:</span><span class="n">names_end</span><span class="p">]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">names_end</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">set_end</span><span class="p">:]</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s1">''</span>

        <span class="n">sets</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)]</span>

        <span class="c1"># verify columns exist</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">decls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="p">[</span><span class="n">hm</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">for</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
                <span class="c1"># we can not do dict lookups because it is implemented in C.</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">kval</span> <span class="ow">in</span> <span class="n">decls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">hm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">kval</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">"</span><span class="si">%d</span><span class="s2"> records were updated"</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example.  Let us first fill the database again with values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'insert into inventory (year, kind, company, model) values (1997, "van", "Ford", "E350")'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[1997]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now we can update things:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'update inventory set year = 1998 where year == 1997'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[1998]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>({'year': int, 'kind': str, 'company': str, 'model': str},
 [{'year': 1998, 'kind': 'van', 'company': 'Ford', 'model': 'E350'}])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Deleting-Data">Deleting Data</h4><p>Finally, SQL <code>delete</code> statements are handled by <code>do_delete()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="n">WHERE</span> <span class="o">=</span> <span class="s1">' where '</span>
        <span class="n">table_end</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">WHERE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid DELETE (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>

        <span class="n">t_name</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="n">table_end</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">t_name</span><span class="p">)</span>
        <span class="n">where</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">table_end</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">WHERE</span><span class="p">):]</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression_clause</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">where</span><span class="p">)</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">hm</span> <span class="ow">in</span> <span class="n">selected</span> <span class="k">if</span> <span class="n">d</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deleted</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="s2">"</span><span class="si">%d</span><span class="s2"> records were deleted"</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">deleted</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is an example.  Let us first fill the database again with values:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">sample_db</span><span class="p">()</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'insert into inventory (year, kind, company, model) values (1997, "van", "Ford", "E350")'</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[1997]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now we can delete data:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'delete from inventory where company == "Ford"'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'1 records were deleted'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our database is now empty:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[]
</pre>
</div>

</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is how our database can be used.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We first create a table in our database with the correct data types.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">inventory_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'year'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">'kind'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">'company'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">'model'</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
<span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s1">'inventory'</span><span class="p">,</span> <span class="n">inventory_def</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is a simple convenience function to update the table using our dataset.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">update_inventory</span><span class="p">(</span><span class="n">sqldb</span><span class="p">,</span> <span class="n">vehicle</span><span class="p">):</span>
    <span class="n">inventory_def</span> <span class="o">=</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s1">'inventory'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">inventory_def</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">cast</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vehicle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">))]</span>
    <span class="n">sqldb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'insert into inventory (</span><span class="si">%s</span><span class="s1">) values (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="p">(</span><span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                                                          <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">V</span> <span class="ow">in</span> <span class="n">VEHICLES</span><span class="p">:</span>
    <span class="n">update_inventory</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our database now contains the same dataset as <code>VEHICLES</code> under <code>INVENTORY</code> table.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{'inventory': ({'year': int, 'kind': str, 'company': str, 'model': str},
  [{'year': 1997, 'kind': 'van', 'company': 'Ford', 'model': 'E350'},
   {'year': 2000, 'kind': 'car', 'company': 'Mercury', 'model': 'Cougar'},
   {'year': 1999, 'kind': 'car', 'company': 'Chevy', 'model': 'Venture'}])}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is a sample select statement.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year,kind from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[(1997, 'van'), (2000, 'car'), (1999, 'car')]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"select company,model from inventory where kind == 'car'"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[('Mercury', 'Cougar'), ('Chevy', 'Venture')]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can run updates on it.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"update inventory set year = 1998, company = 'Suzuki' where kind == 'van'"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'1 records were updated'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{'inventory': ({'year': int, 'kind': str, 'company': str, 'model': str},
  [{'year': 1998, 'kind': 'van', 'company': 'Suzuki', 'model': 'E350'},
   {'year': 2000, 'kind': 'car', 'company': 'Mercury', 'model': 'Cougar'},
   {'year': 1999, 'kind': 'car', 'company': 'Chevy', 'model': 'Venture'}])}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>It can even do mathematics on the fly!</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select int(year)+10 from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[2008, 2010, 2009]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Adding a new row to our table.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"insert into inventory (year, kind, company, model) values (1, 'charriot', 'Rome', 'Quadriga')"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{'inventory': ({'year': int, 'kind': str, 'company': str, 'model': str},
  [{'year': 1998, 'kind': 'van', 'company': 'Suzuki', 'model': 'E350'},
   {'year': 2000, 'kind': 'car', 'company': 'Mercury', 'model': 'Cougar'},
   {'year': 1999, 'kind': 'car', 'company': 'Chevy', 'model': 'Venture'},
   {'year': 1, 'kind': 'charriot', 'company': 'Rome', 'model': 'Quadriga'}])}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Which we then delete.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"delete from inventory where year &lt; 1900"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'1 records were deleted'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Fuzzing-SQL">Fuzzing SQL</h3><p>To verify that everything is OK, let us fuzz. First we define our grammar.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Defining-a-SQL-grammar">
<summary>Defining a SQL grammar</summary>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/string.html" class="import" target="_blank">string</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Grammars.html" class="import" target="_blank">Grammars</a></span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">Grammar</span><span class="p">,</span> <span class="n">Expansion</span><span class="p">,</span> \
    <span class="n">is_valid_grammar</span><span class="p">,</span> <span class="n">extend_grammar</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">EXPR_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"&lt;start&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;expr&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;expr&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;bexpr&gt;"</span><span class="p">,</span> <span class="s2">"&lt;aexpr&gt;"</span><span class="p">,</span> <span class="s2">"(&lt;expr&gt;)"</span><span class="p">,</span> <span class="s2">"&lt;term&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;bexpr&gt;"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"&lt;aexpr&gt;&lt;lt&gt;&lt;aexpr&gt;"</span><span class="p">,</span>
        <span class="s2">"&lt;aexpr&gt;&lt;gt&gt;&lt;aexpr&gt;"</span><span class="p">,</span>
        <span class="s2">"&lt;expr&gt;==&lt;expr&gt;"</span><span class="p">,</span>
        <span class="s2">"&lt;expr&gt;!=&lt;expr&gt;"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">"&lt;aexpr&gt;"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"&lt;aexpr&gt;+&lt;aexpr&gt;"</span><span class="p">,</span> <span class="s2">"&lt;aexpr&gt;-&lt;aexpr&gt;"</span><span class="p">,</span> <span class="s2">"&lt;aexpr&gt;*&lt;aexpr&gt;"</span><span class="p">,</span>
        <span class="s2">"&lt;aexpr&gt;/&lt;aexpr&gt;"</span><span class="p">,</span> <span class="s2">"&lt;word&gt;(&lt;exprs&gt;)"</span><span class="p">,</span> <span class="s2">"&lt;expr&gt;"</span>
    <span class="p">],</span>
    <span class="s2">"&lt;exprs&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;expr&gt;,&lt;exprs&gt;"</span><span class="p">,</span> <span class="s2">"&lt;expr&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;lt&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;"</span><span class="p">],</span>
    <span class="s2">"&lt;gt&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;term&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;number&gt;"</span><span class="p">,</span> <span class="s2">"&lt;word&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;number&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;integer&gt;.&lt;integer&gt;"</span><span class="p">,</span> <span class="s2">"&lt;integer&gt;"</span><span class="p">,</span> <span class="s2">"-&lt;number&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;integer&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;digit&gt;&lt;integer&gt;"</span><span class="p">,</span> <span class="s2">"&lt;digit&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;word&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;word&gt;&lt;letter&gt;"</span><span class="p">,</span> <span class="s2">"&lt;word&gt;&lt;digit&gt;"</span><span class="p">,</span> <span class="s2">"&lt;letter&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;digit&gt;"</span><span class="p">:</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">),</span>
    <span class="s2">"&lt;letter&gt;"</span><span class="p">:</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="s1">'_:.'</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">PRINTABLE_CHARS</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> 
                                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s2">"&lt;&gt;'</span><span class="se">\"\t\n\r\x0b\x0c\x00</span><span class="s2">"</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'&lt;lt&gt;'</span><span class="p">,</span> <span class="s1">'&lt;gt&gt;'</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INVENTORY_GRAMMAR</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">EXPR_GRAMMAR</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s1">'&lt;start&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;query&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;query&gt;'</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'select &lt;exprs&gt; from &lt;table&gt;'</span><span class="p">,</span>
            <span class="s1">'select &lt;exprs&gt; from &lt;table&gt; where &lt;bexpr&gt;'</span><span class="p">,</span>
            <span class="s1">'insert into &lt;table&gt; (&lt;names&gt;) values (&lt;literals&gt;)'</span><span class="p">,</span>
            <span class="s1">'update &lt;table&gt; set &lt;assignments&gt; where &lt;bexpr&gt;'</span><span class="p">,</span>
            <span class="s1">'delete from &lt;table&gt; where &lt;bexpr&gt;'</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s1">'&lt;table&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;word&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;names&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;column&gt;,&lt;names&gt;'</span><span class="p">,</span> <span class="s1">'&lt;column&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;column&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;word&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;literals&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;literal&gt;'</span><span class="p">,</span> <span class="s1">'&lt;literal&gt;,&lt;literals&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;literal&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;number&gt;'</span><span class="p">,</span> <span class="s2">"'&lt;chars&gt;'"</span><span class="p">],</span>
        <span class="s1">'&lt;assignments&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;kvp&gt;,&lt;assignments&gt;'</span><span class="p">,</span> <span class="s1">'&lt;kvp&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;kvp&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;column&gt;=&lt;value&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;value&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;word&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;chars&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;char&gt;'</span><span class="p">,</span> <span class="s1">'&lt;char&gt;&lt;chars&gt;'</span><span class="p">],</span>
        <span class="s1">'&lt;char&gt;'</span><span class="p">:</span> <span class="n">PRINTABLE_CHARS</span><span class="p">,</span>
    <span class="p">})</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As can be seen from the source of our database, the functions always check whether the table name is correct. Hence, we modify the grammar to choose our particular table so that it will have a better chance of reaching deeper. We will see in the later sections how this can be done automatically.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INVENTORY_GRAMMAR_F</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR</span><span class="p">,</span> 
                                     <span class="p">{</span><span class="s1">'&lt;table&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'inventory'</span><span class="p">]})</span>
</pre></div>

</div>
</div></div>
</div>
</div>

</details>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="GrammarFuzzer.html" class="import" target="_blank">GrammarFuzzer</a></span> <span class="kn">import</span> <span class="n">GrammarFuzzer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">gf</span> <span class="o">=</span> <span class="n">GrammarFuzzer</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR_F</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"&gt; "</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>'select O6fo,-977091.1,-36.46 from inventory'
&gt;  Invalid WHERE ('(O6fo,-977091.1,-36.46)')

'select g3 from inventory where -3.0!=V/g/b+Q*M*G'
&gt;  Invalid WHERE ('(-3.0!=V/g/b+Q*M*G)')

'update inventory set z=a,x=F_,Q=K where p(M)&lt;_*S'
&gt;  Column ('z') was not found

'update inventory set R=L5pk where e*l*y-u&gt;K+U(:)'
&gt;  Column ('R') was not found

'select _/d*Q+H/d(k)&lt;t+M-A+P from inventory'
&gt;  Invalid WHERE ('(_/d*Q+H/d(k)&lt;t+M-A+P)')

'select F5 from inventory'
&gt;  Invalid WHERE ('(F5)')

'update inventory set jWh.=a6 where wcY(M)&gt;IB7(i)'
&gt;  Column ('jWh.') was not found

'update inventory set U=y where L(W&lt;c,(U!=W))&lt;V(((q)==m&lt;F),O,l)'
&gt;  Column ('U') was not found

'delete from inventory where M/b-O*h*E&lt;H-W&gt;e(Y)-P'
&gt;  Invalid WHERE ('M/b-O*h*E&lt;H-W&gt;e(Y)-P')

'select ((kP(86)+b*S+J/Z/U+i(U))) from inventory'
&gt;  Invalid WHERE ('(((kP(86)+b*S+J/Z/U+i(U))))')
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Fuzzing does not seem to have triggered any crashes.  However, are crashes the only errors that we should be worried about?</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="The-Evil-of-Eval">The Evil of Eval</h3><p>In our database implementation – notably in the <code>expression_clause()</code> method -, we have made use of <code>eval()</code> to evaluate expressions using the Python interpreter.  This allows us to unleash the full power of Python expressions within our SQL statements.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year from inventory where year &lt; 2000'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[1998, 1999]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In the above query, the clause <code>year &lt; 2000</code> is evaluated using <code>expression_clause()</code> using Python in the context of each row; hence, <code>year &lt; 2000</code> evaluates to either <code>True</code> or <code>False</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The same holds for the expressions being <code>select</code>ed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select year - 1900 if year &lt; 2000 else year - 2000 from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[98, 0, 99]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This works because <code>year - 1900 if year &lt; 2000 else year - 2000</code> is a valid Python expression.  (It is not a valid SQL expression, though.)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The problem with the above is that there is <em>no limitation</em> to what the Python expression can do.  What if the user tries the following?</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">db</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s1">'select __import__("os").popen("pwd").read() from inventory'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['/Users/zeller/Projects/fuzzingbook/notebooks\n',
 '/Users/zeller/Projects/fuzzingbook/notebooks\n',
 '/Users/zeller/Projects/fuzzingbook/notebooks\n']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The above statement effectively reads from the users' file system.  Instead of <code>os.popen("pwd").read()</code>, it could execute arbitrary Python commands – to access data, install software, run a background process.  This is where "the full power of Python expressions" turns back on us.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>What we want is to allow our <em>program</em> to make full use of its power; yet, the <em>user</em> (or any third party) should not be entrusted to do the same.  Hence, we need to differentiate between (trusted) <em>input from the program</em> and (untrusted) <em>input from the user</em>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>One method that allows such differentiation is that of <em>dynamic taint analysis</em>. The idea is to identify the functions that accept user input as <em>sources</em> that <em>taint</em> any string that comes in through them, and those functions that perform dangerous operations as <em>sinks</em>. Finally, we bless certain functions as <em>taint sanitizers</em>. The idea is that an input from the source should never reach the sink without undergoing sanitization first. This allows us to use a stronger oracle than simply checking for crashes.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracking-String-Taints">Tracking String Taints</h2><p>There are various levels of taint tracking that one can perform. The simplest is to track that a string fragment originated in a specific environment, and has not undergone a taint removal process. For this, we simply need to wrap the original string with an environment identifier (the <em>taint</em>) with <code>tstr</code>, and produce <code>tstr</code> instances on each operation that results in another string fragment.  The attribute <code>taint</code> holds a label identifying the environment this instance was derived.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="A-Class-for-Tainted-Strings">A Class for Tainted Strings</h3><p>For capturing information flows we need a new string class. The idea is to use the new tainted string class <code>tstr</code> as a wrapper on the original <code>str</code> class. However, <code>str</code> is an <em>immutable</em> class. Hence, it does not call its <code>__init__()</code> method after being constructed. This means that any subclasses of <code>str</code> also will not get the <code>__init__()</code> method called. If we want to get our initialization routine called, we need to <a href="https://docs.python.org/3/reference/datamodel.html#basic-customization">hook into <code>__new__()</code></a> and return an instance of our own class.  We combine this with our initialization code in <code>__init__()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Wrapper for strings, saving taint information"""</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create a tstr() instance. Used internally."""</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Constructor.</span>
<span class="sd">        `value` is the string value the `tstr` object is to be constructed from.</span>
<span class="sd">        `taint` is an (optional) taint to be propagated to derived strings."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tstr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Return a representation."""</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Convert to string"""</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For example, if we wrap <code>"hello"</code> in <code>tstr</code>, then we should be able to access its taint:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span><span class="p">:</span> <span class="n">tstr</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'LOW'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">repr</span><span class="p">(</span><span class="n">thello</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, when we wrap a string, it is tainted. Hence, we also need a way to clear the taint in the string. One way is to simply return a <code>str</code> instance as above. However, one may sometimes wish to remove the taint from an existing instance. This is accomplished with <code>clear_taint()</code>. During <code>clear_taint()</code>, we simply set the taint to <code>None</code>. This method comes with a paired method <code>has_taint()</code> which checks whether a <code>tstr</code> instance has a taint.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Remove taint"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Check if taint is present"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="String-Operators">String Operators</h3><p>To propagate the taint, we have to extend string functions, such as operators.  We can do so in one single big step, overloading all string methods and operators.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When we create a new string from an existing tainted string, we propagate its taint.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>make_str_wrapper()</code> function creates a wrapper around an existing string method which attaches the taint to the result of the method:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Make `fun` (a `str` method) a method in `tstr`"""</span>
        <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="s1">'__doc__'</span><span class="p">):</span>
            <span class="c1"># Copy docstring</span>
            <span class="n">proxy</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span>

        <span class="k">return</span> <span class="n">proxy</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We do this for all string methods that return a string:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">informationflow_init_1</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'__format__'</span><span class="p">,</span> <span class="s1">'__mod__'</span><span class="p">,</span> <span class="s1">'__rmod__'</span><span class="p">,</span> <span class="s1">'__getitem__'</span><span class="p">,</span>
                 <span class="s1">'__add__'</span><span class="p">,</span> <span class="s1">'__mul__'</span><span class="p">,</span> <span class="s1">'__rmul__'</span><span class="p">,</span>
                 <span class="s1">'capitalize'</span><span class="p">,</span> <span class="s1">'casefold'</span><span class="p">,</span> <span class="s1">'center'</span><span class="p">,</span> <span class="s1">'encode'</span><span class="p">,</span>
                 <span class="s1">'expandtabs'</span><span class="p">,</span> <span class="s1">'format'</span><span class="p">,</span> <span class="s1">'format_map'</span><span class="p">,</span> <span class="s1">'join'</span><span class="p">,</span>
                 <span class="s1">'ljust'</span><span class="p">,</span> <span class="s1">'lower'</span><span class="p">,</span> <span class="s1">'lstrip'</span><span class="p">,</span> <span class="s1">'replace'</span><span class="p">,</span>
                 <span class="s1">'rjust'</span><span class="p">,</span> <span class="s1">'rstrip'</span><span class="p">,</span> <span class="s1">'strip'</span><span class="p">,</span> <span class="s1">'swapcase'</span><span class="p">,</span> <span class="s1">'title'</span><span class="p">,</span> <span class="s1">'translate'</span><span class="p">,</span> <span class="s1">'upper'</span><span class="p">]:</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">tstr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tstr</span><span class="o">.</span><span class="n">make_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">informationflow_init_1</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INITIALIZER_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="n">informationflow_init_1</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">initialize</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">INITIALIZER_LIST</span><span class="p">:</span>
        <span class="n">fn</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The one missing operator is <code>+</code> with a regular string on the left side and a tainted string on the right side.  Python supports a <code>__radd__()</code> method which is invoked if the associated object is used on the right side of an addition.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">tstr</span><span class="p">(</span><span class="n">tstr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return value + self, as a `tstr` object"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With this, we are already done.  Let us create a string <code>thello</code> with a taint <code>LOW</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'LOW'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now, any substring will also be tainted:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>String additions will return a <code>tstr</code> object with the taint:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'bar'</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our <code>__radd__()</code> method ensures this also works if the <code>tstr</code> occurs on the right side of a string addition:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="s1">'foo'</span> <span class="o">+</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">))</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span> <span class="o">+=</span> <span class="s1">', world'</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Other operators such as multiplication also work:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="n">thello</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="s1">'hw </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">thello</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="s1">'hello </span><span class="si">%s</span><span class="s1">'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span> <span class="o">%</span> <span class="s1">'world'</span><span class="p">)</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracking-Untrusted-Input">Tracking Untrusted Input</h2><p>So, what can one do with tainted strings?  We reconsider the <code>DB</code> example.  We define a "better" <code>TrustedDB</code> which only accepts strings tainted as <code>"TRUSTED"</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TrustedDB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tstr</span><span class="p">),</span> <span class="s2">"Need a tainted string"</span>
        <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'TRUSTED'</span><span class="p">,</span> <span class="s2">"Need a string with trusted taint"</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Feeding a string with an "unknown" (i.e., non-existing) trust level will cause <code>TrustedDB</code> to fail:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">bdb</span> <span class="o">=</span> <span class="n">TrustedDB</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="ExpectError.html" class="import" target="_blank">ExpectError</a></span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"select year from INVENTORY"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3935989889.py", line 2, in &lt;module&gt;
    bdb.sql("select year from INVENTORY")
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py", line 3, in sql
    assert isinstance(s, tstr), "Need a tainted string"
           ^^^^^^^^^^^^^^^^^^^
AssertionError: Need a tainted string (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Additionally, any user input would be originally tagged with <code>"UNTRUSTED"</code> as taint.  If we place an untrusted string into our better calculator, it will also fail:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">bad_user_input</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'__import__("os").popen("ls").read()'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'UNTRUSTED'</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">bad_user_input</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3307042773.py", line 3, in &lt;module&gt;
    bdb.sql(bad_user_input)
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py", line 4, in sql
    assert s.taint == 'TRUSTED', "Need a string with trusted taint"
           ^^^^^^^^^^^^^^^^^^^^
AssertionError: Need a string with trusted taint (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Hence, somewhere along the computation, we have to turn the "untrusted" inputs into "trusted" strings.  This process is called <em>sanitization</em>.  A simple sanitization function for our purposes could ensure that the input consists only of few allowed characters (not including letters or quotes); if this is the case, then the input gets a new <code>"TRUSTED"</code> taint.  If not, we turn the string into an (untrusted) empty string; other alternatives would be to raise an error or to escape or delete "untrusted" characters.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/re.html" class="import" target="_blank">re</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">sanitize</span><span class="p">(</span><span class="n">user_input</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">'^select +[-a-zA-Z0-9_, ()]+ from +[-a-zA-Z0-9_, ()]+$'</span><span class="p">,</span> <span class="n">user_input</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'TRUSTED'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'UNTRUSTED'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">good_user_input</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">"select year,model from inventory"</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'UNTRUSTED'</span><span class="p">)</span>
<span class="n">sanitized_input</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">good_user_input</span><span class="p">)</span>
<span class="n">sanitized_input</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'select year,model from inventory'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">sanitized_input</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'TRUSTED'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sanitized_input</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[(1998, 'E350'), (2000, 'Cougar'), (1999, 'Venture')]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now try out our untrusted input:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">sanitized_input</span> <span class="o">=</span> <span class="n">sanitize</span><span class="p">(</span><span class="n">bad_user_input</span><span class="p">)</span>
<span class="n">sanitized_input</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>''
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">sanitized_input</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'UNTRUSTED'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sanitized_input</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/249000876.py", line 2, in &lt;module&gt;
    bdb.sql(sanitized_input)
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/995123203.py", line 4, in sql
    assert s.taint == 'TRUSTED', "Need a string with trusted taint"
           ^^^^^^^^^^^^^^^^^^^^
AssertionError: Need a string with trusted taint (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Similarly, we can prevent SQL and code injections discussed in <a href="WebFuzzer.html">the chapter on Web fuzzing</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Taint-Aware-Fuzzing">Taint Aware Fuzzing</h2><p>We can also use tainting to <em>direct fuzzing to those grammar rules that are likely to generate dangerous inputs.</em> The idea here is to identify inputs generated by our fuzzer that lead to untrusted execution. First we define the exception to be thrown when a tainted value reaches a dangerous operation.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">Tainted</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">'Tainted[</span><span class="si">%s</span><span class="s1">]'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="TaintedDB">TaintedDB</h3><p>Next, since <code>my_eval()</code> is the most dangerous operation in the <code>DB</code> class, we define a new class <code>TaintedDB</code> that overrides the <code>my_eval()</code> to throw an exception whenever an untrusted string reaches this part.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TaintedDB</span><span class="p">(</span><span class="n">DB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">taint</span> <span class="o">!=</span> <span class="s1">'TRUSTED'</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Tainted</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid SQL (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We initialize an instance of <code>TaintedDB</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tdb</span> <span class="o">=</span> <span class="n">TaintedDB</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tdb</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Then we start fuzzing.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/traceback.html" class="import" target="_blank">traceback</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">tdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">tstr</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'UNTRUSTED'</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="n">Tainted</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"&gt; "</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>'delete from inventory where y/u-l+f/y&lt;Y(c)/A-H*q'
&gt;  Tainted[y/u-l+f/y&lt;Y(c)/A-H*q]

"insert into inventory (G,Wmp,sl3hku3) values ('&lt;','?')"

"insert into inventory (d0) values (',_G')"

'select P*Q-w/x from inventory where X&lt;j==:==j*r-f'
&gt;  Tainted[(X&lt;j==:==j*r-f)]

'select a&gt;F*i from inventory where Q/I-_+P*j&gt;.'
&gt;  Tainted[(Q/I-_+P*j&gt;.)]

'select (V-i&lt;T/g) from inventory where T/r/G&lt;FK(m)/(i)'
&gt;  Tainted[(T/r/G&lt;FK(m)/(i))]

'select (((i))),_(S,_)/L-k&lt;H(Sv,R,n,W,Y) from inventory'
&gt;  Tainted[((((i))),_(S,_)/L-k&lt;H(Sv,R,n,W,Y))]

'select (N==c*U/P/y),i-e/n*y,T!=w,u from inventory'
&gt;  Tainted[((N==c*U/P/y),i-e/n*y,T!=w,u)]

'update inventory set _=B,n=v where o-p*k-J&gt;T'

'select s from inventory where w4g4&lt;.m(_)/_&gt;t'
&gt;  Tainted[(w4g4&lt;.m(_)/_&gt;t)]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>One can see that <code>insert</code>, <code>update</code>, <code>select</code> and <code>delete</code> statements on an existing table lead to taint exceptions. We can now focus on these specific kinds of inputs. However, this is not the only thing we can do. We will see how we can identify specific portions of input that reached tainted execution using character origins in the later sections. But before that, we explore other uses of taints.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Preventing-Privacy-Leaks">Preventing Privacy Leaks</h2><p>Using taints, we can also ensure that secret information does not leak out.  We can assign a special taint <code>"SECRET"</code> to strings whose information must not leak out:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">secrets</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'&lt;Plenty of secret keys&gt;'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'SECRET'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Accessing any substring of <code>secrets</code> will propagate the taint:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">secrets</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'SECRET'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Consider the <em>heartbeat</em> security leak from <a href="Fuzzer.html">the chapter on Fuzzing</a>, in which a server would accidentally reply not only the user input sent to it, but also secret memory.  If the reply consists only of the user input, there is no taint associated with it:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">user_input</span> <span class="o">=</span> <span class="s2">"hello"</span>
<span class="n">reply</span> <span class="o">=</span> <span class="n">user_input</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">isinstance</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>False
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If, however, the reply contains <em>any</em> part of the secret, the reply will be tainted:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">reply</span> <span class="o">=</span> <span class="n">user_input</span> <span class="o">+</span> <span class="n">secrets</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">reply</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hello&lt;Plen'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">reply</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'SECRET'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The output function of our server would now ensure that the data sent back does not contain any secret information:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">send_back</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tstr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'SECRET'</span>
    <span class="o">...</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">send_back</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3747050841.py", line 2, in &lt;module&gt;
    send_back(reply)
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/3158733057.py", line 2, in send_back
    assert not isinstance(s, tstr) and not s.taint == 'SECRET'  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our <code>tstr</code> solution can help to identify information leaks – but it is by no means complete.  If we actually take the <code>heartbeat()</code> implementation from <a href="Fuzzer.html">the chapter on Fuzzing</a>, we will see that <em>any</em> reply is marked as <code>SECRET</code> – even those not even accessing secret memory:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Fuzzer.html" class="import" target="_blank">Fuzzer</a></span> <span class="kn">import</span> <span class="n">heartbeat</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">reply</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secrets</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">reply</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'SECRET'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Why is this?  If we look into the implementation of <code>heartbeat()</code>, we will see that it first builds a long string <code>memory</code> from the (non-secret) reply and the (secret) memory, before returning the first characters from <code>memory</code>.</p>
<div class="highlight"><pre><span/><span class="c1"># Store reply in memory</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">memory</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">reply</span><span class="p">):]</span>
</pre></div>
<p>At this point, the whole memory still is tainted as <code>SECRET</code>, <em>including</em> the non-secret part from <code>reply</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We may be able to circumvent the issue by tagging the <code>reply</code> as <code>PUBLIC</code> – but then, this taint would be in conflict with the <code>SECRET</code> tag of <code>memory</code>.  What happens if we compose a string from two differently tainted strings?</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thilo</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">"High"</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span> <span class="o">+</span> <span class="n">tstr</span><span class="p">(</span><span class="s2">"Low"</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'LOW'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>It turns out that in this case, the <code>__add__()</code> method takes precedence over the <code>__radd__()</code> method, which means that the right-hand <code>"Low"</code> string is treated as a regular (non-tainted) string.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thilo</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HighLow'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thilo</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We could set up the <code>__add__()</code> and other methods with special handling for conflicting taints.  However, the way this conflict should be resolved would be highly <em>application-dependent</em>:</p>
<ul>
<li><p>If we use taints to indicate <em>privacy levels</em>, <code>SECRET</code> privacy should take precedence over <code>PUBLIC</code> privacy.  Any combination of a <code>SECRET</code>-tainted string and a <code>PUBLIC</code>-tainted string thus should have a <code>SECRET</code> taint.</p>
</li>
<li><p>If we use taints to indicate <em>origins</em> of information, an <code>UNTRUSTED</code> origin should take precedence over a <code>TRUSTED</code> origin.  Any combination of an <code>UNTRUSTED</code>-tainted string and a <code>TRUSTED</code>-tainted string thus should have an <code>UNTRUSTED</code> taint.</p>
</li>
</ul>
<p>Of course, such conflict resolutions can be implemented.  But even so, they will not help us in the <code>heartbeat()</code> example differentiating secret from non-secret output data.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Tracking-Individual-Characters">Tracking Individual Characters</h2><p>Fortunately, there is a better, more generic way to solve the above problems.  The key to composition of differently tainted strings is to assign taints not only to strings, but actually to every bit of information – in our case, characters.  If every character has a taint on its own, a new composition of characters will simply inherit this very taint <em>per character</em>.  To this end, we introduce a second bit of information named <em>origin</em>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Distinguishing various untrusted sources may be accomplished by originating each instance as separate instance (called <em>colors</em> in dynamic origin research). You will see an instance of this technique in the chapter on <a href="GrammarMiner.html">Grammar Mining</a>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In this section, we carry <em>character level</em> origins. That is, given a fragment that resulted from a portion of the original originated string, one will be able to tell which portion of the input string the fragment was taken from. In essence, each input character index from an originated source gets its own color.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>More complex originating such as <em>bitmap origins</em> are possible where a single character may result from multiple origined character indexes (such as <em>checksum</em> operations on strings). We do not consider these in this chapter.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="A-Class-for-Tracking-Character-Origins">A Class for Tracking Character Origins</h3><p>Let us introduce a class <code>ostr</code> which, like <code>tstr</code>, carries a taint for each string, and additionally an <em>origin</em> for each character that indicates its source.  It is a consecutive number in a particular range (by default, starting with zero) indicating its <em>position</em> within a specific origin.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Wrapper for strings, saving taint and origin information"""</span>
    <span class="n">DEFAULT_ORIGIN</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Create an ostr() instance. Used internally."""</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">taint</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Constructor.</span>
<span class="sd">        `value` is the string value the `ostr` object is to be constructed from.</span>
<span class="sd">        `taint` is an (optional) taint to be propagated to derived strings.</span>
<span class="sd">        `origin` (optional) is either</span>
<span class="sd">        - an integer denoting the index of the first character in `value`, or</span>
<span class="sd">        - a list of integers denoting the origins of the characters in `value`,</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="n">taint</span>

        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">ostr</span><span class="o">.</span><span class="n">DEFAULT_ORIGIN</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As with <code>tstr</code>, above, we implement methods for conversion into (regular) Python strings:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="n">UNKNOWN_ORIGIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># handle escaped chars</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">):</span>
            <span class="n">origin</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">o</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">origin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, character origins start with <code>0</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">othello</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can also specify the starting origin as below -- <code>6..10</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'world'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">tworld</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"hello</span><span class="se">\t</span><span class="s2">world"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[-1, 0, 1, 2, 3, 4, 5, 5, 6, 7, 8, 9, 10, -1]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>str()</code> returns a <code>str</code> instance without origin or taint information:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">othello</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><code>repr()</code>, however, keeps the origin information for the original string:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">repr</span><span class="p">(</span><span class="n">othello</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>"'hello'"
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">repr</span><span class="p">(</span><span class="n">othello</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[-1, 0, 1, 2, 3, 4, -1]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Just as with taints, we can clear origins and check whether an origin is present:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_taint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">taint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">clear_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">has_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'Hello'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">othello</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span><span class="o">.</span><span class="n">clear_origin</span><span class="p">()</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">othello</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>In the remainder of this section, we re-implement various string methods such that they also keep track of origins.  If this is too tedious for you, jump right <a href="#Checking-Origins">to the next section</a> which gives a number of usage examples.</p>
</div>
</div>
</div>
</div>

<details id="Excursion:-Implementing-String-Methods">
<summary>Implementing String Methods</summary>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Create">Create</h4><p>We need to create new substrings that are wrapped in <code>ostr</code> objects. However, we also want to allow our subclasses to create their own instances. Hence, we again provide a <code>create()</code> method that produces a new <code>ostr</code> instance.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taint</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">othello</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">'world'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">otworld</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[6, 7, 8, 9, 10]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">otworld</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="p">(</span><span class="n">othello</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">otworld</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Index">Index</h4><p>In Python, indexing is provided through <code>__getitem__()</code>. Indexing on positive integers is simple enough. However, it has two additional wrinkles. The first is that, if the index is negative, that many characters are counted from the end of the string which lies just after the last character. That is, the last character has a negative index <code>-1</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">key</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">ohello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ohello</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ohello</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'h'</span><span class="p">,</span> <span class="s1">'o'</span><span class="p">)</span>
<span class="n">ohello</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The other wrinkle is that <code>__getitem__()</code> can accept a slice. We discuss this next.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Slices">Slices</h4><p>The Python <code>slice</code> operator <code>[n:m]</code> relies on the object being an <code>iterator</code>. Hence, we define the <code>__iter__()</code> method, which returns a custom <code>iterator</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ostr_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>__iter__()</code> method requires a supporting <code>iterator</code> object. The <code>iterator</code> is used to save the state of the current iteration, which it does by keeping a reference to the original <code>ostr</code>, and the current index of iteration <code>_str_idx</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr_iterator</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ostr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span> <span class="o">=</span> <span class="n">ostr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="c1"># calls ostr getitem should be ostr</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ostr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_str_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">c</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Bringing all these together:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thw</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span>
<span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hello'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">has_taint</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">has_origin</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'HIGH'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thw</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[0, 1, 2, 3, 4]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Splits">Splits</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">make_split_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'split'</span><span class="p">,</span> <span class="s1">'rsplit'</span><span class="p">,</span> <span class="s1">'splitlines'</span><span class="p">]:</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_split_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'LOW'</span><span class="p">)</span>
<span class="n">othello</span> <span class="o">==</span> <span class="s1">'hello world'</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>True
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">taint</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'LOW'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>(Exercise for the reader: handle <em>partitions</em>, i.e., splitting a string by substrings)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Concatenation">Concatenation</h4><p>If two origined strings are concatenated together, it may be desirable to transfer the origins from each to the corresponding portion of the resulting string. The concatenation of strings is accomplished by overriding <code>__add__()</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ostr</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="p">]))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_raw">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"world"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">othw</span> <span class="o">=</span> <span class="n">othello</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">othw</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>What if a <code>ostr</code> is concatenated with a <code>str</code>?</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">space</span> <span class="o">=</span> <span class="s2">"  "</span>
<span class="n">th_w</span> <span class="o">=</span> <span class="n">othello</span> <span class="o">+</span> <span class="n">space</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">th_w</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
    <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>One wrinkle here is that when adding a <code>ostr</code> and a <code>str</code>, the user may place the <code>str</code> first, in which case, the <code>__add__()</code> method will be called on the <code>str</code> instance. Not on the <code>ostr</code> instance. However, Python provides a solution. If one defines <code>__radd__()</code> on the <code>ostr</code> instance, that method will be called rather than <code>str.__add__()</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">),</span> <span class="p">(</span><span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We test it out:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">shello</span> <span class="o">=</span> <span class="s2">"hello"</span>
<span class="n">otworld</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
<span class="n">thw</span> <span class="o">=</span> <span class="n">shello</span> <span class="o">+</span> <span class="n">otworld</span>
<span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shello</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>These methods: <code>slicing</code> and <code>concatenation</code> is sufficient to implement other string methods that result in a string, and does not change the character underneath (i.e. no case change). Hence, we look at a helper method next.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Extract-Origin-String">Extract Origin String</h4><p>Given a specific input index, the method <code>x()</code> extracts the corresponding originated portion from a <code>ostr</code>. As a convenience it supports <code>slices</code> along with <code>ints</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">TaintException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Extract substring at index/slice `i`"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">origin</span><span class="o">.</span><span class="n">TaintException</span><span class="p">(</span><span class="s1">'Invalid request idx'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">i</span><span class="o">.</span><span class="n">step</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thw</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello world'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">'e'</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">thw</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">105</span><span class="p">))</span> <span class="o">==</span> <span class="p">[</span><span class="s1">'e'</span><span class="p">,</span> <span class="s1">'l'</span><span class="p">,</span> <span class="s1">'l'</span><span class="p">,</span> <span class="s1">'o'</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Replace">Replace</h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>replace()</code> method replaces a portion of the string with another.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">old_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">b_origin</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">mystr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">mystr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">mystr</span> <span class="o">=</span> <span class="n">mystr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">partA</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="n">old_origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">idx</span><span class="p">],</span> <span class="n">old_origin</span><span class="p">[</span><span class="n">last</span><span class="p">:]</span>
            <span class="n">old_origin</span> <span class="o">=</span> <span class="n">partA</span> <span class="o">+</span> <span class="n">b_origin</span> <span class="o">+</span> <span class="n">partB</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">mystr</span><span class="p">,</span> <span class="n">old_origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"aa cde aa"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'aa'</span><span class="p">,</span> <span class="s1">'bb'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'bb'</span><span class="p">,</span> <span class="s1">'cde'</span><span class="p">,</span> <span class="s1">'bb'</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span>
                            <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                            <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"aa cde aa"</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'aa'</span><span class="p">,</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'bb'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">'bb cde bb'</span><span class="p">),</span> <span class="p">[</span>
            <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Split">Split</h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We essentially have to re-implement split operations, and split by space is slightly different from other splits.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_split_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">):</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sep_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">:</span>
            <span class="n">last_idx</span> <span class="o">=</span> <span class="n">first_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">first_idx</span><span class="p">:</span><span class="n">last_idx</span><span class="p">]</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">first_idx</span> <span class="o">=</span> <span class="n">last_idx</span> <span class="o">+</span> <span class="n">sep_len</span>
        <span class="k">return</span> <span class="n">result_list</span>

    <span class="k">def</span> <span class="nf">_split_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitted</span><span class="p">):</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">first_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sep_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">splitted</span><span class="p">:</span>
            <span class="n">last_idx</span> <span class="o">=</span> <span class="n">first_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">first_idx</span><span class="p">:</span><span class="n">last_idx</span><span class="p">]</span>
            <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">last_idx</span><span class="p">:])</span>
            <span class="n">sep_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">' '</span><span class="p">))</span>
            <span class="n">first_idx</span> <span class="o">=</span> <span class="n">last_idx</span> <span class="o">+</span> <span class="n">sep_len</span>
        <span class="k">return</span> <span class="n">result_list</span>

    <span class="k">def</span> <span class="nf">rsplit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">splitted</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">maxsplit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_space</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_helper</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">splitted</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">maxsplit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_space</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_helper</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">splitted</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'ab cdef ghij kl'</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">ghij</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'ab cdef ghij kl'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)))</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">' '</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'ab   cdef ghij    kl'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">ghij</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">105</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">108</span><span class="p">],</span> <span class="p">[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">113</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">118</span><span class="p">,</span> <span class="mi">119</span><span class="p">])</span>

<span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'ab   cdef ghij    kl'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)),</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'HIGH'</span><span class="p">)</span>
<span class="n">ab</span><span class="p">,</span> <span class="n">cdef</span><span class="p">,</span> <span class="n">ghij</span><span class="p">,</span> <span class="n">kl</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">ab</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">cdef</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">kl</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">ab</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'HIGH'</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Strip">Strip</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">rstrip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"  abc  "</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'abc'</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"  abc  "</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'abc  '</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str1</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"  abc  "</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">my_str1</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'  abc'</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Expand-Tabs">Expand Tabs</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">expandtabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">all_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">all_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_parts</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
                <span class="n">all_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">all_parts</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">"ab</span><span class="se">\t</span><span class="s2">cd"</span><span class="p">)</span>
<span class="n">my_ostr</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"ab</span><span class="se">\t</span><span class="s2">cd"</span><span class="p">)</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">my_s</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">my_ostr</span><span class="o">.</span><span class="n">expandtabs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">"'ab  cd'"</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="n">mystr</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="n">myorigin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sep_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
            <span class="n">sorigin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">myorigin</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sorigin</span><span class="p">)</span>
            <span class="n">mystr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">myorigin</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sep_origin</span><span class="p">)</span>
                <span class="n">mystr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">myorigin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"ab cd"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s1">'ef'</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">v4</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v1</span><span class="p">])</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">v4</span><span class="p">,</span> <span class="n">v4</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span>
        <span class="s1">'cdefab'</span><span class="p">,</span> <span class="p">[</span>
            <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">my_str</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"ab cd"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="n">v3</span> <span class="o">=</span> <span class="n">my_str</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="s1">'ef'</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">v2</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">v4</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">','</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v2</span><span class="p">,</span> <span class="n">v3</span><span class="p">,</span> <span class="n">v1</span><span class="p">])</span>
<span class="k">assert</span> <span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v4</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="s1">'cd,ef,ab'</span><span class="p">,</span>
                           <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Partitions">Partitions</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">):</span>
        <span class="n">partA</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]))</span>

    <span class="k">def</span> <span class="nf">rpartition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="p">):</span>
        <span class="n">partA</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">partB</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">):</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">)]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">partB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep</span><span class="p">):]))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Justify">Justify</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">ljust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="o">=</span><span class="s1">' '</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="p">)</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fillchar</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">fillchar</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">initial</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">rjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="o">=</span><span class="s1">' '</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">fillchar</span><span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fillchar</span><span class="p">,</span> <span class="n">tstr</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">fillchar</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">+</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">final</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="mod">mod</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c1"># nothing else implemented for the time being</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">s_origin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__mod__</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">r_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[:]</span>
        <span class="n">r_origin</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_origin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">r_origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="c1"># nothing else implemented for the time being</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">r_origin</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__rmod__</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">s_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[:]</span>
        <span class="n">r_origin</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_origin</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">r_origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello </span><span class="si">%s</span><span class="s1"> world'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">a</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hello %s world'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="p">(</span><span class="n">a</span> <span class="o">%</span> <span class="s1">'good'</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[100, 101, 102, 103, 104, 105, -1, -1, -1, -1, 108, 109, 110, 111, 112, 113]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">b</span> <span class="o">=</span> <span class="s1">'hello </span><span class="si">%s</span><span class="s1"> world'</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'bad'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="p">(</span><span class="n">b</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[-1, -1, -1, -1, -1, -1, 10, 11, 12, -1, -1, -1, -1, -1, -1]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="String-methods-that-do-not-change-origin">String methods that do not change origin</h4></div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ostr</span><span class="p">(</span><span class="n">ostr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">swapcase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">swapcase</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">capitalize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">a</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'aa'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>('AA', [100, 101])
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="General-wrappers">General wrappers</h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>These are not strictly needed for operation, but can be useful for tracing.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">make_basic_str_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/types.html" class="import" target="_blank">types</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">informationflow_init_2</span><span class="p">():</span>
    <span class="n">ostr_members</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="nb">callable</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__qualname__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'ostr'</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">'__class__'</span><span class="p">,</span> <span class="s1">'__new__'</span><span class="p">,</span> <span class="s1">'__str__'</span><span class="p">,</span> <span class="s1">'__init__'</span><span class="p">,</span>
                            <span class="s1">'__repr__'</span><span class="p">,</span> <span class="s1">'__getattribute__'</span><span class="p">])</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">ostr_members</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_basic_str_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">informationflow_init_2</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INITIALIZER_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informationflow_init_2</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Methods-yet-to-be-translated">Methods yet to be translated</h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>These methods generate strings from other strings. However, we do not have the right implementations for any of these. Hence these are marked as dangerous until we can generate the right translations.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">make_str_abort_wrapper</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">proxy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ostr</span><span class="o">.</span><span class="n">TaintException</span><span class="p">(</span>
            <span class="s1">'</span><span class="si">%s</span><span class="s1"> Not implemented in `ostr`'</span> <span class="o">%</span>
            <span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">proxy</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">informationflow_init_3</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">callable</span><span class="p">):</span>
        <span class="c1"># Omitted 'splitlines' as this is needed for formatting output in</span>
        <span class="c1"># IPython/Jupyter</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'__format__'</span><span class="p">,</span> <span class="s1">'format_map'</span><span class="p">,</span> <span class="s1">'format'</span><span class="p">,</span>
                    <span class="s1">'__mul__'</span><span class="p">,</span> <span class="s1">'__rmul__'</span><span class="p">,</span> <span class="s1">'center'</span><span class="p">,</span> <span class="s1">'zfill'</span><span class="p">,</span> <span class="s1">'decode'</span><span class="p">,</span> <span class="s1">'encode'</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">ostr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">make_str_abort_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">informationflow_init_3</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">INITIALIZER_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">informationflow_init_3</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>While generating proxy wrappers for string operations can handle most common cases of transmission of information flow, some operations involving strings can not be overridden. For example, consider the following.</p>
</div>
</div>
</div>
</div>

</details>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Checking-Origins">Checking Origins</h3><p>With all this implemented, we now have full-fledged <code>ostr</code> strings where we can easily check the origin of each and every character.</p>
<p>To check whether a string originates from another string, we can convert the origin to a set and resort to standard set operations:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">s</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'e'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[101]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>True
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">t</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"world"</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>False
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">u</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">t</span> <span class="o">+</span> <span class="s2">"!"</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">u</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[100, 101, 102, 103, 104, 200, 201, 202, 203, 204, -1]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>True
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Privacy-Leaks-Revisited">Privacy Leaks Revisited</h3><p>Let us apply it to see whether we can come up with a satisfactory solution for checking the <code>heartbeat()</code> function against information leakage.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">SECRET_ORIGIN</span> <span class="o">=</span> <span class="mi">1000</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We define a "secret" that must not leak out:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">secret</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'&lt;again, some super-secret input&gt;'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">SECRET_ORIGIN</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Each and every character in <code>secret</code> has an origin starting with <code>SECRET_ORIGIN</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we now invoke <code>heartbeat()</code> with a given string, the origin of the reply should all be <code>UNKNOWN_ORIGIN</code> (from the input), and none of the characters should have a <code>SECRET_ORIGIN</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">hello_s</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span>
<span class="n">hello_s</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hello'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hello_s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[-1, -1, -1, -1, -1]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can verify that the secret did not leak out by formulating appropriate assertions:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hello_s</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">&gt;=</span> <span class="n">SECRET_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>All assertions pass, again confirming that no secret leaked out.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now go and exploit <code>heartbeat()</code> to reveal its secrets.  As <code>heartbeat()</code> is unchanged, it is as vulnerable as it was:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">hello_s</span> <span class="o">=</span> <span class="n">heartbeat</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">secret</span><span class="p">)</span>
<span class="n">hello_s</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hellon, some super-secret input&gt;'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now, however, the reply <em>does</em> contain secret information:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hello_s</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[-1, -1, -1, -1, -1, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031]
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="p">[</span><span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hello_s</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/2698516187.py", line 2, in &lt;module&gt;
    assert hello_s.origin == [ostr.UNKNOWN_ORIGIN] * len(hello_s)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">origin</span> <span class="o">==</span> <span class="n">ostr</span><span class="o">.</span><span class="n">UNKNOWN_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/1358366226.py", line 2, in &lt;module&gt;
    assert all(origin == ostr.UNKNOWN_ORIGIN for origin in hello_s.origin)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">origin</span> <span class="o">&gt;=</span> <span class="n">SECRET_ORIGIN</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">hello_s</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/1577803914.py", line 2, in &lt;module&gt;
    assert not any(origin &gt;= SECRET_ORIGIN for origin in hello_s.origin)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AssertionError (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can now integrate these assertions into the <code>heartbeat()</code> function, causing it to fail before leaking information.  Additionally (or alternatively?), we can also rewrite our output functions not to give out any secret information.  We will leave these two exercises for the reader.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Taint-Directed-Fuzzing">Taint-Directed Fuzzing</h2><p>The previous <em>Taint Aware Fuzzing</em> was a bit unsatisfactory in that we could not focus on the specific parts of the grammar that led to dangerous operations. We fix that with <em>taint directed fuzzing</em> using <code>TrackingDB</code>.</p>
<p>The idea here is to track the origins of each character that reaches <code>eval</code>. Then, track it back to the grammar nodes that generated it, and increase the probability of using those nodes again.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="TrackingDB">TrackingDB</h3><p>The <code>TrackingDB</code> is similar to <code>TaintedDB</code>. The difference is that, if we find that the execution has reached the <code>my_eval</code>, we simply raise the <code>Tainted</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TrackingDB</span><span class="p">(</span><span class="n">TaintedDB</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">my_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">statement</span><span class="o">.</span><span class="n">origin</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Tainted</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SQLException</span><span class="p">(</span><span class="s1">'Invalid SQL (</span><span class="si">%s</span><span class="s1">)'</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">statement</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Next, we need a specially crafted fuzzer that preserves the taints.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="TaintedGrammarFuzzer">TaintedGrammarFuzzer</h3><p>We define a <code>TaintedGrammarFuzzer</code> class that ensures that the taints propagate to the derivation tree. This is similar to the <code>GrammarFuzzer</code> from the <a href="GrammarFuzzer.html">chapter on grammar fuzzers</a> except that the origins and taints are preserved.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/random.html" class="import" target="_blank">random</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="GrammarFuzzer.html" class="import" target="_blank">GrammarFuzzer</a></span> <span class="kn">import</span> <span class="n">GrammarFuzzer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Parser.html" class="import" target="_blank">Parser</a></span> <span class="kn">import</span> <span class="n">canonical</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">GrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="p">,</span>
                 <span class="n">start_symbol</span><span class="o">=</span><span class="n">START_SYMBOL</span><span class="p">,</span>
                 <span class="n">expansion_switch</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tainted_start_symbol</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span>
            <span class="n">start_symbol</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_symbol</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_switch</span> <span class="o">=</span> <span class="n">expansion_switch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span> <span class="o">=</span> <span class="n">canonical</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_tainted_grammar</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">expansion_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expansion</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expansion</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">s</span> <span class="ow">in</span> <span class="n">seen</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'inf'</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol_cost</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">fuzz_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tainted_start_symbol</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">nt_leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">tree</span><span class="p">]</span>
        <span class="n">expansion_trials</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">nt_leaves</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nt_leaves</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">nt_leaves</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">expansions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">expansion_trials</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_switch</span><span class="p">:</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">expansions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_cost</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">expansions</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>
                <span class="n">all_min</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="n">m</span><span class="p">]</span>
                <span class="n">expansion</span> <span class="o">=</span> <span class="n">expansions</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">all_min</span><span class="p">)]</span>

            <span class="n">new_leaves</span> <span class="o">=</span> <span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">expansion</span><span class="p">]</span>
            <span class="n">new_nt_leaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_leaves</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">]</span>
            <span class="n">children</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_leaves</span>
            <span class="n">nt_leaves</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_nt_leaves</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%-40s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">" -&gt; "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">expansion</span><span class="p">)))</span>
            <span class="n">expansion_trials</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">fuzz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">derivation_tree</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We use a specially prepared tainted grammar for fuzzing. We mark each individual definition, each individual rule, and each individual token with a separate origin (we chose a token boundary of 10 here, after inspecting the grammar). This allows us to track exactly which parts of the grammar were involved in the operations we are interested in.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">init_tainted_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key_increment</span><span class="p">,</span> <span class="n">alt_increment</span><span class="p">,</span> <span class="n">token_increment</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span>
        <span class="n">key_origin</span> <span class="o">=</span> <span class="n">key_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">key_increment</span>
            <span class="n">os</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">alt_increment</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">nt</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">key_origin</span><span class="p">)</span>
                    <span class="n">key_origin</span> <span class="o">+=</span> <span class="n">token_increment</span>
                    <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span>

        <span class="c1"># a use tracking grammar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">use</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As before, we initialize the <code>TrackingDB</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">trdb</span> <span class="o">=</span> <span class="n">TrackingDB</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Finally, we need to ensure that the taints are preserved, when the tree is converted back to a string. For this, we define the <code>tainted_tree_to_string()</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">tree_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="n">symbol</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span> <span class="k">if</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_grammar</span> <span class="k">else</span> <span class="n">symbol</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We define <code>update_grammar()</code> that accepts a set of origins that reached the dangerous operations and the derivation tree of the original string used for fuzzing to update the enhanced grammar.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">TaintedGrammarFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dtree</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">update_tree</span><span class="p">(</span><span class="n">dtree</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">dtree</span>
            <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">updated_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">update_tree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
                <span class="n">corigin</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="n">updated_children</span><span class="p">])</span>
                <span class="n">corigin</span> <span class="o">=</span> <span class="n">corigin</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">origin</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">corigin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">my_origin</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[],</span> <span class="n">my_origin</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">oset</span> <span class="o">=</span> <span class="n">update_tree</span><span class="p">(</span><span class="n">dtree</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">alts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctp_grammar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">alt</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">:</span>
                <span class="n">alt_origins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">alt</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">origin</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">alt_origins</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">oset</span><span class="p">):</span>
                    <span class="n">o</span><span class="p">[</span><span class="s1">'use'</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With these, we are now ready to fuzz.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">tree_type</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">tree_type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tgf</span> <span class="o">=</span> <span class="n">TaintedGrammarFuzzer</span><span class="p">(</span><span class="n">INVENTORY_GRAMMAR_F</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">qtree</span> <span class="o">=</span> <span class="n">tgf</span><span class="o">.</span><span class="n">fuzz_tree</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">tgf</span><span class="o">.</span><span class="n">tree_to_string</span><span class="p">(</span><span class="n">qtree</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">ostr</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">trdb</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">SQLException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Tainted</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
        <span class="n">tgf</span><span class="o">.</span><span class="n">update_grammar</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">qtree</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>'select (g!=(9)!=((:)==2==9)!=J)==-7 from inventory'
Tainted[((g!=(9)!=((:)==2==9)!=J)==-7)]

'delete from inventory where ((c)==T)!=5==(8!=Y)!=-5'
Tainted[((c)==T)!=5==(8!=Y)!=-5]

'select (((w==(((X!=------8)))))) from inventory'
Tainted[((((w==(((X!=------8)))))))]

'delete from inventory where ((.==(-3)!=(((-3))))!=(S==(((n))==Y))!=--2!=N==-----0==--0)!=(((((R))))==((v)))!=((((((------2==Q==-8!=(q)!=(((.!=2))==J)!=(1)!=(((-4!=--5==J!=(((A==.)))))!=(((((0==(P!=((R))!=(((j)))!=7))))==O==K))==(q))==--1==((H)==(t)==s!=-6==((y))==R)!=((H))!=W==--4==(P==(u)==-0)!=O==((-5==-------2!=4!=U))!=-1==((((((R!=-6))))))!=1!=Z)))==(((I)!=((S))!=(-4==s)==(7!=(A))==(s)==p==((_)!=(C))==((w)))))))'
Tainted[((.==(-3)!=(((-3))))!=(S==(((n))==Y))!=--2!=N==-----0==--0)!=(((((R))))==((v)))!=((((((------2==Q==-8!=(q)!=(((.!=2))==J)!=(1)!=(((-4!=--5==J!=(((A==.)))))!=(((((0==(P!=((R))!=(((j)))!=7))))==O==K))==(q))==--1==((H)==(t)==s!=-6==((y))==R)!=((H))!=W==--4==(P==(u)==-0)!=O==((-5==-------2!=4!=U))!=-1==((((((R!=-6))))))!=1!=Z)))==(((I)!=((S))!=(-4==s)==(7!=(A))==(s)==p==((_)!=(C))==((w)))))))]

'delete from inventory where ((2)==T!=-1)==N==(P)==((((((6==a)))))!=8)==(3)!=((---7))'
Tainted[((2)==T!=-1)==N==(P)==((((((6==a)))))!=8)==(3)!=((---7))]

'delete from inventory where o!=2==---5==3!=t'
Tainted[o!=2==---5==3!=t]

'select (2) from inventory'
Tainted[((2))]

'select _ from inventory'
Tainted[(_)]

'select L!=(((1!=(Z)==C)!=C))==(((-0==-5==Q!=((--2!=(-0)==((0))==M)==(A))!=(X)!=e==(K==((b)))!=b==9==((((l)!=-7!=4)!=s==G))!=6==((((5==(((v==(((((((a!=d))==0!=4!=(4)==--1==(h)==-8!=(9)==-4)))))!=I!=-4))==v!=(Y==b)))==(a))!=((7)))))))==((4)) from inventory'
Tainted[(L!=(((1!=(Z)==C)!=C))==(((-0==-5==Q!=((--2!=(-0)==((0))==M)==(A))!=(X)!=e==(K==((b)))!=b==9==((((l)!=-7!=4)!=s==G))!=6==((((5==(((v==(((((((a!=d))==0!=4!=(4)==--1==(h)==-8!=(9)==-4)))))!=I!=-4))==v!=(Y==b)))==(a))!=((7)))))))==((4)))]

'delete from inventory where _==(7==(9)!=(---5)==1)==-8'
Tainted[_==(7==(9)!=(---5)==1)==-8]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can now inspect our enhanced grammar to see how many times each rule was used.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tgf</span><span class="o">.</span><span class="n">ctp_grammar</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{'&lt;start&gt;': [(['&lt;query&gt;'], {'use': 10})],
 '&lt;expr&gt;': [(['&lt;bexpr&gt;'], {'use': 8}),
  (['&lt;aexpr&gt;'], {'use': 8}),
  (['(', '&lt;expr&gt;', ')'], {'use': 8}),
  (['&lt;term&gt;'], {'use': 10})],
 '&lt;bexpr&gt;': [(['&lt;aexpr&gt;', '&lt;lt&gt;', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;aexpr&gt;', '&lt;gt&gt;', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;expr&gt;', '==', '&lt;expr&gt;'], {'use': 8}),
  (['&lt;expr&gt;', '!=', '&lt;expr&gt;'], {'use': 8})],
 '&lt;aexpr&gt;': [(['&lt;aexpr&gt;', '+', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;aexpr&gt;', '-', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;aexpr&gt;', '*', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;aexpr&gt;', '/', '&lt;aexpr&gt;'], {'use': 0}),
  (['&lt;word&gt;', '(', '&lt;exprs&gt;', ')'], {'use': 0}),
  (['&lt;expr&gt;'], {'use': 8})],
 '&lt;exprs&gt;': [(['&lt;expr&gt;', ',', '&lt;exprs&gt;'], {'use': 0}),
  (['&lt;expr&gt;'], {'use': 5})],
 '&lt;lt&gt;': [(['&lt;'], {'use': 0})],
 '&lt;gt&gt;': [(['&gt;'], {'use': 0})],
 '&lt;term&gt;': [(['&lt;number&gt;'], {'use': 9}), (['&lt;word&gt;'], {'use': 9})],
 '&lt;number&gt;': [(['&lt;integer&gt;', '.', '&lt;integer&gt;'], {'use': 0}),
  (['&lt;integer&gt;'], {'use': 9}),
  (['-', '&lt;number&gt;'], {'use': 8})],
 '&lt;integer&gt;': [(['&lt;digit&gt;', '&lt;integer&gt;'], {'use': 0}),
  (['&lt;digit&gt;'], {'use': 9})],
 '&lt;word&gt;': [(['&lt;word&gt;', '&lt;letter&gt;'], {'use': 0}),
  (['&lt;word&gt;', '&lt;digit&gt;'], {'use': 0}),
  (['&lt;letter&gt;'], {'use': 9})],
 '&lt;digit&gt;': [(['0'], {'use': 2}),
  (['1'], {'use': 4}),
  (['2'], {'use': 6}),
  (['3'], {'use': 3}),
  (['4'], {'use': 2}),
  (['5'], {'use': 5}),
  (['6'], {'use': 3}),
  (['7'], {'use': 5}),
  (['8'], {'use': 6}),
  (['9'], {'use': 3})],
 '&lt;letter&gt;': [(['a'], {'use': 2}),
  (['b'], {'use': 1}),
  (['c'], {'use': 1}),
  (['d'], {'use': 1}),
  (['e'], {'use': 1}),
  (['f'], {'use': 0}),
  (['g'], {'use': 1}),
  (['h'], {'use': 1}),
  (['i'], {'use': 0}),
  (['j'], {'use': 1}),
  (['k'], {'use': 0}),
  (['l'], {'use': 1}),
  (['m'], {'use': 0}),
  (['n'], {'use': 1}),
  (['o'], {'use': 1}),
  (['p'], {'use': 1}),
  (['q'], {'use': 1}),
  (['r'], {'use': 0}),
  (['s'], {'use': 2}),
  (['t'], {'use': 2}),
  (['u'], {'use': 1}),
  (['v'], {'use': 2}),
  (['w'], {'use': 2}),
  (['x'], {'use': 0}),
  (['y'], {'use': 1}),
  (['z'], {'use': 0}),
  (['A'], {'use': 2}),
  (['B'], {'use': 0}),
  (['C'], {'use': 2}),
  (['D'], {'use': 0}),
  (['E'], {'use': 0}),
  (['F'], {'use': 0}),
  (['G'], {'use': 1}),
  (['H'], {'use': 1}),
  (['I'], {'use': 2}),
  (['J'], {'use': 2}),
  (['K'], {'use': 2}),
  (['L'], {'use': 1}),
  (['M'], {'use': 1}),
  (['N'], {'use': 2}),
  (['O'], {'use': 1}),
  (['P'], {'use': 2}),
  (['Q'], {'use': 2}),
  (['R'], {'use': 1}),
  (['S'], {'use': 1}),
  (['T'], {'use': 2}),
  (['U'], {'use': 1}),
  (['V'], {'use': 0}),
  (['W'], {'use': 1}),
  (['X'], {'use': 2}),
  (['Y'], {'use': 3}),
  (['Z'], {'use': 2}),
  (['_'], {'use': 3}),
  ([':'], {'use': 1}),
  (['.'], {'use': 1})],
 '&lt;query&gt;': [(['select ', '&lt;exprs&gt;', ' from ', '&lt;table&gt;'], {'use': 5}),
  (['select ', '&lt;exprs&gt;', ' from ', '&lt;table&gt;', ' where ', '&lt;bexpr&gt;'],
   {'use': 0}),
  (['insert into ',
    '&lt;table&gt;',
    ' (',
    '&lt;names&gt;',
    ') values (',
    '&lt;literals&gt;',
    ')'],
   {'use': 0}),
  (['update ', '&lt;table&gt;', ' set ', '&lt;assignments&gt;', ' where ', '&lt;bexpr&gt;'],
   {'use': 0}),
  (['delete from ', '&lt;table&gt;', ' where ', '&lt;bexpr&gt;'], {'use': 5})],
 '&lt;table&gt;': [(['inventory'], {'use': 0})],
 '&lt;names&gt;': [(['&lt;column&gt;', ',', '&lt;names&gt;'], {'use': 0}),
  (['&lt;column&gt;'], {'use': 0})],
 '&lt;column&gt;': [(['&lt;word&gt;'], {'use': 0})],
 '&lt;literals&gt;': [(['&lt;literal&gt;'], {'use': 0}),
  (['&lt;literal&gt;', ',', '&lt;literals&gt;'], {'use': 0})],
 '&lt;literal&gt;': [(['&lt;number&gt;'], {'use': 0}),
  (["'", '&lt;chars&gt;', "'"], {'use': 0})],
 '&lt;assignments&gt;': [(['&lt;kvp&gt;', ',', '&lt;assignments&gt;'], {'use': 0}),
  (['&lt;kvp&gt;'], {'use': 0})],
 '&lt;kvp&gt;': [(['&lt;column&gt;', '=', '&lt;value&gt;'], {'use': 0})],
 '&lt;value&gt;': [(['&lt;word&gt;'], {'use': 0})],
 '&lt;chars&gt;': [(['&lt;char&gt;'], {'use': 0}), (['&lt;char&gt;', '&lt;chars&gt;'], {'use': 0})],
 '&lt;char&gt;': [(['0'], {'use': 0}),
  (['1'], {'use': 0}),
  (['2'], {'use': 0}),
  (['3'], {'use': 0}),
  (['4'], {'use': 0}),
  (['5'], {'use': 0}),
  (['6'], {'use': 0}),
  (['7'], {'use': 0}),
  (['8'], {'use': 0}),
  (['9'], {'use': 0}),
  (['a'], {'use': 0}),
  (['b'], {'use': 0}),
  (['c'], {'use': 0}),
  (['d'], {'use': 0}),
  (['e'], {'use': 0}),
  (['f'], {'use': 0}),
  (['g'], {'use': 0}),
  (['h'], {'use': 0}),
  (['i'], {'use': 0}),
  (['j'], {'use': 0}),
  (['k'], {'use': 0}),
  (['l'], {'use': 0}),
  (['m'], {'use': 0}),
  (['n'], {'use': 0}),
  (['o'], {'use': 0}),
  (['p'], {'use': 0}),
  (['q'], {'use': 0}),
  (['r'], {'use': 0}),
  (['s'], {'use': 0}),
  (['t'], {'use': 0}),
  (['u'], {'use': 0}),
  (['v'], {'use': 0}),
  (['w'], {'use': 0}),
  (['x'], {'use': 0}),
  (['y'], {'use': 0}),
  (['z'], {'use': 0}),
  (['A'], {'use': 0}),
  (['B'], {'use': 0}),
  (['C'], {'use': 0}),
  (['D'], {'use': 0}),
  (['E'], {'use': 0}),
  (['F'], {'use': 0}),
  (['G'], {'use': 0}),
  (['H'], {'use': 0}),
  (['I'], {'use': 0}),
  (['J'], {'use': 0}),
  (['K'], {'use': 0}),
  (['L'], {'use': 0}),
  (['M'], {'use': 0}),
  (['N'], {'use': 0}),
  (['O'], {'use': 0}),
  (['P'], {'use': 0}),
  (['Q'], {'use': 0}),
  (['R'], {'use': 0}),
  (['S'], {'use': 0}),
  (['T'], {'use': 0}),
  (['U'], {'use': 0}),
  (['V'], {'use': 0}),
  (['W'], {'use': 0}),
  (['X'], {'use': 0}),
  (['Y'], {'use': 0}),
  (['Z'], {'use': 0}),
  (['!'], {'use': 0}),
  (['#'], {'use': 0}),
  (['$'], {'use': 0}),
  (['%'], {'use': 0}),
  (['&amp;'], {'use': 0}),
  (['('], {'use': 0}),
  ([')'], {'use': 0}),
  (['*'], {'use': 0}),
  (['+'], {'use': 0}),
  ([','], {'use': 0}),
  (['-'], {'use': 0}),
  (['.'], {'use': 0}),
  (['/'], {'use': 0}),
  ([':'], {'use': 0}),
  ([';'], {'use': 0}),
  (['='], {'use': 0}),
  (['?'], {'use': 0}),
  (['@'], {'use': 0}),
  (['['], {'use': 0}),
  (['\\'], {'use': 0}),
  ([']'], {'use': 0}),
  (['^'], {'use': 0}),
  (['_'], {'use': 0}),
  (['`'], {'use': 0}),
  (['{'], {'use': 0}),
  (['|'], {'use': 0}),
  (['}'], {'use': 0}),
  (['~'], {'use': 0}),
  ([' '], {'use': 0}),
  (['&lt;lt&gt;'], {'use': 0}),
  (['&lt;gt&gt;'], {'use': 0})]}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>From here, the idea is to focus on the rules that reached dangerous operations more often, and increase the probability of the values of that kind.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="The-Limits-of-Taint-Tracking">The Limits of Taint Tracking</h3><p>While our framework can detect information leakage, it is by no means perfect.  There are several ways in which taints can get lost and information thus may still leak out.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Conversions">Conversions</h4><p>We only track taints and origins through <em>strings</em> and <em>characters</em>.  If we convert these to numbers (or other data), the information is lost.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As an example, consider this function, converting individual characters to numbers and back:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">strip_all_info</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s2">"Secret"</span><span class="p">)</span>
<span class="n">othello</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'Secret'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">othello</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[0, 1, 2, 3, 4, 5]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The taints and origins will not propagate through the number conversion:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">thello_stripped</span> <span class="o">=</span> <span class="n">strip_all_info</span><span class="p">(</span><span class="n">thello</span><span class="p">)</span>
<span class="n">thello_stripped</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'hello, world'
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="n">thello_stripped</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/588526133.py", line 2, in &lt;module&gt;
    thello_stripped.origin
AttributeError: 'str' object has no attribute 'origin' (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This issue could be addressed by extending numbers with taints and origins, just as we did for strings.  At some point, however, this will still break down, because as soon as an internal C function in the Python library is reached, the taint will not propagate into and across the C function.  (Unless one starts implementing dynamic taints for these, that is.)</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Internal-C-libraries">Internal C libraries</h4></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As we mentioned before, calls to <em>internal</em> C libraries do not propagate taints. For example, while the following preserves the taints,</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">hello</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">ostr</span><span class="p">(</span><span class="s1">'world'</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="p">(</span><span class="n">hello</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="n">world</span><span class="p">)</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[100, 101, 102, 103, 104, -1, 200, 201, 202, 203, 204]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>a call to a <code>join</code> that should be equivalent will fail.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">():</span>
    <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">hello</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="n">world</span><span class="p">])</span><span class="o">.</span><span class="n">origin</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Traceback (most recent call last):
  File "/var/folders/n2/xd9445p97rb3xh7m1dfx8_4h0006ts/T/ipykernel_34365/2341342688.py", line 2, in &lt;module&gt;
    ''.join([hello, ' ', world]).origin  # type: ignore
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'str' object has no attribute 'origin' (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Implicit-Information-Flow">Implicit Information Flow</h4><p>Even if one could taint all data in a program, there still would be means to break information flow – notably by turning explicit flow into <em>implicit</em> flow, or data flow into <em>control flow</em>.  Here is an example:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">strip_all_info_again</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">'a'</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">'a'</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">'b'</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">'b'</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">'c'</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="s1">'c'</span>
    <span class="o">...</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>With such a function, there is no explicit data flow between the characters in <code>s</code> and the characters in <code>t</code>; yet, the strings would be identical.  This problem frequently occurs in programs that process and manipulate external input.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Enforcing-Tainting">Enforcing Tainting</h4><p>Both, conversions and implicit information flow are one of several possibilities how taint and origin information get lost.  To address the problem, the best solution is to <em>always assume the worst from untainted strings</em>:</p>
<ul>
<li><p>As it comes to trust, an untainted string should be treated as <em>possibly untrusted</em>, and hence not relied upon unless sanitized.</p>
</li>
<li><p>As it comes to privacy, an untainted string should be treated as <em>possibly secret</em>, and hence not leaked out.</p>
</li>
</ul>
<p>As a consequence, your program should always have two kinds of taints: one for explicitly trusted (or secret) and one for explicitly untrusted (or non-secret).  If a taint gets lost along the way, you may have to restore it from its sources – not unlike the string methods discussed above.  The benefit is a trusted application, in which each and every information flow can be checked at runtime, with violations quickly discovered through automated tests.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Lessons-Learned">Lessons Learned</h2><ul>
<li><p>String-based and character-based taints allow dynamically tracking the information flow from input to the internals of a system and back to the output.</p>
</li>
<li><p>Checking taints allows discovering untrusted inputs and information leakage at runtime.</p>
</li>
<li><p>Data conversions and implicit data flow may strip taint information; the resulting untainted strings should be treated as having the worst possible taint.</p>
</li>
<li><p>Taints can be used in conjunction with fuzzing to provide a more robust indication of incorrect behavior than to simply rely on program crashes.</p>
</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Next-Steps">Next Steps</h2><p>An even better alternative to our taint-directed fuzzing is to make use of <em>symbolic</em> techniques that take the semantics of the program under test into account.  The chapter on <a href="FlowFuzzer.html">flow fuzzing</a> introduces these symbolic techniques for the purpose of exploring information flows; the subsequent chapter on <a href="SymbolicFuzzer.html">symbolic fuzzing</a> then shows how to make full-fledged use of symbolic execution for covering code.  Similarly, <a href="SearchBasedFuzzer.html">search based fuzzing</a> can often provide a cheaper exploration strategy.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Background">Background</h2><p>Taint analysis on Python using a library approach as we implemented in this chapter was discussed by Conti et al. [<a href="https://doi.org/10.1007/978-3-642-27937-9_15">Conti <em>et al</em>, 2012</a>].</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Exercises">Exercises</h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-1:-Tainted-Numbers">Exercise 1: Tainted Numbers</h3><p>Introduce a class <code>tint</code> (for tainted integer) that, like <code>tstr</code>, has a taint attribute that gets passed on from <code>tint</code> to <code>tint</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-1:-Creation">Part 1: Creation</h4><p>Implement the <code>tint</code> class such that taints are set:</p>
<div class="highlight"><pre><span/><span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'SECRET'</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'SECRET'</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/InformationFlow.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-2:-Arithmetic-expressions">Part 2: Arithmetic expressions</h4><p>Ensure that taints get passed along arithmetic expressions; support addition, subtraction, multiplication, and division operators.</p>
<div class="highlight"><pre><span/><span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="n">y</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'SECRET'</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/InformationFlow.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-3:-Passing-taints-from-integers-to-strings">Part 3: Passing taints from integers to strings</h4><p>Converting a tainted integer into a string (using <code>repr()</code>) should yield a tainted string:</p>
<div class="highlight"><pre><span/><span class="n">x_s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x_s</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'SECRET'</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/InformationFlow.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-4:-Passing-taints-from-strings-to-integers">Part 4: Passing taints from strings to integers</h4><p>Converting a tainted object (with a <code>taint</code> attribute) to an integer should pass that taint:</p>
<div class="highlight"><pre><span/><span class="n">password</span> <span class="o">=</span> <span class="n">tstr</span><span class="p">(</span><span class="s1">'1234'</span><span class="p">,</span> <span class="n">taint</span><span class="o">=</span><span class="s1">'NOT_EXACTLY_SECRET'</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tint</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1234</span>
<span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">taint</span> <span class="o">==</span> <span class="s1">'NOT_EXACTLY_SECRET'</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/InformationFlow.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-2:-Information-Flow-Testing">Exercise 2: Information Flow Testing</h3><p>Generate tests that ensure a <em>maximum</em> of information flow, propagating specific taints as much as possible.  Implement an appropriate fitness function for <a href="SearchBasedFuzzer.html">search-based testing</a> and let the search-based fuzzer search for solutions.</p>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/InformationFlow.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

        
<p class="imprint">
<img style="float:right" src="../Images/2f3faa36146c6fb38bbab67add09aa5f.png" alt="Creative Commons License" data-original-src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/>
The content of this project is licensed under the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
The source code that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
<a href="https://github.com/uds-se/fuzzingbook/commits/master/notebooks/InformationFlow.ipynb" target="_blank)">Last change: 2024-11-09 17:07:29+01:00</a> • 
<a href="#citation" id="cite" onclick="revealCitation()">Cite</a> •
<a href="https://cispa.de/en/impressum" target="_blank">Imprint</a>
</p>



<div id="citation" class="citation" style="display: none;">
<a name="citation"/>
<h2>How to Cite this Work</h2>
<p>
Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler: "<a href="https://www.fuzzingbook.org/html/InformationFlow.html">Tracking Information Flow</a>".  In Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler, "<a href="https://www.fuzzingbook.org/">The Fuzzing Book</a>", <a href="https://www.fuzzingbook.org/html/InformationFlow.html">https://www.fuzzingbook.org/html/InformationFlow.html</a>.  Retrieved 2024-11-09 17:07:29+01:00.
</p>
<pre>
@incollection{fuzzingbook2024:InformationFlow,
    author = {Andreas Zeller and Rahul Gopinath and Marcel B{\"o}hme and Gordon Fraser and Christian Holler},
    booktitle = {The Fuzzing Book},
    title = {Tracking Information Flow},
    year = {2024},
    publisher = {CISPA Helmholtz Center for Information Security},
    howpublished = {\url{https://www.fuzzingbook.org/html/InformationFlow.html}},
    note = {Retrieved 2024-11-09 17:07:29+01:00},
    url = {https://www.fuzzingbook.org/html/InformationFlow.html},
    urldate = {2024-11-09 17:07:29+01:00}
}
</pre>
</div>

          
</body>
</html>