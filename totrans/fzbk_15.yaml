- en: Efficient Grammar Fuzzing
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[http://www.fuzzingbook.org/html/GrammarFuzzer.html](http://www.fuzzingbook.org/html/GrammarFuzzer.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: In the [chapter on grammars](Grammars.html), we have seen how to use *grammars*
    for very effective and efficient testing. In this chapter, we refine the previous
    *string-based* algorithm into a *tree-based* algorithm, which is much faster and
    allows for much more control over the production of fuzz inputs.
  prefs: []
  type: TYPE_NORMAL
- en: The algorithm in this chapter serves as a foundation for several more techniques;
    this chapter thus is a "hub" in the book.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: '**Prerequisites**'
  prefs: []
  type: TYPE_NORMAL
- en: You should know how grammar-based fuzzing works, e.g. from the [chapter on grammars](Grammars.html).
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Synopsis
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To [use the code provided in this chapter](Importing.html), write
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: and then make use of the following features.
  prefs: []
  type: TYPE_NORMAL
- en: Efficient Grammar Fuzzing
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'This chapter introduces `GrammarFuzzer`, an efficient grammar fuzzer that takes
    a grammar to produce syntactically valid input strings. Here''s a typical usage:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'The `GrammarFuzzer` constructor takes a number of keyword arguments to control
    its behavior. `start_symbol`, for instance, allows setting the symbol that expansion
    starts with (instead of `<start>`):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Here''s how to parameterize the `GrammarFuzzer` constructor:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: '<svg width="324pt" height="458pt" viewBox="0.00 0.00 323.62 458.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 454.25)"><g
    id="node1" class="node"><title>GrammarFuzzer</title> <g id="a_node1"><a xlink:href="#"
    xlink:title="class GrammarFuzzer:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Produce strings from grammars efficiently, using derivation trees."><text text-anchor="start"
    x="39.12" y="-311.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold"
    font-size="14.00" fill="#b03a2e">GrammarFuzzer</text> <g id="a_node1_0"><a xlink:href="#"
    xlink:title="GrammarFuzzer"><g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self,
    grammar: Dict[str, List[Expansion]], start_symbol: str = ''<start>'', min_nonterminals:
    int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int]
    = False) -> None:'
  prefs: []
  type: TYPE_NORMAL
- en: Produce strings from `grammar`, starting with `start_symbol`.
  prefs: []
  type: TYPE_NORMAL
- en: If `min_nonterminals` or `max_nonterminals` is given, use them as limits
  prefs: []
  type: TYPE_NORMAL
- en: for the number of nonterminals produced.
  prefs: []
  type: TYPE_NORMAL
- en: If `disp` is set, display the intermediate derivation trees.
  prefs: []
  type: TYPE_NORMAL
- en: 'If `log` is set, show intermediate steps as text on standard output."><text
    text-anchor="start" x="8" y="-289.25" font-family="''Fira Mono'', ''Source Code
    Pro'', ''Courier'', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text></a></g>
    <g id="a_node1_2"><a xlink:href="#" xlink:title="fuzz(self) -> str:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Produce a string from the grammar."><text text-anchor="start" x="8" y="-276.5"
    font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace" font-weight="bold"
    font-style="italic" font-size="10.00">fuzz()</text></a></g> <g id="a_node1_3"><a
    xlink:href="#" xlink:title="fuzz_tree(self) -> DerivationTree:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Produce a derivation tree from the grammar."><text text-anchor="start" x="8"
    y="-263.75" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace"
    font-weight="bold" font-size="10.00">fuzz_tree()</text></a></g> <g id="a_node1_4"><a
    xlink:href="#" xlink:title="any_possible_expansions(self, node: DerivationTree)
    -> bool"><text text-anchor="start" x="8" y="-250" font-family="''Fira Mono'',
    ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">any_possible_expansions()</text></a></g>
    <g id="a_node1_5"><a xlink:href="#" xlink:title="check_grammar(self) -> None:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Check the grammar passed"><text text-anchor="start" x="8" y="-237.25" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">check_grammar()</text></a></g>
    <g id="a_node1_6"><a xlink:href="#" xlink:title="choose_node_expansion(self, node:
    DerivationTree, children_alternatives: List[List[DerivationTree]]) -> int:'
  prefs: []
  type: TYPE_NORMAL
- en: Return index of expansion in `children_alternatives` to be selected.
  prefs: []
  type: TYPE_NORMAL
- en: '''children_alternatives`: a list of possible children for `node`.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Defaults to random. To be overloaded in subclasses."><text text-anchor="start"
    x="8" y="-225.5" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'',
    monospace" font-style="italic" font-size="10.00">choose_node_expansion()</text></a></g>
    <g id="a_node1_7"><a xlink:href="#" xlink:title="choose_tree_expansion(self, tree:
    DerivationTree, children: List[DerivationTree]) -> int:'
  prefs: []
  type: TYPE_NORMAL
- en: Return index of subtree in `children` to be selected for expansion.
  prefs: []
  type: TYPE_NORMAL
- en: 'Defaults to random."><text text-anchor="start" x="8" y="-211.75" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">choose_tree_expansion()</text></a></g>
    <g id="a_node1_8"><a xlink:href="#" xlink:title="expand_node(self, node: DerivationTree)
    -> DerivationTree"><text text-anchor="start" x="8" y="-199" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">expand_node()</text></a></g>
    <g id="a_node1_9"><a xlink:href="#" xlink:title="expand_node_by_cost(self, node:
    DerivationTree, choose: Callable = <built-in function min>) -> DerivationTree"><text
    text-anchor="start" x="8" y="-186.25" font-family="''Fira Mono'', ''Source Code
    Pro'', ''Courier'', monospace" font-size="10.00">expand_node_by_cost()</text></a></g>
    <g id="a_node1_10"><a xlink:href="#" xlink:title="expand_node_max_cost(self, node:
    DerivationTree) -> DerivationTree"><text text-anchor="start" x="8" y="-173.5"
    font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">expand_node_max_cost()</text></a></g>
    <g id="a_node1_11"><a xlink:href="#" xlink:title="expand_node_min_cost(self, node:
    DerivationTree) -> DerivationTree"><text text-anchor="start" x="8" y="-160.75"
    font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">expand_node_min_cost()</text></a></g>
    <g id="a_node1_12"><a xlink:href="#" xlink:title="expand_node_randomly(self, node:
    DerivationTree) -> DerivationTree:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Choose a random expansion for `node` and return it"><text text-anchor="start"
    x="8" y="-148" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace"
    font-size="10.00">expand_node_randomly()</text></a></g> <g id="a_node1_13"><a
    xlink:href="#" xlink:title="expand_tree(self, tree: DerivationTree) -> DerivationTree:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Expand `tree` in a three-phase strategy until all expansions are complete."><text
    text-anchor="start" x="8" y="-135.25" font-family="''Fira Mono'', ''Source Code
    Pro'', ''Courier'', monospace" font-size="10.00">expand_tree()</text></a></g>
    <g id="a_node1_14"><a xlink:href="#" xlink:title="expand_tree_once(self, tree:
    DerivationTree) -> DerivationTree:'
  prefs: []
  type: TYPE_NORMAL
- en: Choose an unexpanded symbol in tree; expand it.
  prefs: []
  type: TYPE_NORMAL
- en: 'Can be overloaded in subclasses."><text text-anchor="start" x="8" y="-123.5"
    font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace" font-style="italic"
    font-size="10.00">expand_tree_once()</text></a></g> <g id="a_node1_15"><a xlink:href="#"
    xlink:title="expand_tree_with_strategy(self, tree: DerivationTree, expand_node_method:
    Callable, limit: Optional[int] = None):'
  prefs: []
  type: TYPE_NORMAL
- en: Expand tree using `expand_node_method` as node expansion function
  prefs: []
  type: TYPE_NORMAL
- en: 'until the number of possible expansions reaches `limit`."><text text-anchor="start"
    x="8" y="-109.75" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'',
    monospace" font-size="10.00">expand_tree_with_strategy()</text></a></g> <g id="a_node1_16"><a
    xlink:href="#" xlink:title="expansion_cost(self, expansion: Expansion, seen: Set[str]
    = set()) -> Union[int, float]"><text text-anchor="start" x="8" y="-97" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">expansion_cost()</text></a></g>
    <g id="a_node1_17"><a xlink:href="#" xlink:title="expansion_to_children(self,
    expansion: Expansion) -> List[DerivationTree]"><text text-anchor="start" x="8"
    y="-84.25" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace"
    font-size="10.00">expansion_to_children()</text></a></g> <g id="a_node1_18"><a
    xlink:href="#" xlink:title="init_tree(self) -> DerivationTree"><text text-anchor="start"
    x="8" y="-71.5" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'',
    monospace" font-size="10.00">init_tree()</text></a></g> <g id="a_node1_19"><a
    xlink:href="#" xlink:title="log_tree(self, tree: DerivationTree) -> None:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Output a tree if self.log is set; if self.display is also set, show the tree
    structure"><text text-anchor="start" x="8" y="-58.75" font-family="''Fira Mono'',
    ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">log_tree()</text></a></g>
    <g id="a_node1_20"><a xlink:href="#" xlink:title="possible_expansions(self, node:
    DerivationTree) -> int"><text text-anchor="start" x="8" y="-46" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-size="10.00">possible_expansions()</text></a></g>
    <g id="a_node1_21"><a xlink:href="#" xlink:title="process_chosen_children(self,
    chosen_children: List[DerivationTree], expansion: Expansion) -> List[DerivationTree]:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Process children after selection. &nbsp;By default, does nothing."><text text-anchor="start"
    x="8" y="-33.25" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'',
    monospace" font-size="10.00">process_chosen_children()</text></a></g> <g id="a_node1_22"><a
    xlink:href="#" xlink:title="supported_opts(self) -> Set[str]:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Set of supported options. To be overloaded in subclasses."><text text-anchor="start"
    x="8" y="-21.5" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'',
    monospace" font-style="italic" font-size="10.00">supported_opts()</text></a></g>
    <g id="a_node1_23"><a xlink:href="#" xlink:title="symbol_cost(self, symbol: str,
    seen: Set[str] = set()) -> Union[int, float]"><text text-anchor="start" x="8"
    y="-7.75" font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace"
    font-size="10.00">symbol_cost()</text></a></g></a></g></a></g></g> <g id="node2"
    class="node"><title>Fuzzer</title> <g id="a_node2"><a xlink:href="Fuzzer.html"
    xlink:title="class Fuzzer:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Base class for fuzzers."><text text-anchor="start" x="68.38" y="-433.45" font-family="Patua
    One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
    <g id="a_node2_24"><a xlink:href="#" xlink:title="Fuzzer"><g id="a_node2_25"><a
    xlink:href="Fuzzer.html" xlink:title="__init__(self) -> None:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Constructor"><text text-anchor="start" x="59" y="-411.25" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-weight="bold" font-style="italic"
    font-size="10.00">__init__()</text></a></g> <g id="a_node2_26"><a xlink:href="Fuzzer.html"
    xlink:title="fuzz(self) -> str:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Return fuzz input"><text text-anchor="start" x="59" y="-398.5" font-family="''Fira
    Mono'', ''Source Code Pro'', ''Courier'', monospace" font-weight="bold" font-style="italic"
    font-size="10.00">fuzz()</text></a></g> <g id="a_node2_27"><a xlink:href="Fuzzer.html"
    xlink:title="run(self, runner: Fuzzer.Runner = <Fuzzer.Runner object>) -> Tuple[subprocess.CompletedProcess,
    str]:'
  prefs: []
  type: TYPE_NORMAL
- en: 'Run `runner` with fuzz input"><text text-anchor="start" x="59" y="-385.75"
    font-family="''Fira Mono'', ''Source Code Pro'', ''Courier'', monospace" font-weight="bold"
    font-size="10.00">run()</text></a></g> <g id="a_node2_28"><a xlink:href="Fuzzer.html"
    xlink:title="runs(self, runner: Fuzzer.Runner = <Fuzzer.PrintRunner object>, trials:
    int = 10) -> List[Tuple[subprocess.CompletedProcess, str]]:'
  prefs: []
  type: TYPE_NORMAL
- en: Run `runner` with fuzz input, `trials` times"><text text-anchor="start" x="59"
    y="-373" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold"
    font-size="10.00">runs()</text></a></g></a></g></a></g></g> <g id="edge1" class="edge"><title>GrammarFuzzer->Fuzzer</title></g>
    <g id="node3" class="node"><title>Legend</title> <text text-anchor="start" x="196.38"
    y="-180.12" font-family="Patua One, Helvetica, sans-serif" font-weight="bold"
    font-size="10.00" fill="#b03a2e">Legend</text> <text text-anchor="start" x="196.38"
    y="-170.12" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
    <text text-anchor="start" x="202.38" y="-170.12" font-family="'Fira Mono', 'Source
    Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
    <text text-anchor="start" x="196.38" y="-160.12" font-family="Patua One, Helvetica,
    sans-serif" font-size="10.00">• </text> <text text-anchor="start" x="202.38" y="-160.12"
    font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
    <text text-anchor="start" x="196.38" y="-150.12" font-family="Patua One, Helvetica,
    sans-serif" font-size="10.00">• </text> <text text-anchor="start" x="202.38" y="-150.12"
    font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic"
    font-size="8.00">overloaded_method()</text> <text text-anchor="start" x="196.38"
    y="-141.07" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names
    to see doc</text></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: Derivation Trees
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Internally, `GrammarFuzzer` makes use of [derivation trees](#Derivation-Trees),
    which it expands step by step. After producing a string, the tree produced can
    be accessed in the `derivation_tree` attribute.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="636pt" height="223pt" viewBox="0.00 0.00 635.75 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="265.12"
    y="-201.95" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="265.12"
    y="-151.7" font-family="Times,serif" font-size="14.00"><phone-number></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="113.12" y="-101.45" font-family="Times,serif" font-size="14.00">(
    (40)</text></g> <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4"
    class="node"><title>3</title> <text text-anchor="middle" x="166.12" y="-101.45"
    font-family="Times,serif" font-size="14.00"><area></text></g> <g id="edge3" class="edge"><title>1->3</title></g>
    <g id="node11" class="node"><title>10</title> <text text-anchor="middle" x="232.12"
    y="-101.45" font-family="Times,serif" font-size="14.00">) (41)</text></g> <g id="edge10"
    class="edge"><title>1->10</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="299.12" y="-101.45" font-family="Times,serif" font-size="14.00"><exchange></text></g>
    <g id="edge11" class="edge"><title>1->11</title></g> <g id="node19" class="node"><title>18</title>
    <text text-anchor="middle" x="366.12" y="-101.45" font-family="Times,serif" font-size="14.00">-
    (45)</text></g> <g id="edge18" class="edge"><title>1->18</title></g> <g id="node20"
    class="node"><title>19</title> <text text-anchor="middle" x="489.12" y="-101.45"
    font-family="Times,serif" font-size="14.00"><line></text></g> <g id="edge19" class="edge"><title>1->19</title></g>
    <g id="node5" class="node"><title>4</title> <text text-anchor="middle" x="34.12"
    y="-51.2" font-family="Times,serif" font-size="14.00"><lead-digit></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="107.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge6" class="edge"><title>3->6</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="166.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge8" class="edge"><title>3->8</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="34.12" y="-0.95" font-family="Times,serif" font-size="14.00">7
    (55)</text></g> <g id="edge5" class="edge"><title>4->5</title></g> <g id="node8"
    class="node"><title>7</title> <text text-anchor="middle" x="107.12" y="-0.95"
    font-family="Times,serif" font-size="14.00">7 (55)</text></g> <g id="edge7" class="edge"><title>6->7</title></g>
    <g id="node10" class="node"><title>9</title> <text text-anchor="middle" x="166.12"
    y="-0.95" font-family="Times,serif" font-size="14.00">1 (49)</text></g> <g id="edge9"
    class="edge"><title>8->9</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="239.12" y="-51.2" font-family="Times,serif" font-size="14.00"><lead-digit></text></g>
    <g id="edge12" class="edge"><title>11->12</title></g> <g id="node15" class="node"><title>14</title>
    <text text-anchor="middle" x="312.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge14" class="edge"><title>11->14</title></g> <g id="node17" class="node"><title>16</title>
    <text text-anchor="middle" x="371.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge16" class="edge"><title>11->16</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="239.12" y="-0.95" font-family="Times,serif" font-size="14.00">3
    (51)</text></g> <g id="edge13" class="edge"><title>12->13</title></g> <g id="node16"
    class="node"><title>15</title> <text text-anchor="middle" x="312.12" y="-0.95"
    font-family="Times,serif" font-size="14.00">0 (48)</text></g> <g id="edge15" class="edge"><title>14->15</title></g>
    <g id="node18" class="node"><title>17</title> <text text-anchor="middle" x="371.12"
    y="-0.95" font-family="Times,serif" font-size="14.00">6 (54)</text></g> <g id="edge17"
    class="edge"><title>16->17</title></g> <g id="node21" class="node"><title>20</title>
    <text text-anchor="middle" x="430.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge20" class="edge"><title>19->20</title></g> <g id="node23" class="node"><title>22</title>
    <text text-anchor="middle" x="489.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge22" class="edge"><title>19->22</title></g> <g id="node25" class="node"><title>24</title>
    <text text-anchor="middle" x="548.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge24" class="edge"><title>19->24</title></g> <g id="node27" class="node"><title>26</title>
    <text text-anchor="middle" x="607.12" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge26" class="edge"><title>19->26</title></g> <g id="node22" class="node"><title>21</title>
    <text text-anchor="middle" x="430.12" y="-0.95" font-family="Times,serif" font-size="14.00">0
    (48)</text></g> <g id="edge21" class="edge"><title>20->21</title></g> <g id="node24"
    class="node"><title>23</title> <text text-anchor="middle" x="489.12" y="-0.95"
    font-family="Times,serif" font-size="14.00">6 (54)</text></g> <g id="edge23" class="edge"><title>22->23</title></g>
    <g id="node26" class="node"><title>25</title> <text text-anchor="middle" x="548.12"
    y="-0.95" font-family="Times,serif" font-size="14.00">5 (53)</text></g> <g id="edge25"
    class="edge"><title>24->25</title></g> <g id="node28" class="node"><title>27</title>
    <text text-anchor="middle" x="607.12" y="-0.95" font-family="Times,serif" font-size="14.00">9
    (57)</text></g> <g id="edge27" class="edge"><title>26->27</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: In the internal representation of a derivation tree, a *node* is a pair (`symbol`,
    `children`). For nonterminals, `symbol` is the symbol that is being expanded,
    and `children` is a list of further nodes. For terminals, `symbol` is the terminal
    string, and `children` is empty.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: The chapter contains various helpers to work with derivation trees, including
    visualization tools – notably, `display_tree()`, above.
  prefs: []
  type: TYPE_NORMAL
- en: An Insufficient Algorithm
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'In the [previous chapter](Grammars.html), we have introduced the `simple_grammar_fuzzer()`
    function which takes a grammar and automatically produces a syntactically valid
    string from it. However, `simple_grammar_fuzzer()` is just what its name suggests
    – simple. To illustrate the problem, let us get back to the `expr_grammar` we
    created from `EXPR_GRAMMAR_BNF` in the [chapter on grammars](Grammars.html):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: '`expr_grammar` has an interesting property. If we feed it into `simple_grammar_fuzzer()`,
    the function gets stuck:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: Why is that so? Have a look at the grammar; remember what you know about `simple_grammar_fuzzer()`;
    and run `simple_grammar_fuzzer()` with `log=true` argument to see the expansions.
  prefs: []
  type: TYPE_NORMAL
- en: Quiz
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Why does `simple_grammar_fuzzer()` hang?
  prefs: []
  type: TYPE_NORMAL
- en: 'Indeed! The problem is in this rule:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: Here, any choice except for `(expr)` increases the number of symbols, even if
    only temporary. Since we place a hard limit on the number of symbols to expand,
    the only choice left for expanding `<factor>` is `(<expr>)`, which leads to an
    *infinite addition of parentheses.*
  prefs: []
  type: TYPE_NORMAL
- en: 'The problem of potentially infinite expansion is only one of the problems with
    `simple_grammar_fuzzer()`. More problems include:'
  prefs: []
  type: TYPE_NORMAL
- en: '*It is inefficient*. With each iteration, this fuzzer would go search the string
    produced so far for symbols to expand. This becomes inefficient as the production
    string grows.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '*It is hard to control.* Even while limiting the number of symbols, it is still
    possible to obtain very long strings – and even infinitely long ones, as discussed
    above.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Let us illustrate both problems by plotting the time required for strings of
    different lengths.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE19]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE20]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE21]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE22]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE23]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE24]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE25]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE26]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE27]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/2584c049202651a68ebeb102d6b4f1c4.png)'
  prefs: []
  type: TYPE_IMG
- en: We see that (1) the time needed to generate an output increases quadratically
    with the length of that output, and that (2) a large portion of the produced outputs
    are tens of thousands of characters long.
  prefs: []
  type: TYPE_NORMAL
- en: To address these problems, we need a *smarter algorithm* – one that is more
    efficient, that gets us better control over expansions, and that is able to foresee
    in `expr_grammar` that the `(expr)` alternative yields a potentially infinite
    expansion, in contrast to the other two.
  prefs: []
  type: TYPE_NORMAL
- en: Derivation Trees
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To both obtain a more efficient algorithm *and* exercise better control over
    expansions, we will use a special representation for the strings that our grammar
    produces. The general idea is to use a *tree* structure that will be subsequently
    expanded – a so-called *derivation tree*. This representation allows us to always
    keep track of our expansion status – answering questions such as which elements
    have been expanded into which others, and which symbols still need to be expanded.
    Furthermore, adding new elements to a tree is far more efficient than replacing
    strings again and again.
  prefs: []
  type: TYPE_NORMAL
- en: Like other trees used in programming, a derivation tree (also known as *parse
    tree* or *concrete syntax tree*) consists of *nodes* which have other nodes (called
    *child nodes*) as their *children*. The tree starts with one node that has no
    parent; this is called the *root node*; a node without children is called a *leaf*.
  prefs: []
  type: TYPE_NORMAL
- en: The grammar expansion process with derivation trees is illustrated in the following
    steps, using the arithmetic grammar [from the chapter on grammars](Grammars.html).
    We start with a single node as root of the tree, representing the *start symbol*
    – in our case `<start>`.
  prefs: []
  type: TYPE_NORMAL
- en: <svg width="48pt" height="22pt" viewBox="0.00 0.00 47.75 22.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 18.25)"><title>root</title>
    <g id="node1" class="node"><title>\<start\></title> <text text-anchor="middle"
    x="19.88" y="-0.95" font-family="Times,serif" font-size="14.00"><start></text></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: To expand the tree, we traverse it, searching for a nonterminal symbol $S$ without
    children. $S$ thus is a symbol that still has to be expanded. We then chose an
    expansion for $S$ from the grammar. Then, we add the expansion as a new child
    of $S$. For our start symbol `<start>`, the only expansion is `<expr>`, so we
    add it as a child.
  prefs: []
  type: TYPE_NORMAL
- en: <svg width="49pt" height="73pt" viewBox="0.00 0.00 48.50 72.50" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 68.5)"><title>root</title>
    <g id="node1" class="node"><title>\<start\></title> <text text-anchor="middle"
    x="20.25" y="-51.2" font-family="Times,serif" font-size="14.00"><start></text></g>
    <g id="node2" class="node"><title>\<expr\></title> <text text-anchor="middle"
    x="20.25" y="-0.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>\<start\>->\<expr\></title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: To construct the produced string from a derivation tree, we traverse the tree
    in order and collect the symbols at the leaves of the tree. In the case above,
    we obtain the string `"<expr>"`.
  prefs: []
  type: TYPE_NORMAL
- en: To further expand the tree, we choose another symbol to expand, and add its
    expansion as new children. This would get us the `<expr>` symbol, which gets expanded
    into `<expr> + <term>`, adding three children.
  prefs: []
  type: TYPE_NORMAL
- en: <svg width="138pt" height="123pt" viewBox="0.00 0.00 138.12 122.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 118.75)"><title>root</title>
    <g id="node1" class="node"><title>\<start\></title> <text text-anchor="middle"
    x="66.12" y="-101.45" font-family="Times,serif" font-size="14.00"><start></text></g>
    <g id="node2" class="node"><title>\<expr\></title> <text text-anchor="middle"
    x="66.12" y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>\<start\>->\<expr\></title></g> <g id="node3"
    class="node"><title>\<expr\></title> <text text-anchor="middle" x="22.12" y="-0.95"
    font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge2" class="edge"><title>\<expr\>->\<expr\></title></g>
    <g id="node4" class="node"><title>+</title> <text text-anchor="middle" x="66.12"
    y="-0.95" font-family="Times,serif" font-size="14.00">+</text></g> <g id="edge3"
    class="edge"><title>\<expr\>->+</title></g> <g id="node5" class="node"><title>\<term\></title>
    <text text-anchor="middle" x="109.12" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>\<expr\>->\<term\></title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: 'We repeat the expansion until there are no symbols left to expand:'
  prefs: []
  type: TYPE_NORMAL
- en: <svg width="151pt" height="374pt" viewBox="0.00 0.00 150.88 374.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 370)"><title>root</title>
    <g id="node1" class="node"><title>\<start\></title> <text text-anchor="middle"
    x="72.88" y="-352.7" font-family="Times,serif" font-size="14.00"><start></text></g>
    <g id="node2" class="node"><title>\<expr\></title> <text text-anchor="middle"
    x="72.88" y="-302.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>\<start\>->\<expr\></title></g> <g id="node3"
    class="node"><title>\<expr\></title> <text text-anchor="middle" x="28.88" y="-252.2"
    font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge2" class="edge"><title>\<expr\>->\<expr\></title></g>
    <g id="node4" class="node"><title>+</title> <text text-anchor="middle" x="72.88"
    y="-252.2" font-family="Times,serif" font-size="14.00">+</text></g> <g id="edge3"
    class="edge"><title>\<expr\>->+</title></g> <g id="node5" class="node"><title>\<term\></title>
    <text text-anchor="middle" x="115.88" y="-252.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>\<expr\>->\<term\></title></g> <g id="node6"
    class="node"><title>\<term\></title> <text text-anchor="middle" x="28.88" y="-201.95"
    font-family="Times,serif" font-size="14.00"><term></text></g> <g id="edge5" class="edge"><title>\<expr\>
    ->\<term\></title></g> <g id="node11" class="node"><title>\<factor\></title> <text
    text-anchor="middle" x="115.88" y="-201.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge10" class="edge"><title>\<term\>->\<factor\></title></g> <g id="node7"
    class="node"><title>\<factor\></title> <text text-anchor="middle" x="28.88" y="-151.7"
    font-family="Times,serif" font-size="14.00"><factor></text></g> <g id="edge6"
    class="edge"><title>\<term\> ->\<factor\></title></g> <g id="node8" class="node"><title>\<integer\></title>
    <text text-anchor="middle" x="28.88" y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge7" class="edge"><title>\<factor\> ->\<integer\></title></g> <g id="node9"
    class="node"><title>\<digit\></title> <text text-anchor="middle" x="28.88" y="-51.2"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge8" class="edge"><title>\<integer\>
    ->\<digit\></title></g> <g id="node10" class="node"><title>2</title> <text text-anchor="middle"
    x="28.88" y="-0.95" font-family="Times,serif" font-size="14.00">2</text></g> <g
    id="edge9" class="edge"><title>\<digit\> ->2</title></g> <g id="node12" class="node"><title>\<integer\></title>
    <text text-anchor="middle" x="115.88" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge11" class="edge"><title>\<factor\>->\<integer\></title></g> <g id="node13"
    class="node"><title>\<digit\></title> <text text-anchor="middle" x="115.88" y="-101.45"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge12"
    class="edge"><title>\<integer\>->\<digit\></title></g> <g id="node14" class="node"><title>2</title>
    <text text-anchor="middle" x="115.88" y="-51.2" font-family="Times,serif" font-size="14.00">2</text></g>
    <g id="edge13" class="edge"><title>\<digit\>->2</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We now have a representation for the string `2 + 2`. In contrast to the string
    alone, though, the derivation tree records *the entire structure* (and production
    history, or *derivation* history) of the produced string. It also allows for simple
    comparison and manipulation – say, replacing one subtree (substructure) against
    another.
  prefs: []
  type: TYPE_NORMAL
- en: Representing Derivation Trees
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To represent a derivation tree in Python, we use the following format. A node
    is a pair
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE28]'
  prefs: []
  type: TYPE_PRE
- en: where `SYMBOL_NAME` is a string representing the node (i.e. `"<start>"` or `"+"`)
    and `CHILDREN` is a list of children nodes.
  prefs: []
  type: TYPE_NORMAL
- en: '`CHILDREN` can take some special values:'
  prefs: []
  type: TYPE_NORMAL
- en: '`None` as a placeholder for future expansion. This means that the node is a
    *nonterminal symbol* that should be expanded further.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '`[]` (i.e., the empty list) to indicate *no* children. This means that the
    node is a *terminal symbol* that can no longer be expanded.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: The type `DerivationTree` captures this very structure. (`Any` should actually
    read `DerivationTree`, but the Python static type checker cannot handle recursive
    types well.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE29]'
  prefs: []
  type: TYPE_PRE
- en: Let us take a very simple derivation tree, representing the intermediate step
    `<expr> + <term>`, above.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE30]'
  prefs: []
  type: TYPE_PRE
- en: To better understand the structure of this tree, let us introduce a function
    `display_tree()` that visualizes this tree.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-Implementing-display_tree()"><summary>Implementing `display_tree()`</summary>
  prefs: []
  type: TYPE_NORMAL
- en: We use the `dot` drawing program from the `graphviz` package algorithmically,
    traversing the above structure. (Unless you're deeply interested in tree visualization,
    you can directly skip to the example below.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE31]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE32]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE33]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE34]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE35]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE36]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE37]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE38]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE39]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE40]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE41]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE42]'
  prefs: []
  type: TYPE_PRE
- en: While we are interested at present in visualizing a `derivation_tree`, it is
    in our interest to generalize the visualization procedure. In particular, it would
    be helpful if our method `display_tree()` can display *any* tree like data structure.
    To enable this, we define a helper method `extract_node()` that extract the current
    symbol and children from a given data structure. The default implementation simply
    extracts the symbol, children, and annotation from any `derivation_tree` node.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE43]'
  prefs: []
  type: TYPE_PRE
- en: While visualizing a tree, it is often useful to display certain nodes differently.
    For example, it is sometimes useful to distinguish between non-processed nodes
    and processed nodes. We define a helper procedure `default_node_attr()` that provides
    the basic display, which can be customized by the user.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE44]'
  prefs: []
  type: TYPE_PRE
- en: Similar to nodes, the edges may also require modifications. We define `default_edge_attr()`
    as a helper procedure that can be customized by the user.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE45]'
  prefs: []
  type: TYPE_PRE
- en: While visualizing a tree, one may sometimes wish to change the appearance of
    the tree. For example, it is sometimes easier to view the tree if it was laid
    out left to right rather than top to bottom. We define another helper procedure
    `default_graph_attr()` for that.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE46]'
  prefs: []
  type: TYPE_PRE
- en: Finally, we define a method `display_tree()` that accepts these four functions
    `extract_node()`, `default_edge_attr()`, `default_node_attr()` and `default_graph_attr()`
    and uses them to display the tree.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE47]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is what our tree visualizes into:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE48]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="142pt" height="123pt" viewBox="0.00 0.00 142.25 122.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 118.75)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-101.45" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="66.25"
    y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="20.25" y="-0.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-0.95" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: Quiz
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: And which of these is the internal representation of `derivation_tree`?
  prefs: []
  type: TYPE_NORMAL
- en: 'You can check it out yourself:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE49]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE50]'
  prefs: []
  type: TYPE_PRE
- en: Within this book, we also occasionally use a function `display_annotated_tree()`
    which allows adding annotations to individual nodes.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-Source-code-and-example-for-display_annotated_tree()"><summary>Source
    code and example for `display_annotated_tree()`</summary>
  prefs: []
  type: TYPE_NORMAL
- en: '`display_annotated_tree()` displays an annotated tree structure, and lays out
    the graph left to right.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE51]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE52]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="226pt" height="87pt" viewBox="0.00 0.00 225.75 87.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 83.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="19.88"
    y="-33.95" font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="97" y="-33.95" font-family="Times,serif"
    font-size="14.00"><expr></text></g> <g id="edge1" class="edge"><title>0->1</title></g>
    <g id="node3" class="node"><title>2</title> <text text-anchor="middle" x="192.25"
    y="-65.95" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge2"
    class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="192.25" y="-33.95" font-family="Times,serif" font-size="14.00">+
     (plus)</text></g> <g id="edge3" class="edge"><title>1->3</title> <text text-anchor="middle"
    x="142" y="-41.08" font-family="Times,serif" font-size="14.00">op</text></g> <g
    id="node5" class="node"><title>4</title> <text text-anchor="middle" x="192.25"
    y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g> <g id="edge4"
    class="edge"><title>1->4</title></g></g></svg></details>
  prefs: []
  type: TYPE_NORMAL
- en: 'If we want to see all the leaf nodes in a tree as a string, the following `all_terminals()`
    function comes in handy:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE53]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE54]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE55]'
  prefs: []
  type: TYPE_PRE
- en: The alternative `tree_to_string()` function also converts the tree to a string;
    however, it replaces nonterminal symbols by empty strings.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE56]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE57]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE58]'
  prefs: []
  type: TYPE_PRE
- en: Expanding a Node
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Let us now develop an algorithm that takes a tree with non-expanded symbols
    (say, `derivation_tree`, above), and expands all these symbols one after the other.
    As with earlier fuzzers, we create a special subclass of `Fuzzer` – in this case,
    `GrammarFuzzer`. A `GrammarFuzzer` gets a grammar and a start symbol; the other
    parameters will be used later to further control creation and to support debugging.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE59]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE60]'
  prefs: []
  type: TYPE_PRE
- en: To add further methods to `GrammarFuzzer`, we use the hack already introduced
    for [the `MutationFuzzer` class](MutationFuzzer.html). The construct
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE61]'
  prefs: []
  type: TYPE_PRE
- en: allows us to add a new method `new_method()` to the `GrammarFuzzer` class. (Actually,
    we get a new `GrammarFuzzer` class that extends the old one, but for all our purposes,
    this does not matter.)
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-check_grammar()-implementation"><summary>`check_grammar()`
    implementation</summary>
  prefs: []
  type: TYPE_NORMAL
- en: 'We can use the above hack to define the helper method `check_grammar()`, which
    checks the given grammar for consistency:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE62]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us now define a helper method `init_tree()` that constructs a tree with
    just the start symbol:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE63]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE64]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="48pt" height="22pt" viewBox="0.00 0.00 47.75 22.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 18.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="19.88"
    y="-0.95" font-family="Times,serif" font-size="14.00"><start></text></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: This is the tree we want to expand.
  prefs: []
  type: TYPE_NORMAL
- en: Picking a Children Alternative to be Expanded
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: One of the central methods in `GrammarFuzzer` is `choose_node_expansion()`.
    This method gets a node (say, the `<start>` node) and a list of possible lists
    of children to be expanded (one for every possible expansion from the grammar),
    chooses one of them, and returns its index in the possible children list.
  prefs: []
  type: TYPE_NORMAL
- en: By overloading this method (notably in later chapters), we can implement different
    strategies – for now, it simply randomly picks one of the given lists of children
    (which in turn are lists of derivation trees).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE65]'
  prefs: []
  type: TYPE_PRE
- en: Getting a List of Possible Expansions
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: To actually obtain the list of possible children, we will need a helper function
    `expansion_to_children()` that takes an expansion string and decomposes it into
    a list of derivation trees – one for each symbol (terminal or nonterminal) in
    the string.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-Implementing-expansion_to_children()"><summary>Implementing
    `expansion_to_children()`</summary>
  prefs: []
  type: TYPE_NORMAL
- en: 'The function `expansion_to_children()` uses the `re.split()` method to split
    an expansion string into a list of children nodes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE66]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE67]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE68]'
  prefs: []
  type: TYPE_PRE
- en: 'The case of an *epsilon expansion*, i.e. expanding into an empty string as
    in `<symbol> ::=` needs special treatment:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE69]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE70]'
  prefs: []
  type: TYPE_PRE
- en: Just like `nonterminals()` in the [chapter on Grammars](Grammars.html), we provide
    for future extensions, allowing the expansion to be a tuple with extra data (which
    will be ignored).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE71]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE72]'
  prefs: []
  type: TYPE_PRE
- en: 'We realize this helper as a method in `GrammarFuzzer` such that it can be overloaded
    by subclasses:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE73]'
  prefs: []
  type: TYPE_PRE
- en: Putting Things Together
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: With this, we can now take
  prefs: []
  type: TYPE_NORMAL
- en: some non-expanded node in the tree,
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: choose a random expansion, and
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: return the new tree.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: This is what the method `expand_node_randomly()` does.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-expand_node_randomly()-implementation"><summary>`expand_node_randomly()`
    implementation</summary>
  prefs: []
  type: TYPE_NORMAL
- en: The function `expand_node_randomly()` uses a helper function `choose_node_expansion()`
    to randomly pick an index from an array of possible children. (`choose_node_expansion()`
    can be overloaded in subclasses.)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE74]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE75]'
  prefs: []
  type: TYPE_PRE
- en: The generic `expand_node()` method can later be used to select different expansion
    strategies; as of now, it only uses `expand_node_randomly()`.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE76]'
  prefs: []
  type: TYPE_PRE
- en: The helper function `process_chosen_children()` does nothing; it can be overloaded
    by subclasses to process the children once chosen.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE77]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: 'This is how `expand_node_randomly()` works:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE78]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE79]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="62pt" height="22pt" viewBox="0.00 0.00 62.00 22.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 18.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="27" y="-0.95"
    font-family="Times,serif" font-size="14.00"><integer></text></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE80]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE81]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="62pt" height="73pt" viewBox="0.00 0.00 62.00 72.50" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 68.5)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="27" y="-51.2"
    font-family="Times,serif" font-size="14.00"><integer></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="27" y="-0.95" font-family="Times,serif"
    font-size="14.00"><digit></text></g> <g id="edge1" class="edge"><title>0->1</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: Quiz
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: What tree do we get if we expand the `<digit>` subtree?
  prefs: []
  type: TYPE_NORMAL
- en: 'We can surely put this to the test, right? Here we go:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE82]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="49pt" height="22pt" viewBox="0.00 0.00 49.25 22.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 18.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="20.62"
    y="-0.95" font-family="Times,serif" font-size="14.00"><digit></text></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE83]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE84]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="49pt" height="73pt" viewBox="0.00 0.00 49.25 72.50" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 68.5)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="20.62"
    y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="20.62" y="-0.95" font-family="Times,serif"
    font-size="14.00">7 (55)</text></g> <g id="edge1" class="edge"><title>0->1</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We see that `<digit>` gets expanded again according to the grammar rules – namely,
    into a single digit.
  prefs: []
  type: TYPE_NORMAL
- en: Quiz
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Is the original `expr_tree` affected by this change?
  prefs: []
  type: TYPE_NORMAL
- en: 'Although we have changed one of the subtrees, the original `expr_tree` is unaffected:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE85]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="62pt" height="73pt" viewBox="0.00 0.00 62.00 72.50" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 68.5)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="27" y="-51.2"
    font-family="Times,serif" font-size="14.00"><integer></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="27" y="-0.95" font-family="Times,serif"
    font-size="14.00"><digit></text></g> <g id="edge1" class="edge"><title>0->1</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: That is because `expand_node_randomly()` returns a new (expanded) tree and does
    not change the tree passed as argument.
  prefs: []
  type: TYPE_NORMAL
- en: Expanding a Tree
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let us now apply our functions for expanding a single node to some node in
    the tree. To this end, we first need to *search the tree for non-expanded nodes*.
    `possible_expansions()` counts how many unexpanded symbols there are in a tree:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE86]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE87]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE88]'
  prefs: []
  type: TYPE_PRE
- en: The method `any_possible_expansions()` returns True if the tree has any non-expanded
    nodes.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE89]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE90]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE91]'
  prefs: []
  type: TYPE_PRE
- en: Here comes `expand_tree_once()`, the core method of our tree expansion algorithm.
    It first checks whether it is currently being applied on a nonterminal symbol
    without expansion; if so, it invokes `expand_node()` on it, as discussed above.
  prefs: []
  type: TYPE_NORMAL
- en: If the node is already expanded (i.e. has children), it checks the subset of
    children which still have non-expanded symbols, randomly selects one of them,
    and applies itself recursively on that child.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-expand_tree_once()-implementation"><summary>`expand_tree_once()`
    implementation</summary>
  prefs: []
  type: TYPE_NORMAL
- en: The `expand_tree_once()` method replaces the child *in place*, meaning that
    it actually mutates the tree being passed as an argument rather than returning
    a new tree. This in-place mutation is what makes this function particularly efficient.
    Again, we use a helper method (`choose_tree_expansion()`) to return the chosen
    index from a list of children that can be expanded.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE92]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: Let us illustrate how `expand_tree_once()` works. We start with our derivation
    tree from above...
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE93]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="142pt" height="123pt" viewBox="0.00 0.00 142.25 122.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 118.75)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-101.45" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="66.25"
    y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="20.25" y="-0.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-0.95" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '... and now expand it twice:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE94]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE95]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="143pt" height="173pt" viewBox="0.00 0.00 143.00 173.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 169)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="67" y="-151.7"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="67" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="21" y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="67" y="-51.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="114" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="21" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE96]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE97]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="208pt" height="173pt" viewBox="0.00 0.00 208.00 173.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 169)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="81" y="-151.7"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="81" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="30" y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="81" y="-51.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="130" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="21" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="84" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge6" class="edge"><title>5->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="133" y="-0.95" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge7" class="edge"><title>5->7</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="179" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge8" class="edge"><title>5->8</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We see that with each step, one more symbol is expanded. Now all it takes is
    to apply this again and again, expanding the tree further and further.
  prefs: []
  type: TYPE_NORMAL
- en: Closing the Expansion
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: With `expand_tree_once()`, we can keep on expanding the tree – but how do we
    actually stop? The key idea here, introduced by Luke in [[Luke *et al*, 2000](https://doi.org/10.1109/4235.873237)],
    is that after inflating the derivation tree to some maximum size, we *only want
    to apply expansions that increase the size of the tree by a minimum*. For `<factor>`,
    for instance, we would prefer an expansion into `<integer>`, as this will not
    introduce further recursion (and potential size inflation); for `<integer>`, likewise,
    an expansion into `<digit>` is preferred, as it will less increase tree size than
    `<digit><integer>`.
  prefs: []
  type: TYPE_NORMAL
- en: 'To identify the *cost* of expanding a symbol, we introduce two functions that
    mutually rely on each other:'
  prefs: []
  type: TYPE_NORMAL
- en: '`symbol_cost()` returns the minimum cost of all expansions of a symbol, using
    `expansion_cost()` to compute the cost for each expansion.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '`expansion_cost()` returns the sum of all expansions in `expansions`. If a
    nonterminal is encountered again during traversal, the cost of the expansion is
    $\infty$, indicating (potentially infinite) recursion.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: <details id="Excursion:-Implementing-Cost-Functions"><summary>Implementing Cost
    Functions</summary>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE98]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: 'Here are two examples: The minimum cost of expanding a digit is 1, since we
    have to choose from one of its expansions.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE99]'
  prefs: []
  type: TYPE_PRE
- en: The minimum cost of expanding `<expr>`, though, is five, as this is the minimum
    number of expansions required. (`<expr>` $\rightarrow$ `<term>` $\rightarrow$
    `<factor>` $\rightarrow$ `<integer>` $\rightarrow$ `<digit>` $\rightarrow$ 1)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE100]'
  prefs: []
  type: TYPE_PRE
- en: We define `expand_node_by_cost(self, node, choose)`, a variant of `expand_node()`
    that takes the above cost into account. It determines the minimum cost `cost`
    across all children and then chooses a child from the list using the `choose`
    function, which by default is the minimum cost. If multiple children all have
    the same minimum cost, it chooses randomly between these.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-expand_node_by_cost()-implementation"><summary>`expand_node_by_cost()`
    implementation</summary>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE101]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: The shortcut `expand_node_min_cost()` passes `min()` as the `choose` function,
    which makes it expand nodes at minimum cost.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE102]'
  prefs: []
  type: TYPE_PRE
- en: We can now apply this function to close the expansion of our derivation tree,
    using `expand_tree_once()` with the above `expand_node_min_cost()` as expansion
    function.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE103]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE104]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="208pt" height="173pt" viewBox="0.00 0.00 208.00 173.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 169)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="81" y="-151.7"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="81" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="30" y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="81" y="-51.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="130" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="21" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="84" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge6" class="edge"><title>5->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="133" y="-0.95" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge7" class="edge"><title>5->7</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="179" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge8" class="edge"><title>5->8</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE105]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE106]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="211pt" height="223pt" viewBox="0.00 0.00 211.00 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="84" y="-201.95"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="84" y="-151.7" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="33" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="84" y="-101.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="133" y="-101.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge6" class="edge"><title>1->6</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="24" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="24" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="87" y="-51.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge7" class="edge"><title>6->7</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="136" y="-51.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge8" class="edge"><title>6->8</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="182" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge9" class="edge"><title>6->9</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE107]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE108]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="215pt" height="223pt" viewBox="0.00 0.00 215.00 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="87" y="-201.95"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="87" y="-151.7" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="36" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="87" y="-101.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="136" y="-101.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge6" class="edge"><title>1->6</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="27" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="24" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="91" y="-51.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge7" class="edge"><title>6->7</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="140" y="-51.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge9" class="edge"><title>6->9</title></g> <g id="node11" class="node"><title>10</title>
    <text text-anchor="middle" x="186" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge10" class="edge"><title>6->10</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="93" y="-0.95" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge8" class="edge"><title>7->8</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE109]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE110]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="218pt" height="223pt" viewBox="0.00 0.00 218.00 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="87" y="-201.95"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="87" y="-151.7" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="36" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="87" y="-101.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="136" y="-101.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge6" class="edge"><title>1->6</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="27" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="24" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="91" y="-51.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge7" class="edge"><title>6->7</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="140" y="-51.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge9" class="edge"><title>6->9</title></g> <g id="node11" class="node"><title>10</title>
    <text text-anchor="middle" x="186" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge10" class="edge"><title>6->10</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="93" y="-0.95" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge8" class="edge"><title>7->8</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="186" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge11" class="edge"><title>10->11</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We keep on expanding until all nonterminals are expanded.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE111]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE112]'
  prefs: []
  type: TYPE_PRE
- en: 'Here is the final tree:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE113]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="224pt" height="374pt" viewBox="0.00 0.00 224.00 374.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 370)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="90" y="-352.7"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="90" y="-302.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="39" y="-252.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="90" y="-252.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge8" class="edge"><title>1->8</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="139" y="-252.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge9" class="edge"><title>1->9</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="30" y="-201.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="27" y="-151.7" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="27" y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge5" class="edge"><title>4->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="27" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge6" class="edge"><title>5->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="27" y="-0.95" font-family="Times,serif" font-size="14.00">7
    (55)</text></g> <g id="edge7" class="edge"><title>6->7</title></g> <g id="node11"
    class="node"><title>10</title> <text text-anchor="middle" x="94" y="-201.95" font-family="Times,serif"
    font-size="14.00"><factor></text></g> <g id="edge10" class="edge"><title>9->10</title></g>
    <g id="node15" class="node"><title>14</title> <text text-anchor="middle" x="143"
    y="-201.95" font-family="Times,serif" font-size="14.00">*</text></g> <g id="edge14"
    class="edge"><title>9->14</title></g> <g id="node16" class="node"><title>15</title>
    <text text-anchor="middle" x="189" y="-201.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge15" class="edge"><title>9->15</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="96" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge11" class="edge"><title>10->11</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="96" y="-101.45" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge12" class="edge"><title>11->12</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="96" y="-51.2" font-family="Times,serif" font-size="14.00">5
    (53)</text></g> <g id="edge13" class="edge"><title>12->13</title></g> <g id="node17"
    class="node"><title>16</title> <text text-anchor="middle" x="189" y="-151.7" font-family="Times,serif"
    font-size="14.00"><factor></text></g> <g id="edge16" class="edge"><title>15->16</title></g>
    <g id="node18" class="node"><title>17</title> <text text-anchor="middle" x="189"
    y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g> <g
    id="edge17" class="edge"><title>16->17</title></g> <g id="node19" class="node"><title>18</title>
    <text text-anchor="middle" x="189" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge18" class="edge"><title>17->18</title></g> <g id="node20" class="node"><title>19</title>
    <text text-anchor="middle" x="189" y="-0.95" font-family="Times,serif" font-size="14.00">8
    (56)</text></g> <g id="edge19" class="edge"><title>18->19</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We see that in each step, `expand_node_min_cost()` chooses an expansion that
    does not increase the number of symbols, eventually closing all open expansions.
  prefs: []
  type: TYPE_NORMAL
- en: Node Inflation
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Especially at the beginning of an expansion, we may be interested in getting
    *as many nodes as possible* – that is, we''d like to prefer expansions that give
    us *more* nonterminals to expand. This is actually the exact opposite of what
    `expand_node_min_cost()` gives us, and we can implement a method `expand_node_max_cost()`
    that will always choose among the nodes with the *highest* cost:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE114]'
  prefs: []
  type: TYPE_PRE
- en: 'To illustrate `expand_node_max_cost()`, we can again redefine `expand_node()`
    to use it, and then use `expand_tree_once()` to show a few expansion steps:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE115]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE116]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE117]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="142pt" height="123pt" viewBox="0.00 0.00 142.25 122.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 118.75)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-101.45" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="66.25"
    y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="20.25" y="-0.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-0.95" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE118]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE119]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="188pt" height="173pt" viewBox="0.00 0.00 188.25 173.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 169)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-151.7" font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="66.25" y="-101.45"
    font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1" class="edge"><title>0->1</title></g>
    <g id="node3" class="node"><title>2</title> <text text-anchor="middle" x="20.25"
    y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge2"
    class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-51.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="64.25" y="-0.95" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge5" class="edge"><title>4->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="113.25" y="-0.95" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge6" class="edge"><title>4->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="159.25" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge7" class="edge"><title>4->7</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE120]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE121]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="188pt" height="223pt" viewBox="0.00 0.00 188.25 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-201.95" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="66.25"
    y="-151.7" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="20.25" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-101.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-101.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="64.25" y="-51.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge5" class="edge"><title>4->5</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="113.25" y="-51.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge8" class="edge"><title>4->8</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="159.25" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge9" class="edge"><title>4->9</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="36.25" y="-0.95" font-family="Times,serif" font-size="14.00">-
    (45)</text></g> <g id="edge6" class="edge"><title>5->6</title></g> <g id="node8"
    class="node"><title>7</title> <text text-anchor="middle" x="93.25" y="-0.95" font-family="Times,serif"
    font-size="14.00"><factor></text></g> <g id="edge7" class="edge"><title>5->7</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE122]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE123]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="300pt" height="223pt" viewBox="0.00 0.00 300.00 223.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 219.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="146" y="-201.95"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="146" y="-151.7" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="93" y="-101.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="146" y="-101.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge6" class="edge"><title>1->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="197" y="-101.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge7" class="edge"><title>1->7</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="21" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="68" y="-51.2" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge4" class="edge"><title>2->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="114" y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge5" class="edge"><title>2->5</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="176" y="-51.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge8" class="edge"><title>7->8</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="225" y="-51.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge11" class="edge"><title>7->11</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="271" y="-51.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge12" class="edge"><title>7->12</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="147" y="-0.95" font-family="Times,serif" font-size="14.00">-
    (45)</text></g> <g id="edge9" class="edge"><title>8->9</title></g> <g id="node11"
    class="node"><title>10</title> <text text-anchor="middle" x="204" y="-0.95" font-family="Times,serif"
    font-size="14.00"><factor></text></g> <g id="edge10" class="edge"><title>8->10</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We see that with each step, the number of nonterminals increases. Obviously,
    we have to put a limit on this number.
  prefs: []
  type: TYPE_NORMAL
- en: Three Expansion Phases
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'We can now put all three phases together in a single function `expand_tree()`
    which will work as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Max cost expansion.** Expand the tree using expansions with maximum cost
    until we have at least `min_nonterminals` nonterminals. This phase can be easily
    skipped by setting `min_nonterminals` to zero.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Random expansion.** Keep on expanding the tree randomly until we reach `max_nonterminals`
    nonterminals.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Min cost expansion.** Close the expansion with minimum cost.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: We implement these three phases by having `expand_node` reference the expansion
    method to apply. This is controlled by setting `expand_node` (the method reference)
    to first `expand_node_max_cost` (i.e., calling `expand_node()` invokes `expand_node_max_cost()`),
    then `expand_node_randomly`, and finally `expand_node_min_cost`. In the first
    two phases, we also set a maximum limit of `min_nonterminals` and `max_nonterminals`,
    respectively.
  prefs: []
  type: TYPE_NORMAL
- en: <details id="Excursion:-Implementation-of-three-phase-expand_tree()"><summary>Implementation
    of three-phase `expand_tree()`</summary>
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE124]</details>'
  prefs: []
  type: TYPE_NORMAL
- en: 'Let us try this out on our example. We start with a half-expanded derivation
    tree:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE125]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE126]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="142pt" height="123pt" viewBox="0.00 0.00 142.25 122.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 118.75)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="66.25"
    y="-101.45" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="66.25"
    y="-51.2" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="20.25" y="-0.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="66.25" y="-0.95" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge3" class="edge"><title>1->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="113.25" y="-0.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge4" class="edge"><title>1->4</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: We now apply our expansion strategy on this tree. We see that initially, nodes
    are expanded at maximum cost, then randomly, and then closing the expansion at
    minimum cost.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE127]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE128]'
  prefs: []
  type: TYPE_PRE
- en: 'This is the final derivation tree:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE129]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="360pt" height="475pt" viewBox="0.00 0.00 359.62 474.50" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 470.5)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="236" y="-453.2"
    font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2" class="node"><title>1</title>
    <text text-anchor="middle" x="236" y="-402.95" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge1" class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="186" y="-352.7" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node28" class="node"><title>27</title>
    <text text-anchor="middle" x="236" y="-352.7" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge27" class="edge"><title>1->27</title></g> <g id="node29" class="node"><title>28</title>
    <text text-anchor="middle" x="285" y="-352.7" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge28" class="edge"><title>1->28</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="111" y="-302.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node15" class="node"><title>14</title>
    <text text-anchor="middle" x="179" y="-302.45" font-family="Times,serif" font-size="14.00">+</text></g>
    <g id="edge14" class="edge"><title>2->14</title></g> <g id="node16" class="node"><title>15</title>
    <text text-anchor="middle" x="225" y="-302.45" font-family="Times,serif" font-size="14.00"><expr></text></g>
    <g id="edge15" class="edge"><title>2->15</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="27" y="-252.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="75" y="-252.2" font-family="Times,serif" font-size="14.00">/</text></g>
    <g id="edge8" class="edge"><title>3->8</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="120" y="-252.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge9" class="edge"><title>3->9</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="27" y="-201.95" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge5" class="edge"><title>4->5</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="27" y="-151.7" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge6" class="edge"><title>5->6</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="27" y="-101.45" font-family="Times,serif" font-size="14.00">7
    (55)</text></g> <g id="edge7" class="edge"><title>6->7</title></g> <g id="node11"
    class="node"><title>10</title> <text text-anchor="middle" x="107" y="-201.95"
    font-family="Times,serif" font-size="14.00"><factor></text></g> <g id="edge10"
    class="edge"><title>9->10</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="106" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge11" class="edge"><title>10->11</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="106" y="-101.45" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge12" class="edge"><title>11->12</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="106" y="-51.2" font-family="Times,serif" font-size="14.00">5
    (53)</text></g> <g id="edge13" class="edge"><title>12->13</title></g> <g id="node17"
    class="node"><title>16</title> <text text-anchor="middle" x="225" y="-252.2" font-family="Times,serif"
    font-size="14.00"><term></text></g> <g id="edge16" class="edge"><title>15->16</title></g>
    <g id="node18" class="node"><title>17</title> <text text-anchor="middle" x="176"
    y="-201.95" font-family="Times,serif" font-size="14.00"><factor></text></g> <g
    id="edge17" class="edge"><title>16->17</title></g> <g id="node22" class="node"><title>21</title>
    <text text-anchor="middle" x="225" y="-201.95" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge21" class="edge"><title>16->21</title></g> <g id="node23" class="node"><title>22</title>
    <text text-anchor="middle" x="271" y="-201.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge22" class="edge"><title>16->22</title></g> <g id="node19" class="node"><title>18</title>
    <text text-anchor="middle" x="178" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge18" class="edge"><title>17->18</title></g> <g id="node20" class="node"><title>19</title>
    <text text-anchor="middle" x="178" y="-101.45" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge19" class="edge"><title>18->19</title></g> <g id="node21" class="node"><title>20</title>
    <text text-anchor="middle" x="178" y="-51.2" font-family="Times,serif" font-size="14.00">4
    (52)</text></g> <g id="edge20" class="edge"><title>19->20</title></g> <g id="node24"
    class="node"><title>23</title> <text text-anchor="middle" x="271" y="-151.7" font-family="Times,serif"
    font-size="14.00"><factor></text></g> <g id="edge23" class="edge"><title>22->23</title></g>
    <g id="node25" class="node"><title>24</title> <text text-anchor="middle" x="271"
    y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g> <g
    id="edge24" class="edge"><title>23->24</title></g> <g id="node26" class="node"><title>25</title>
    <text text-anchor="middle" x="271" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge25" class="edge"><title>24->25</title></g> <g id="node27" class="node"><title>26</title>
    <text text-anchor="middle" x="271" y="-0.95" font-family="Times,serif" font-size="14.00">2
    (50)</text></g> <g id="edge26" class="edge"><title>25->26</title></g> <g id="node30"
    class="node"><title>29</title> <text text-anchor="middle" x="289" y="-302.45"
    font-family="Times,serif" font-size="14.00"><factor></text></g> <g id="edge29"
    class="edge"><title>28->29</title></g> <g id="node31" class="node"><title>30</title>
    <text text-anchor="middle" x="311" y="-252.2" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge30" class="edge"><title>29->30</title></g> <g id="node32" class="node"><title>31</title>
    <text text-anchor="middle" x="331" y="-201.95" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge31" class="edge"><title>30->31</title></g> <g id="node33" class="node"><title>32</title>
    <text text-anchor="middle" x="331" y="-151.7" font-family="Times,serif" font-size="14.00">0
    (48)</text></g> <g id="edge32" class="edge"><title>31->32</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: 'And this is the resulting string:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE130]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE131]'
  prefs: []
  type: TYPE_PRE
- en: Putting it all Together
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Based on this, we can now define a function `fuzz()` that – like `simple_grammar_fuzzer()`
    – simply takes a grammar and produces a string from it. It thus no longer exposes
    the complexity of derivation trees.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE132]'
  prefs: []
  type: TYPE_PRE
- en: We can now apply this on all our defined grammars (and visualize the derivation
    tree along)
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE133]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE134]'
  prefs: []
  type: TYPE_PRE
- en: 'After calling `fuzz()`, the produced derivation tree is accessible in the `derivation_tree`
    attribute:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE135]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="518pt" height="424pt" viewBox="0.00 0.00 517.62 424.25" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 420.25)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="274.62"
    y="-402.95" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="274.62"
    y="-352.7" font-family="Times,serif" font-size="14.00"><expr></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="274.62" y="-302.45" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="160.62" y="-252.2" font-family="Times,serif" font-size="14.00"><factor></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node15" class="node"><title>14</title>
    <text text-anchor="middle" x="274.62" y="-252.2" font-family="Times,serif" font-size="14.00">*</text></g>
    <g id="edge14" class="edge"><title>2->14</title></g> <g id="node16" class="node"><title>15</title>
    <text text-anchor="middle" x="335.62" y="-252.2" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge15" class="edge"><title>2->15</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="70.62" y="-201.95" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge4" class="edge"><title>3->4</title></g> <g id="node11" class="node"><title>10</title>
    <text text-anchor="middle" x="130.62" y="-201.95" font-family="Times,serif" font-size="14.00">.
    (46)</text></g> <g id="edge10" class="edge"><title>3->10</title></g> <g id="node12"
    class="node"><title>11</title> <text text-anchor="middle" x="190.62" y="-201.95"
    font-family="Times,serif" font-size="14.00"><integer></text></g> <g id="edge11"
    class="edge"><title>3->11</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="20.62" y="-151.7" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge5" class="edge"><title>4->5</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="86.62" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge7" class="edge"><title>4->7</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="20.62" y="-101.45" font-family="Times,serif" font-size="14.00">1
    (49)</text></g> <g id="edge6" class="edge"><title>5->6</title></g> <g id="node9"
    class="node"><title>8</title> <text text-anchor="middle" x="86.62" y="-101.45"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge8" class="edge"><title>7->8</title></g>
    <g id="node10" class="node"><title>9</title> <text text-anchor="middle" x="86.62"
    y="-51.2" font-family="Times,serif" font-size="14.00">8 (56)</text></g> <g id="edge9"
    class="edge"><title>8->9</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="174.62" y="-151.7" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge12" class="edge"><title>11->12</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="157.62" y="-101.45" font-family="Times,serif" font-size="14.00">3
    (51)</text></g> <g id="edge13" class="edge"><title>12->13</title></g> <g id="node17"
    class="node"><title>16</title> <text text-anchor="middle" x="311.62" y="-201.95"
    font-family="Times,serif" font-size="14.00"><factor></text></g> <g id="edge16"
    class="edge"><title>15->16</title></g> <g id="node31" class="node"><title>30</title>
    <text text-anchor="middle" x="359.62" y="-201.95" font-family="Times,serif" font-size="14.00">/</text></g>
    <g id="edge30" class="edge"><title>15->30</title></g> <g id="node32" class="node"><title>31</title>
    <text text-anchor="middle" x="422.62" y="-201.95" font-family="Times,serif" font-size="14.00"><term></text></g>
    <g id="edge31" class="edge"><title>15->31</title></g> <g id="node18" class="node"><title>17</title>
    <text text-anchor="middle" x="251.62" y="-151.7" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge17" class="edge"><title>16->17</title></g> <g id="node24" class="node"><title>23</title>
    <text text-anchor="middle" x="311.62" y="-151.7" font-family="Times,serif" font-size="14.00">.
    (46)</text></g> <g id="edge23" class="edge"><title>16->23</title></g> <g id="node25"
    class="node"><title>24</title> <text text-anchor="middle" x="371.62" y="-151.7"
    font-family="Times,serif" font-size="14.00"><integer></text></g> <g id="edge24"
    class="edge"><title>16->24</title></g> <g id="node19" class="node"><title>18</title>
    <text text-anchor="middle" x="212.62" y="-101.45" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge18" class="edge"><title>17->18</title></g> <g id="node21" class="node"><title>20</title>
    <text text-anchor="middle" x="278.62" y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge20" class="edge"><title>17->20</title></g> <g id="node20" class="node"><title>19</title>
    <text text-anchor="middle" x="212.62" y="-51.2" font-family="Times,serif" font-size="14.00">2
    (50)</text></g> <g id="edge19" class="edge"><title>18->19</title></g> <g id="node22"
    class="node"><title>21</title> <text text-anchor="middle" x="278.62" y="-51.2"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge21"
    class="edge"><title>20->21</title></g> <g id="node23" class="node"><title>22</title>
    <text text-anchor="middle" x="278.62" y="-0.95" font-family="Times,serif" font-size="14.00">1
    (49)</text></g> <g id="edge22" class="edge"><title>21->22</title></g> <g id="node26"
    class="node"><title>25</title> <text text-anchor="middle" x="344.62" y="-101.45"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge25"
    class="edge"><title>24->25</title></g> <g id="node28" class="node"><title>27</title>
    <text text-anchor="middle" x="410.62" y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge27" class="edge"><title>24->27</title></g> <g id="node27" class="node"><title>26</title>
    <text text-anchor="middle" x="344.62" y="-51.2" font-family="Times,serif" font-size="14.00">9
    (57)</text></g> <g id="edge26" class="edge"><title>25->26</title></g> <g id="node29"
    class="node"><title>28</title> <text text-anchor="middle" x="410.62" y="-51.2"
    font-family="Times,serif" font-size="14.00"><digit></text></g> <g id="edge28"
    class="edge"><title>27->28</title></g> <g id="node30" class="node"><title>29</title>
    <text text-anchor="middle" x="410.62" y="-0.95" font-family="Times,serif" font-size="14.00">5
    (53)</text></g> <g id="edge29" class="edge"><title>28->29</title></g> <g id="node33"
    class="node"><title>32</title> <text text-anchor="middle" x="453.62" y="-151.7"
    font-family="Times,serif" font-size="14.00"><factor></text></g> <g id="edge32"
    class="edge"><title>31->32</title></g> <g id="node34" class="node"><title>33</title>
    <text text-anchor="middle" x="482.62" y="-101.45" font-family="Times,serif" font-size="14.00"><integer></text></g>
    <g id="edge33" class="edge"><title>32->33</title></g> <g id="node35" class="node"><title>34</title>
    <text text-anchor="middle" x="482.62" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge34" class="edge"><title>33->34</title></g> <g id="node36" class="node"><title>35</title>
    <text text-anchor="middle" x="482.62" y="-0.95" font-family="Times,serif" font-size="14.00">0
    (48)</text></g> <g id="edge35" class="edge"><title>34->35</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: Let us try out the grammar fuzzer (and its trees) on other grammar formats.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE136]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE137]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE138]'
  prefs: []
  type: TYPE_PRE
- en: '<svg width="573pt" height="324pt" viewBox="0.00 0.00 573.00 323.75" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 319.75)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="214.5"
    y="-302.45" font-family="Times,serif" font-size="14.00"><start></text></g> <g
    id="node2" class="node"><title>1</title> <text text-anchor="middle" x="214.5"
    y="-252.2" font-family="Times,serif" font-size="14.00"><url></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="69.5" y="-201.95" font-family="Times,serif" font-size="14.00"><scheme></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="158.5" y="-201.95" font-family="Times,serif" font-size="14.00">://</text></g>
    <g id="edge4" class="edge"><title>1->4</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="214.5" y="-201.95" font-family="Times,serif" font-size="14.00"><authority></text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node19" class="node"><title>18</title>
    <text text-anchor="middle" x="345.5" y="-201.95" font-family="Times,serif" font-size="14.00"><path></text></g>
    <g id="edge18" class="edge"><title>1->18</title></g> <g id="node23" class="node"><title>22</title>
    <text text-anchor="middle" x="440.5" y="-201.95" font-family="Times,serif" font-size="14.00"><query></text></g>
    <g id="edge22" class="edge"><title>1->22</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="7.5" y="-151.7" font-family="Times,serif" font-size="14.00">ftp</text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node7" class="node"><title>6</title>
    <text text-anchor="middle" x="63.5" y="-151.7" font-family="Times,serif" font-size="14.00"><userinfo></text></g>
    <g id="edge6" class="edge"><title>5->6</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="131.5" y="-151.7" font-family="Times,serif" font-size="14.00">@
    (64)</text></g> <g id="edge8" class="edge"><title>5->8</title></g> <g id="node10"
    class="node"><title>9</title> <text text-anchor="middle" x="188.5" y="-151.7"
    font-family="Times,serif" font-size="14.00"><host></text></g> <g id="edge9" class="edge"><title>5->9</title></g>
    <g id="node12" class="node"><title>11</title> <text text-anchor="middle" x="241.5"
    y="-151.7" font-family="Times,serif" font-size="14.00">: (58)</text></g> <g id="edge11"
    class="edge"><title>5->11</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="293.5" y="-151.7" font-family="Times,serif" font-size="14.00"><port></text></g>
    <g id="edge12" class="edge"><title>5->12</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="63.5" y="-101.45" font-family="Times,serif" font-size="14.00">user:password</text></g>
    <g id="edge7" class="edge"><title>6->7</title></g> <g id="node11" class="node"><title>10</title>
    <text text-anchor="middle" x="188.5" y="-101.45" font-family="Times,serif" font-size="14.00">www.google.com</text></g>
    <g id="edge10" class="edge"><title>9->10</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="293.5" y="-101.45" font-family="Times,serif" font-size="14.00"><nat></text></g>
    <g id="edge13" class="edge"><title>12->13</title></g> <g id="node15" class="node"><title>14</title>
    <text text-anchor="middle" x="263.5" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge14" class="edge"><title>13->14</title></g> <g id="node17" class="node"><title>16</title>
    <text text-anchor="middle" x="322.5" y="-51.2" font-family="Times,serif" font-size="14.00"><digit></text></g>
    <g id="edge16" class="edge"><title>13->16</title></g> <g id="node16" class="node"><title>15</title>
    <text text-anchor="middle" x="263.5" y="-0.95" font-family="Times,serif" font-size="14.00">5
    (53)</text></g> <g id="edge15" class="edge"><title>14->15</title></g> <g id="node18"
    class="node"><title>17</title> <text text-anchor="middle" x="322.5" y="-0.95"
    font-family="Times,serif" font-size="14.00">3 (51)</text></g> <g id="edge17" class="edge"><title>16->17</title></g>
    <g id="node20" class="node"><title>19</title> <text text-anchor="middle" x="345.5"
    y="-151.7" font-family="Times,serif" font-size="14.00">/ (47)</text></g> <g id="edge19"
    class="edge"><title>18->19</title></g> <g id="node21" class="node"><title>20</title>
    <text text-anchor="middle" x="392.5" y="-151.7" font-family="Times,serif" font-size="14.00"><id></text></g>
    <g id="edge20" class="edge"><title>18->20</title></g> <g id="node22" class="node"><title>21</title>
    <text text-anchor="middle" x="392.5" y="-101.45" font-family="Times,serif" font-size="14.00">def</text></g>
    <g id="edge21" class="edge"><title>20->21</title></g> <g id="node24" class="node"><title>23</title>
    <text text-anchor="middle" x="440.5" y="-151.7" font-family="Times,serif" font-size="14.00">?
    (63)</text></g> <g id="edge23" class="edge"><title>22->23</title></g> <g id="node25"
    class="node"><title>24</title> <text text-anchor="middle" x="502.5" y="-151.7"
    font-family="Times,serif" font-size="14.00"><params></text></g> <g id="edge24"
    class="edge"><title>22->24</title></g> <g id="node26" class="node"><title>25</title>
    <text text-anchor="middle" x="502.5" y="-101.45" font-family="Times,serif" font-size="14.00"><param></text></g>
    <g id="edge25" class="edge"><title>24->25</title></g> <g id="node27" class="node"><title>26</title>
    <text text-anchor="middle" x="453.5" y="-51.2" font-family="Times,serif" font-size="14.00"><id></text></g>
    <g id="edge26" class="edge"><title>25->26</title></g> <g id="node29" class="node"><title>28</title>
    <text text-anchor="middle" x="502.5" y="-51.2" font-family="Times,serif" font-size="14.00">=
    (61)</text></g> <g id="edge28" class="edge"><title>25->28</title></g> <g id="node30"
    class="node"><title>29</title> <text text-anchor="middle" x="551.5" y="-51.2"
    font-family="Times,serif" font-size="14.00"><id></text></g> <g id="edge29" class="edge"><title>25->29</title></g>
    <g id="node28" class="node"><title>27</title> <text text-anchor="middle" x="453.5"
    y="-0.95" font-family="Times,serif" font-size="14.00">abc</text></g> <g id="edge27"
    class="edge"><title>26->27</title></g> <g id="node31" class="node"><title>30</title>
    <text text-anchor="middle" x="551.5" y="-0.95" font-family="Times,serif" font-size="14.00">def</text></g>
    <g id="edge30" class="edge"><title>29->30</title></g></g></svg>'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE139]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE140]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE141]'
  prefs: []
  type: TYPE_PRE
- en: <svg width="243pt" height="374pt" viewBox="0.00 0.00 242.75 374.00" xmlns:xlink="http://www.w3.org/1999/xlink"><g
    id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 370)"><g
    id="node1" class="node"><title>0</title> <text text-anchor="middle" x="54.12"
    y="-352.7" font-family="Times,serif" font-size="14.00"><start></text></g> <g id="node2"
    class="node"><title>1</title> <text text-anchor="middle" x="54.12" y="-302.45"
    font-family="Times,serif" font-size="14.00"><string></text></g> <g id="edge1"
    class="edge"><title>0->1</title></g> <g id="node3" class="node"><title>2</title>
    <text text-anchor="middle" x="22.12" y="-252.2" font-family="Times,serif" font-size="14.00"><letter></text></g>
    <g id="edge2" class="edge"><title>1->2</title></g> <g id="node6" class="node"><title>5</title>
    <text text-anchor="middle" x="86.12" y="-252.2" font-family="Times,serif" font-size="14.00"><string></text></g>
    <g id="edge5" class="edge"><title>1->5</title></g> <g id="node4" class="node"><title>3</title>
    <text text-anchor="middle" x="22.12" y="-201.95" font-family="Times,serif" font-size="14.00"><other></text></g>
    <g id="edge3" class="edge"><title>2->3</title></g> <g id="node5" class="node"><title>4</title>
    <text text-anchor="middle" x="22.12" y="-151.7" font-family="Times,serif" font-size="14.00">e
    (101)</text></g> <g id="edge4" class="edge"><title>3->4</title></g> <g id="node7"
    class="node"><title>6</title> <text text-anchor="middle" x="85.12" y="-201.95"
    font-family="Times,serif" font-size="14.00"><letter></text></g> <g id="edge6"
    class="edge"><title>5->6</title></g> <g id="node10" class="node"><title>9</title>
    <text text-anchor="middle" x="149.12" y="-201.95" font-family="Times,serif" font-size="14.00"><string></text></g>
    <g id="edge9" class="edge"><title>5->9</title></g> <g id="node8" class="node"><title>7</title>
    <text text-anchor="middle" x="85.12" y="-151.7" font-family="Times,serif" font-size="14.00"><plus></text></g>
    <g id="edge7" class="edge"><title>6->7</title></g> <g id="node9" class="node"><title>8</title>
    <text text-anchor="middle" x="85.12" y="-101.45" font-family="Times,serif" font-size="14.00">+
    (43)</text></g> <g id="edge8" class="edge"><title>7->8</title></g> <g id="node11"
    class="node"><title>10</title> <text text-anchor="middle" x="147.12" y="-151.7"
    font-family="Times,serif" font-size="14.00"><letter></text></g> <g id="edge10"
    class="edge"><title>9->10</title></g> <g id="node14" class="node"><title>13</title>
    <text text-anchor="middle" x="211.12" y="-151.7" font-family="Times,serif" font-size="14.00"><string></text></g>
    <g id="edge13" class="edge"><title>9->13</title></g> <g id="node12" class="node"><title>11</title>
    <text text-anchor="middle" x="147.12" y="-101.45" font-family="Times,serif" font-size="14.00"><other></text></g>
    <g id="edge11" class="edge"><title>10->11</title></g> <g id="node13" class="node"><title>12</title>
    <text text-anchor="middle" x="147.12" y="-51.2" font-family="Times,serif" font-size="14.00">d
    (100)</text></g> <g id="edge12" class="edge"><title>11->12</title></g> <g id="node15"
    class="node"><title>14</title> <text text-anchor="middle" x="211.12" y="-101.45"
    font-family="Times,serif" font-size="14.00"><letter></text></g> <g id="edge14"
    class="edge"><title>13->14</title></g> <g id="node16" class="node"><title>15</title>
    <text text-anchor="middle" x="211.12" y="-51.2" font-family="Times,serif" font-size="14.00"><plus></text></g>
    <g id="edge15" class="edge"><title>14->15</title></g> <g id="node17" class="node"><title>16</title>
    <text text-anchor="middle" x="211.12" y="-0.95" font-family="Times,serif" font-size="14.00">+
    (43)</text></g> <g id="edge16" class="edge"><title>15->16</title></g></g></svg>
  prefs: []
  type: TYPE_NORMAL
- en: How do we stack up against `simple_grammar_fuzzer()`?
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE142]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE143]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE144]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE145]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE146]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/7a67155bf919078dff92eb49265dfe42.png)'
  prefs: []
  type: TYPE_IMG
- en: Our test generation is much faster, but also our inputs are much smaller. We
    see that with derivation trees, we can get much better control over grammar production.
  prefs: []
  type: TYPE_NORMAL
- en: 'Finally, how does `GrammarFuzzer` work with `expr_grammar`, where `simple_grammar_fuzzer()`
    failed? It works without any issue:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE147]'
  prefs: []
  type: TYPE_PRE
- en: '[PRE148]'
  prefs: []
  type: TYPE_PRE
- en: With `GrammarFuzzer`, we now have a solid foundation on which to build further
    fuzzers and illustrate more exciting concepts from the world of generating software
    tests. Many of these do not even require writing a grammar – instead, they *infer*
    a grammar from the domain at hand, and thus allow using grammar-based fuzzing
    even without writing a grammar. Stay tuned!
  prefs: []
  type: TYPE_NORMAL
- en: Lessons Learned
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '*Derivation trees* are important for expressing input structure'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '*Grammar fuzzing based on derivation trees*'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: is much more efficient than string-based grammar fuzzing,
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: gives much better control over input generation, and
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: effectively avoids running into infinite expansions.
  prefs:
  - PREF_IND
  - PREF_OL
  type: TYPE_NORMAL
- en: Next Steps
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Congratulations! You have reached one of the central "hubs" of the book. From
    here, there is a wide range of techniques that build on grammar fuzzing.
  prefs: []
  type: TYPE_NORMAL
- en: Extending Grammars
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'First, we have a number of techniques that all *extend* grammars in some form:'
  prefs: []
  type: TYPE_NORMAL
- en: '[Parsing and recombining inputs](Parser.html) allows making use of existing
    inputs, again using derivation trees'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Covering grammar expansions](GrammarCoverageFuzzer.html) allows for *combinatorial*
    coverage'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Assigning *probabilities* to individual expansions](ProbabilisticGrammarFuzzer.html)
    gives additional control over expansions'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Assigning *constraints* to individual expansions](GeneratorGrammarFuzzer.html)
    allows expressing *semantic constraints* on individual rules.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Applying Grammars
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Second, we can *apply* grammars in a variety of contexts that all involve some
    form of learning it automatically:'
  prefs: []
  type: TYPE_NORMAL
- en: '[Fuzzing APIs](APIFuzzer.html), learning a grammar from APIs'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Fuzzing graphical user interfaces](WebFuzzer.html), learning a grammar from
    user interfaces for subsequent fuzzing'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '[Mining grammars](GrammarMiner.html), learning a grammar for arbitrary input
    formats'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Keep on expanding!
  prefs: []
  type: TYPE_NORMAL
- en: Background
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Derivation trees (then frequently called *parse trees*) are a standard data
    structure into which *parsers* decompose inputs. The *Dragon Book* (also known
    as *Compilers: Principles, Techniques, and Tools*) [[Aho *et al*, 2006](https://www.pearson.com/us/higher-education/program/Aho-Compilers-Principles-Techniques-and-Tools-2nd-Edition/PGM167067.html)]
    discusses parsing into derivation trees as part of compiling programs. We also
    use derivation trees [when parsing and recombining inputs](Parser.html).'
  prefs: []
  type: TYPE_NORMAL
- en: The key idea in this chapter, namely expanding until a limit of symbols is reached,
    and then always choosing the shortest path, stems from Luke [[Luke *et al*, 2000](https://doi.org/10.1109/4235.873237)].
  prefs: []
  type: TYPE_NORMAL
- en: Exercises
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Exercise 1: Caching Method Results'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Tracking `GrammarFuzzer` reveals that some methods are called again and again,
    always with the same values.
  prefs: []
  type: TYPE_NORMAL
- en: Set up a class `FasterGrammarFuzzer` with a *cache* that checks whether the
    method has been called before, and if so, return the previously computed "memoized"
    value. Do this for `expansion_to_children()`. Compare the number of invocations
    before and after the optimization.
  prefs: []
  type: TYPE_NORMAL
- en: '**Important**: For `expansion_to_children()`, make sure that each list returned
    is an individual copy. If you return the same (cached) list, this will interfere
    with the in-place modification of `GrammarFuzzer`. Use the Python `copy.deepcopy()`
    function for this purpose.'
  prefs: []
  type: TYPE_NORMAL
- en: '[Use the notebook](https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/GrammarFuzzer.ipynb#Exercises)
    to work on the exercises and see solutions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 2: Grammar Pre-Compilation'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Some methods such as `symbol_cost()` or `expansion_cost()` return a value that
    is dependent on the grammar only. Set up a class `EvenFasterGrammarFuzzer()` that
    pre-computes these values once upon initialization, such that later invocations
    of `symbol_cost()` or `expansion_cost()` need only look up these values.
  prefs: []
  type: TYPE_NORMAL
- en: '[Use the notebook](https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/GrammarFuzzer.ipynb#Exercises)
    to work on the exercises and see solutions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 3: Maintaining Trees to be Expanded'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In `expand_tree_once()`, the algorithm traverses the tree again and again to
    find nonterminals that still can be extended. Speed up the process by keeping
    a list of nonterminal symbols in the tree that still can be expanded.
  prefs: []
  type: TYPE_NORMAL
- en: '[Use the notebook](https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/GrammarFuzzer.ipynb#Exercises)
    to work on the exercises and see solutions.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Exercise 4: Alternate Random Expansions'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'We could define `expand_node_randomly()` such that it simply invokes `expand_node_by_cost(node,
    random.choice)`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE149]'
  prefs: []
  type: TYPE_PRE
- en: What is the difference between the original implementation and this alternative?
  prefs: []
  type: TYPE_NORMAL
- en: '[Use the notebook](https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/GrammarFuzzer.ipynb#Exercises)
    to work on the exercises and see solutions.'
  prefs: []
  type: TYPE_NORMAL
- en: '![Creative Commons License](../Images/2f3faa36146c6fb38bbab67add09aa5f.png)
    The content of this project is licensed under the [Creative Commons Attribution-NonCommercial-ShareAlike
    4.0 International License](https://creativecommons.org/licenses/by-nc-sa/4.0/).
    The source code that is part of the content, as well as the source code used to
    format and display that content is licensed under the [MIT License](https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license).
    [Last change: 2023-11-11 18:18:06+01:00](https://github.com/uds-se/fuzzingbook/commits/master/notebooks/GrammarFuzzer.ipynb)
    • [Cite](#citation) • [Imprint](https://cispa.de/en/impressum)'
  prefs: []
  type: TYPE_IMG
- en: How to Cite this Work
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian
    Holler: "[Efficient Grammar Fuzzing](https://www.fuzzingbook.org/html/GrammarFuzzer.html)".
    In Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian
    Holler, "[The Fuzzing Book](https://www.fuzzingbook.org/)", [https://www.fuzzingbook.org/html/GrammarFuzzer.html](https://www.fuzzingbook.org/html/GrammarFuzzer.html).
    Retrieved 2023-11-11 18:18:06+01:00.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE150]'
  prefs: []
  type: TYPE_PRE
