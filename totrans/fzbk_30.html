<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Testing Configurations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Testing Configurations</h1>
<blockquote>原文：<a href="http://www.fuzzingbook.org/html/ConfigurationFuzzer.html">http://www.fuzzingbook.org/html/ConfigurationFuzzer.html</a></blockquote>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The behavior of a program is not only governed by its data.  The <em>configuration</em> of a program – that is, the settings that govern the execution of a program on its (regular) input data, as set by options or configuration files – just as well influences behavior, and thus can and should be tested.  In this chapter, we explore how to systematically <em>test</em> and <em>cover</em> software configurations.  By <em>automatically inferring configuration options</em>, we can apply these techniques out of the box, with no need for writing a grammar.  Finally, we show how to systematically cover <em>combinations</em> of configuration options, quickly detecting unwanted interferences.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils</a></span> <span class="kn">import</span> <span class="n">YouTubeVideo</span>
<span class="n">YouTubeVideo</span><span class="p">(</span><span class="s1">'L0ztoXVru2U'</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_html rendered_html output_subarea output_execute_result">

        

</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p><strong>Prerequisites</strong></p>
<ul>
<li>You should have read the <a href="Grammars.html">chapter on grammars</a>.</li>
<li>You should have read the <a href="GrammarCoverageFuzzer.html">chapter on grammar coverage</a>.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils.setup</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/typing.html" class="import" target="_blank">typing</a></span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Type</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><div class="synopsis"><h2 id="Synopsis">Synopsis</h2><!-- Automatically generated. Do not edit. -->

<p>To <a href="Importing.html">use the code provided in this chapter</a>, write</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="ConfigurationFuzzer.html" class="import" target="_blank">fuzzingbook.ConfigurationFuzzer</a></span> <span class="kn">import</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;</span>
</pre></div>
<p>and then make use of the following features.</p>
<p>This chapter provides two classes:</p>
<ul>
<li><code>OptionRunner</code> automatically extract command-line options from a Python program;</li>
<li><code>OptionFuzzer</code> uses these to automatically test a Python program with a large variety of options.</li>
</ul>
<p><code>OptionRunner</code> runs a program up to the point where it parses its arguments, and then extracts a grammar that describes its invocations:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">"autopep8"</span><span class="p">,</span> <span class="s2">"foo.py"</span><span class="p">)</span>
</pre></div>
<p>The grammar can be extracted via the method <code>ebnf_grammar()</code>:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">option_ebnf_grammar</span> <span class="o">=</span> <span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">option_ebnf_grammar</span>
<span class="p">{</span><span class="s1">'&lt;start&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'(&lt;option&gt;)*&lt;arguments&gt;'</span><span class="p">],</span>
 <span class="s1">'&lt;option&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">' -h'</span><span class="p">,</span>
  <span class="s1">' --help'</span><span class="p">,</span>
  <span class="s1">' --version'</span><span class="p">,</span>
  <span class="s1">' -v'</span><span class="p">,</span>
  <span class="s1">' --verbose'</span><span class="p">,</span>
  <span class="s1">' -d'</span><span class="p">,</span>
  <span class="s1">' --diff'</span><span class="p">,</span>
  <span class="s1">' -i'</span><span class="p">,</span>
  <span class="s1">' --in-place'</span><span class="p">,</span>
  <span class="s1">' --global-config &lt;filename&gt;'</span><span class="p">,</span>
  <span class="s1">' --ignore-local-config'</span><span class="p">,</span>
  <span class="s1">' -r'</span><span class="p">,</span>
  <span class="s1">' --recursive'</span><span class="p">,</span>
  <span class="s1">' -j &lt;n&gt;'</span><span class="p">,</span>
  <span class="s1">' --jobs &lt;n&gt;'</span><span class="p">,</span>
  <span class="s1">' -p &lt;n&gt;'</span><span class="p">,</span>
  <span class="s1">' --pep8-passes &lt;n&gt;'</span><span class="p">,</span>
  <span class="s1">' -a'</span><span class="p">,</span>
  <span class="s1">' --aggressive'</span><span class="p">,</span>
  <span class="s1">' --experimental'</span><span class="p">,</span>
  <span class="s1">' --exclude &lt;globs&gt;'</span><span class="p">,</span>
  <span class="s1">' --list-fixes'</span><span class="p">,</span>
  <span class="s1">' --ignore &lt;errors&gt;'</span><span class="p">,</span>
  <span class="s1">' --select &lt;errors&gt;'</span><span class="p">,</span>
  <span class="s1">' --max-line-length &lt;n&gt;'</span><span class="p">,</span>
  <span class="s1">' --line-range &lt;line&gt; &lt;line&gt;'</span><span class="p">,</span>
  <span class="s1">' --range &lt;line&gt; &lt;line&gt;'</span><span class="p">,</span>
  <span class="s1">' --indent-size &lt;int&gt;'</span><span class="p">,</span>
  <span class="s1">' --hang-closing'</span><span class="p">,</span>
  <span class="s1">' --exit-code'</span><span class="p">],</span>
 <span class="s1">'&lt;arguments&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">' foo.py'</span><span class="p">],</span>
 <span class="s1">'&lt;str&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;char&gt;+'</span><span class="p">],</span>
 <span class="s1">'&lt;char&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span>
  <span class="s1">'1'</span><span class="p">,</span>
  <span class="s1">'2'</span><span class="p">,</span>
  <span class="s1">'3'</span><span class="p">,</span>
  <span class="s1">'4'</span><span class="p">,</span>
  <span class="s1">'5'</span><span class="p">,</span>
  <span class="s1">'6'</span><span class="p">,</span>
  <span class="s1">'7'</span><span class="p">,</span>
  <span class="s1">'8'</span><span class="p">,</span>
  <span class="s1">'9'</span><span class="p">,</span>
  <span class="s1">'a'</span><span class="p">,</span>
  <span class="s1">'b'</span><span class="p">,</span>
  <span class="s1">'c'</span><span class="p">,</span>
  <span class="s1">'d'</span><span class="p">,</span>
  <span class="s1">'e'</span><span class="p">,</span>
  <span class="s1">'f'</span><span class="p">,</span>
  <span class="s1">'g'</span><span class="p">,</span>
  <span class="s1">'h'</span><span class="p">,</span>
  <span class="s1">'i'</span><span class="p">,</span>
  <span class="s1">'j'</span><span class="p">,</span>
  <span class="s1">'k'</span><span class="p">,</span>
  <span class="s1">'l'</span><span class="p">,</span>
  <span class="s1">'m'</span><span class="p">,</span>
  <span class="s1">'n'</span><span class="p">,</span>
  <span class="s1">'o'</span><span class="p">,</span>
  <span class="s1">'p'</span><span class="p">,</span>
  <span class="s1">'q'</span><span class="p">,</span>
  <span class="s1">'r'</span><span class="p">,</span>
  <span class="s1">'s'</span><span class="p">,</span>
  <span class="s1">'t'</span><span class="p">,</span>
  <span class="s1">'u'</span><span class="p">,</span>
  <span class="s1">'v'</span><span class="p">,</span>
  <span class="s1">'w'</span><span class="p">,</span>
  <span class="s1">'x'</span><span class="p">,</span>
  <span class="s1">'y'</span><span class="p">,</span>
  <span class="s1">'z'</span><span class="p">,</span>
  <span class="s1">'A'</span><span class="p">,</span>
  <span class="s1">'B'</span><span class="p">,</span>
  <span class="s1">'C'</span><span class="p">,</span>
  <span class="s1">'D'</span><span class="p">,</span>
  <span class="s1">'E'</span><span class="p">,</span>
  <span class="s1">'F'</span><span class="p">,</span>
  <span class="s1">'G'</span><span class="p">,</span>
  <span class="s1">'H'</span><span class="p">,</span>
  <span class="s1">'I'</span><span class="p">,</span>
  <span class="s1">'J'</span><span class="p">,</span>
  <span class="s1">'K'</span><span class="p">,</span>
  <span class="s1">'L'</span><span class="p">,</span>
  <span class="s1">'M'</span><span class="p">,</span>
  <span class="s1">'N'</span><span class="p">,</span>
  <span class="s1">'O'</span><span class="p">,</span>
  <span class="s1">'P'</span><span class="p">,</span>
  <span class="s1">'Q'</span><span class="p">,</span>
  <span class="s1">'R'</span><span class="p">,</span>
  <span class="s1">'S'</span><span class="p">,</span>
  <span class="s1">'T'</span><span class="p">,</span>
  <span class="s1">'U'</span><span class="p">,</span>
  <span class="s1">'V'</span><span class="p">,</span>
  <span class="s1">'W'</span><span class="p">,</span>
  <span class="s1">'X'</span><span class="p">,</span>
  <span class="s1">'Y'</span><span class="p">,</span>
  <span class="s1">'Z'</span><span class="p">,</span>
  <span class="s1">'!'</span><span class="p">,</span>
  <span class="s1">'"'</span><span class="p">,</span>
  <span class="s1">'#'</span><span class="p">,</span>
  <span class="s1">'$'</span><span class="p">,</span>
  <span class="s1">'%'</span><span class="p">,</span>
  <span class="s1">'&amp;'</span><span class="p">,</span>
  <span class="s2">"'"</span><span class="p">,</span>
  <span class="s1">'('</span><span class="p">,</span>
  <span class="s1">')'</span><span class="p">,</span>
  <span class="s1">'*'</span><span class="p">,</span>
  <span class="s1">'+'</span><span class="p">,</span>
  <span class="s1">','</span><span class="p">,</span>
  <span class="s1">'-'</span><span class="p">,</span>
  <span class="s1">'.'</span><span class="p">,</span>
  <span class="s1">'/'</span><span class="p">,</span>
  <span class="s1">':'</span><span class="p">,</span>
  <span class="s1">';'</span><span class="p">,</span>
  <span class="s1">'&lt;'</span><span class="p">,</span>
  <span class="s1">'='</span><span class="p">,</span>
  <span class="s1">'&gt;'</span><span class="p">,</span>
  <span class="s1">'?'</span><span class="p">,</span>
  <span class="s1">'@'</span><span class="p">,</span>
  <span class="s1">'['</span><span class="p">,</span>
  <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span>
  <span class="s1">']'</span><span class="p">,</span>
  <span class="s1">'^'</span><span class="p">,</span>
  <span class="s1">'_'</span><span class="p">,</span>
  <span class="s1">'`'</span><span class="p">,</span>
  <span class="s1">'{'</span><span class="p">,</span>
  <span class="s1">'|'</span><span class="p">,</span>
  <span class="s1">'}'</span><span class="p">,</span>
  <span class="s1">'~'</span><span class="p">],</span>
 <span class="s1">'&lt;filename&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;str&gt;'</span><span class="p">],</span>
 <span class="s1">'&lt;int&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'(-)?&lt;digit&gt;+'</span><span class="p">],</span>
 <span class="s1">'&lt;digit&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">,</span> <span class="s1">'4'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'7'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">],</span>
 <span class="s1">'&lt;n&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;int&gt;'</span><span class="p">],</span>
 <span class="s1">'&lt;globs&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;str&gt;'</span><span class="p">],</span>
 <span class="s1">'&lt;errors&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;str&gt;'</span><span class="p">],</span>
 <span class="s1">'&lt;line&gt;'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'&lt;int&gt;'</span><span class="p">]}</span>
</pre></div>
<p>The grammar can be immediately used for fuzzing. A <code>GrammarCoverageFuzzer</code> will ensure all options are covered:</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn"><a href="Grammars.html" class="import" target="_blank">Grammars</a></span> <span class="kn">import</span> <span class="n">convert_ebnf_grammar</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">option_ebnf_grammar</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="p">[</span><span class="s1">' --max-line-length -64 foo.py'</span><span class="p">,</span>
 <span class="s2">" -a --version --select u --diff --list-fixes -r --range -50 3 --ignore iq --hang-closing --ignore-local-config --aggressive --in-place --indent-size 9 -d --global-config wQ --help --line-range -8226 7 -j 1 -p 2 -h --experimental -i -v --jobs -81 --exclude c --exit-code --verbose --recursive --exclude j --pep8-passes 587 --global-config 5ty --global-config W]96{&lt; --ignore M --exclude . --select &gt; --global-config T --ignore z'C --select </span><span class="si">%E</span><span class="s2">IL -r -a -v foo.py"</span><span class="p">,</span>
 <span class="s1">' --exclude VKSl --exclude 3[ --global-config ^0x --ignore 4 --exclude _ --global-config 7 --select mh --global-config e --global-config R --global-config JH</span><span class="se">\\</span><span class="s1"> --exclude OP --ignore = --global-config @ --select ?N --global-config s --select *}v --ignore - --select Do,GA --exclude bkn --ignore U --exclude | --global-config 2 --exclude 8 --select " --exclude pZ --select / --exclude f(aYdg) --select : --global-config ~ --global-config ! --global-config 1B`$X --exclude ; --select F --select &amp; --ignore r --exclude #+ --exit-code --aggressive --select ?/ -p -6 --version --ignore-local-config -r -v foo.py'</span><span class="p">]</span>
</pre></div>
<p>The <code>OptionFuzzer</code> class summarizes these steps.  Its constructor takes an <code>OptionRunner</code> to automatically extract the grammar; it does the necessary steps to extract the grammar and fuzz with it.</p>
<div class="highlight"><pre><span/><span class="o">&gt;&gt;&gt;</span> <span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">"autopep8"</span><span class="p">,</span> <span class="s2">"foo.py"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">autopep8_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="p">[</span><span class="s1">' --version foo.py'</span><span class="p">,</span>
 <span class="s1">' --ignore Rj --jobs -6 --line-range -04 7953 --help --aggressive -v --ignore-local-config -h --experimental -r --global-config 3 --indent-size -8 --exclude ;&amp;M"! -a -p 1 --hang-closing -j 263 --verbose --recursive --in-place --list-fixes --select t@fs --range -0 7 -d --pep8-passes 7 --diff -i --exit-code --max-line-length -3 --global-config L --select u| --global-config </span><span class="se">\'</span><span class="s1"> --global-config r --exclude Ik) --ignore D- --ignore 4 --select XS --global-config 7 --ignore ~. --ignore e9 --exclude ph --ignore U --global-config dz --global-config Q$o --exclude 6( --ignore x --select 5J:N --exclude &lt; --ignore O --global-config ,c --global-config = --exclude W</span><span class="se">\\</span><span class="s1"> --global-config ? --select l --select ^ --select V --exclude P --select Z --select &gt;0 --select TH --exclude * --exclude G --select 8 --global-config bn --global-config C{a1m --exclude F --ignore _ --ignore g --ignore ]q --exclude wy --ignore </span><span class="si">% --g</span><span class="s1">lobal-config v --ignore + --global-config EK/ --ignore [#}Y --global-config `i --global-config 2 --ignore BE --global-config A --indent-size -22 --recursive --hang-closing --exclude ` --indent-size -61 --diff -a foo.py'</span><span class="p">,</span>
 <span class="s1">' foo.py'</span><span class="p">]</span>
</pre></div>
<p>The final step in testing would now to invoke the program with these arguments.</p>
<p>Note that <code>OptionRunner</code> is experimental: It assumes that the Python program in question uses the <code>argparse</code> module; and not all <code>argparse</code> features are supported.  Still, it does a pretty good job even on nontrivial programs.</p>
<p>The <code>OptionRunner</code> constructor accepts an additional <code>miner</code> keyword parameter, which takes the class of the argument grammar miner to be used. By default, this is <code>OptionGrammarMiner</code> – a helper class that can be used (and extended) to create own option grammar miners.</p>
<p>

<!-- Generated by graphviz version 12.2.1 (20241206.2353)
 -->
<!-- Pages: 1 -->
<svg width="586pt" height="771pt" viewbox="0.00 0.00 586.12 771.00" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 767)">
<g id="a_graph0"><a xlink:title="OptionRunner class hierarchy">
<polygon fill="white" stroke="none" points="-4,4 -4,-767 582.12,-767 582.12,4 -4,4"/>
</a>
</g>
<!-- OptionRunner -->
<g id="node1" class="node">
<title>OptionRunner</title>
<g id="a_node1"><a xlink:href="#" xlink:title="class OptionRunner:&#10;Run a program while determining its option grammar">
<polygon fill="none" stroke="black" points="1.5,-36.38 1.5,-185.12 113.5,-185.12 113.5,-36.38 1.5,-36.38"/>
<text text-anchor="start" x="14" y="-168.82" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionRunner</text>
<polyline fill="none" stroke="black" points="1.5,-159.12 113.5,-159.12"/>
<g id="a_node1_0"><a xlink:href="#" xlink:title="OptionRunner">
<g id="a_node1_1"><a xlink:href="#" xlink:title="__init__(self, program: Union[str, List[str]], arguments: Optional[str] = None, *, log: bool = False, miner_class: Optional[Type[OptionGrammarMiner]] = None):&#10;Constructor.&#10;`program` - the (Python) program to be executed&#10;`arguments` - an (optional) string with arguments for `program`&#10;`log` - if True, enable logging in miner&#10;`miner_class` - the `OptionGrammarMiner` class to be used&#10;(default: `OptionGrammarMiner`)">
<text text-anchor="start" x="9.5" y="-146.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node1_2"><a xlink:href="#" xlink:title="ebnf_grammar(self):&#10;Return extracted grammar in EBNF form">
<text text-anchor="start" x="9.5" y="-133.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">ebnf_grammar()</text>
</a>
</g>
<g id="a_node1_3"><a xlink:href="#" xlink:title="grammar(self):&#10;Return extracted grammar in BNF form">
<text text-anchor="start" x="9.5" y="-121.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">grammar()</text>
</a>
</g>
<g id="a_node1_4"><a xlink:href="#" xlink:title="executable(self)">
<text text-anchor="start" x="9.5" y="-107.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">executable()</text>
</a>
</g>
<g id="a_node1_5"><a xlink:href="#" xlink:title="find_contents(self)">
<text text-anchor="start" x="9.5" y="-94.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">find_contents()</text>
</a>
</g>
<g id="a_node1_6"><a xlink:href="#" xlink:title="find_grammar(self)">
<text text-anchor="start" x="9.5" y="-81.88" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">find_grammar()</text>
</a>
</g>
<g id="a_node1_7"><a xlink:href="#" xlink:title="invoker(self)">
<text text-anchor="start" x="9.5" y="-69.12" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">invoker()</text>
</a>
</g>
<g id="a_node1_8"><a xlink:href="#" xlink:title="set_arguments(self, args)">
<text text-anchor="start" x="9.5" y="-56.38" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">set_arguments()</text>
</a>
</g>
<g id="a_node1_9"><a xlink:href="#" xlink:title="set_invocation(self, program)">
<text text-anchor="start" x="9.5" y="-43.62" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">set_invocation()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ProgramRunner -->
<g id="node2" class="node">
<title>ProgramRunner</title>
<g id="a_node2"><a xlink:href="Fuzzer.html" xlink:title="class ProgramRunner:&#10;Test a program with inputs.">
<polygon fill="none" stroke="black" points="0,-258 0,-304.75 115,-304.75 115,-258 0,-258"/>
<text text-anchor="start" x="8" y="-288.45" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">ProgramRunner</text>
<polyline fill="none" stroke="black" points="0,-278.75 115,-278.75"/>
<g id="a_node2_10"><a xlink:href="#" xlink:title="ProgramRunner">
<g id="a_node2_11"><a xlink:href="Fuzzer.html" xlink:title="__init__(self, program: Union[str, List[str]]) -&gt; None:&#10;Initialize.&#10;`program` is a program spec as passed to `subprocess.run()`">
<text text-anchor="start" x="27.5" y="-266.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- OptionRunner&#45;&gt;ProgramRunner -->
<g id="edge1" class="edge">
<title>OptionRunner-&gt;ProgramRunner</title>
<path fill="none" stroke="black" d="M57.5,-185.22C57.5,-206.42 57.5,-228.55 57.5,-246.13"/>
<polygon fill="none" stroke="black" points="54,-245.99 57.5,-255.99 61,-245.99 54,-245.99"/>
</g>
<!-- Runner -->
<g id="node3" class="node">
<title>Runner</title>
<g id="a_node3"><a xlink:href="Fuzzer.html" xlink:title="class Runner:&#10;Base class for testing inputs.">
<polygon fill="none" stroke="black" points="19.5,-341.75 19.5,-447.5 95.5,-447.5 95.5,-341.75 19.5,-341.75"/>
<text text-anchor="start" x="34.62" y="-431.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Runner</text>
<polyline fill="none" stroke="black" points="19.5,-421.5 95.5,-421.5"/>
<g id="a_node3_12"><a xlink:href="#" xlink:title="Runner">
<g id="a_node3_13"><a xlink:href="Fuzzer.html" xlink:title="FAIL = 'FAIL'">
<text text-anchor="start" x="27.5" y="-408" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">FAIL</text>
</a>
</g>
<g id="a_node3_14"><a xlink:href="Fuzzer.html" xlink:title="PASS = 'PASS'">
<text text-anchor="start" x="27.5" y="-395.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">PASS</text>
</a>
</g>
<g id="a_node3_15"><a xlink:href="Fuzzer.html" xlink:title="UNRESOLVED = 'UNRESOLVED'">
<text text-anchor="start" x="27.5" y="-382.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">UNRESOLVED</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="19.5,-375.25 95.5,-375.25"/>
<g id="a_node3_16"><a xlink:href="#" xlink:title="Runner">
<g id="a_node3_17"><a xlink:href="Fuzzer.html" xlink:title="__init__(self) -&gt; None:&#10;Initialize">
<text text-anchor="start" x="27.5" y="-362.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node3_18"><a xlink:href="Fuzzer.html" xlink:title="run(self, inp: str) -&gt; Any:&#10;Run the runner with the given input">
<text text-anchor="start" x="27.5" y="-350" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- ProgramRunner&#45;&gt;Runner -->
<g id="edge2" class="edge">
<title>ProgramRunner-&gt;Runner</title>
<path fill="none" stroke="black" d="M57.5,-305.16C57.5,-312.58 57.5,-321.21 57.5,-330.12"/>
<polygon fill="none" stroke="black" points="54,-329.97 57.5,-339.97 61,-329.97 54,-329.97"/>
</g>
<!-- OptionFuzzer -->
<g id="node4" class="node">
<title>OptionFuzzer</title>
<g id="a_node4"><a xlink:href="#" xlink:title="class OptionFuzzer:&#10;Fuzz a (Python) program using its arguments">
<polygon fill="none" stroke="black" points="171.25,-81 171.25,-140.5 269.75,-140.5 269.75,-81 171.25,-81"/>
<text text-anchor="start" x="179.25" y="-124.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionFuzzer</text>
<polyline fill="none" stroke="black" points="171.25,-114.5 269.75,-114.5"/>
<g id="a_node4_19"><a xlink:href="#" xlink:title="OptionFuzzer">
<g id="a_node4_20"><a xlink:href="#" xlink:title="__init__(self, runner: OptionRunner, *args, **kwargs):&#10;Constructor. `runner` is an OptionRunner.">
<text text-anchor="start" x="190.5" y="-102" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node4_21"><a xlink:href="#" xlink:title="run(self, runner=None, inp=''):&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="190.5" y="-89.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarCoverageFuzzer -->
<g id="node5" class="node">
<title>GrammarCoverageFuzzer</title>
<g id="a_node5"><a xlink:href="GrammarCoverageFuzzer.html" xlink:title="class GrammarCoverageFuzzer:&#10;Produce from grammars, aiming for coverage of all expansions.">
<polygon fill="none" stroke="black" points="133.75,-263.38 133.75,-299.38 307.25,-299.38 307.25,-263.38 133.75,-263.38"/>
<text text-anchor="start" x="141.75" y="-278.07" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- OptionFuzzer&#45;&gt;GrammarCoverageFuzzer -->
<g id="edge3" class="edge">
<title>OptionFuzzer-&gt;GrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-140.74C220.5,-171.83 220.5,-220.89 220.5,-251.81"/>
<polygon fill="none" stroke="black" points="217,-251.57 220.5,-261.57 224,-251.57 217,-251.57"/>
</g>
<!-- SimpleGrammarCoverageFuzzer -->
<g id="node6" class="node">
<title>SimpleGrammarCoverageFuzzer</title>
<g id="a_node6"><a xlink:href="GrammarCoverageFuzzer.html" xlink:title="class SimpleGrammarCoverageFuzzer:&#10;When choosing expansions, prefer expansions not covered.">
<polygon fill="none" stroke="black" points="113.12,-376.62 113.12,-412.62 327.88,-412.62 327.88,-376.62 113.12,-376.62"/>
<text text-anchor="start" x="121.12" y="-391.32" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">SimpleGrammarCoverageFuzzer</text>
</a>
</g>
</g>
<!-- GrammarCoverageFuzzer&#45;&gt;SimpleGrammarCoverageFuzzer -->
<g id="edge4" class="edge">
<title>GrammarCoverageFuzzer-&gt;SimpleGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-299.76C220.5,-317.23 220.5,-344.46 220.5,-365.1"/>
<polygon fill="none" stroke="black" points="217,-364.85 220.5,-374.85 224,-364.85 217,-364.85"/>
</g>
<!-- TrackingGrammarCoverageFuzzer -->
<g id="node7" class="node">
<title>TrackingGrammarCoverageFuzzer</title>
<g id="a_node7"><a xlink:href="GrammarCoverageFuzzer.html" xlink:title="class TrackingGrammarCoverageFuzzer:&#10;Track grammar coverage during production">
<polygon fill="none" stroke="black" points="106.38,-484.5 106.38,-531.25 334.62,-531.25 334.62,-484.5 106.38,-484.5"/>
<text text-anchor="start" x="114.38" y="-514.95" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">TrackingGrammarCoverageFuzzer</text>
<polyline fill="none" stroke="black" points="106.38,-505.25 334.62,-505.25"/>
<g id="a_node7_22"><a xlink:href="#" xlink:title="TrackingGrammarCoverageFuzzer">
<g id="a_node7_23"><a xlink:href="GrammarCoverageFuzzer.html" xlink:title="__init__(self, *args, **kwargs) -&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text text-anchor="start" x="190.5" y="-492.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- SimpleGrammarCoverageFuzzer&#45;&gt;TrackingGrammarCoverageFuzzer -->
<g id="edge5" class="edge">
<title>SimpleGrammarCoverageFuzzer-&gt;TrackingGrammarCoverageFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-413.01C220.5,-428.97 220.5,-453.09 220.5,-472.87"/>
<polygon fill="none" stroke="black" points="217,-472.71 220.5,-482.71 224,-472.71 217,-472.71"/>
</g>
<!-- GrammarFuzzer -->
<g id="node8" class="node">
<title>GrammarFuzzer</title>
<g id="a_node8"><a xlink:href="GrammarFuzzer.html" xlink:title="class GrammarFuzzer:&#10;Produce strings from grammars efficiently, using derivation trees.">
<polygon fill="none" stroke="black" points="162.62,-568.25 162.62,-640.5 278.38,-640.5 278.38,-568.25 162.62,-568.25"/>
<text text-anchor="start" x="170.62" y="-624.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">GrammarFuzzer</text>
<polyline fill="none" stroke="black" points="162.62,-614.5 278.38,-614.5"/>
<g id="a_node8_24"><a xlink:href="#" xlink:title="GrammarFuzzer">
<g id="a_node8_25"><a xlink:href="GrammarFuzzer.html" xlink:title="__init__(self, grammar: Dict[str, List[Expansion]], start_symbol: str = '&lt;start&gt;', min_nonterminals: int = 0, max_nonterminals: int = 10, disp: bool = False, log: Union[bool, int] = False) -&gt; None:&#10;Produce strings from `grammar`, starting with `start_symbol`.&#10;If `min_nonterminals` or `max_nonterminals` is given, use them as limits&#10;for the number of nonterminals produced.&#10;If `disp` is set, display the intermediate derivation trees.&#10;If `log` is set, show intermediate steps as text on standard output.">
<text text-anchor="start" x="187.5" y="-602" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node8_26"><a xlink:href="GrammarFuzzer.html" xlink:title="fuzz(self) -&gt; str:&#10;Produce a string from the grammar.">
<text text-anchor="start" x="187.5" y="-589.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node8_27"><a xlink:href="GrammarFuzzer.html" xlink:title="fuzz_tree(self) -&gt; DerivationTree:&#10;Produce a derivation tree from the grammar.">
<text text-anchor="start" x="187.5" y="-576.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">fuzz_tree()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- TrackingGrammarCoverageFuzzer&#45;&gt;GrammarFuzzer -->
<g id="edge6" class="edge">
<title>TrackingGrammarCoverageFuzzer-&gt;GrammarFuzzer</title>
<path fill="none" stroke="black" d="M220.5,-531.27C220.5,-538.86 220.5,-547.65 220.5,-556.42"/>
<polygon fill="none" stroke="black" points="217,-556.33 220.5,-566.33 224,-556.33 217,-556.33"/>
</g>
<!-- Fuzzer -->
<g id="node9" class="node">
<title>Fuzzer</title>
<g id="a_node9"><a xlink:href="Fuzzer.html" xlink:title="class Fuzzer:&#10;Base class for fuzzers.">
<polygon fill="none" stroke="black" points="182.5,-677.5 182.5,-762.5 258.5,-762.5 258.5,-677.5 182.5,-677.5"/>
<text text-anchor="start" x="199.88" y="-746.2" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">Fuzzer</text>
<polyline fill="none" stroke="black" points="182.5,-736.5 258.5,-736.5"/>
<g id="a_node9_28"><a xlink:href="#" xlink:title="Fuzzer">
<g id="a_node9_29"><a xlink:href="Fuzzer.html" xlink:title="__init__(self) -&gt; None:&#10;Constructor">
<text text-anchor="start" x="190.5" y="-724" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node9_30"><a xlink:href="Fuzzer.html" xlink:title="fuzz(self) -&gt; str:&#10;Return fuzz input">
<text text-anchor="start" x="190.5" y="-711.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">fuzz()</text>
</a>
</g>
<g id="a_node9_31"><a xlink:href="Fuzzer.html" xlink:title="run(self, runner: Fuzzer.Runner = &lt;Fuzzer.Runner object&gt;) -&gt; Tuple[subprocess.CompletedProcess, str]:&#10;Run `runner` with fuzz input">
<text text-anchor="start" x="190.5" y="-698.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-style="italic" font-size="10.00">run()</text>
</a>
</g>
<g id="a_node9_32"><a xlink:href="Fuzzer.html" xlink:title="runs(self, runner: Fuzzer.Runner = &lt;Fuzzer.PrintRunner object&gt;, trials: int = 10) -&gt; List[Tuple[subprocess.CompletedProcess, str]]:&#10;Run `runner` with fuzz input, `trials` times">
<text text-anchor="start" x="190.5" y="-685.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">runs()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- GrammarFuzzer&#45;&gt;Fuzzer -->
<g id="edge7" class="edge">
<title>GrammarFuzzer-&gt;Fuzzer</title>
<path fill="none" stroke="black" d="M220.5,-640.7C220.5,-648.68 220.5,-657.31 220.5,-665.83"/>
<polygon fill="none" stroke="black" points="217,-665.8 220.5,-675.8 224,-665.8 217,-665.8"/>
</g>
<!-- OptionGrammarMiner -->
<g id="node10" class="node">
<title>OptionGrammarMiner</title>
<g id="a_node10"><a xlink:href="#" xlink:title="class OptionGrammarMiner:&#10;Helper class for extracting option grammars">
<polygon fill="none" stroke="black" points="288.25,-0.5 288.25,-221 440.75,-221 440.75,-0.5 288.25,-0.5"/>
<text text-anchor="start" x="296.25" y="-204.7" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="14.00" fill="#b03a2e">OptionGrammarMiner</text>
<polyline fill="none" stroke="black" points="288.25,-195 440.75,-195"/>
<g id="a_node10_33"><a xlink:href="#" xlink:title="OptionGrammarMiner">
<g id="a_node10_34"><a xlink:href="#" xlink:title="ARGUMENTS_SYMBOL = '&lt;arguments&gt;'">
<text text-anchor="start" x="316.5" y="-181.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">ARGUMENTS_SYMBOL</text>
</a>
</g>
<g id="a_node10_35"><a xlink:href="#" xlink:title="OPTION_SYMBOL = '&lt;option&gt;'">
<text text-anchor="start" x="316.5" y="-168.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">OPTION_SYMBOL</text>
</a>
</g>
</a>
</g>
<polyline fill="none" stroke="black" points="288.25,-161.5 440.75,-161.5"/>
<g id="a_node10_36"><a xlink:href="#" xlink:title="OptionGrammarMiner">
<g id="a_node10_37"><a xlink:href="#" xlink:title="__init__(self, function: Callable, log: bool = False):&#10;Constructor.&#10;`function` - a function processing arguments using argparse()&#10;`log` - output diagnostics if True">
<text text-anchor="start" x="307.5" y="-149" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">__init__()</text>
</a>
</g>
<g id="a_node10_38"><a xlink:href="#" xlink:title="mine_ebnf_grammar(self):&#10;Extract EBNF option grammar">
<text text-anchor="start" x="307.5" y="-136.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mine_ebnf_grammar()</text>
</a>
</g>
<g id="a_node10_39"><a xlink:href="#" xlink:title="mine_grammar(self):&#10;Extract BNF option grammar">
<text text-anchor="start" x="307.5" y="-123.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="10.00">mine_grammar()</text>
</a>
</g>
<g id="a_node10_40"><a xlink:href="#" xlink:title="add_group(self, locals, exclusive)">
<text text-anchor="start" x="307.5" y="-109.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_group()</text>
</a>
</g>
<g id="a_node10_41"><a xlink:href="#" xlink:title="add_int_rule(self)">
<text text-anchor="start" x="307.5" y="-97" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_int_rule()</text>
</a>
</g>
<g id="a_node10_42"><a xlink:href="#" xlink:title="add_metavar_rule(self, metavar, type_)">
<text text-anchor="start" x="307.5" y="-84.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_metavar_rule()</text>
</a>
</g>
<g id="a_node10_43"><a xlink:href="#" xlink:title="add_parameter(self, kwargs, metavar)">
<text text-anchor="start" x="307.5" y="-71.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_parameter()</text>
</a>
</g>
<g id="a_node10_44"><a xlink:href="#" xlink:title="add_str_rule(self)">
<text text-anchor="start" x="307.5" y="-58.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_str_rule()</text>
</a>
</g>
<g id="a_node10_45"><a xlink:href="#" xlink:title="add_type_rule(self, type_)">
<text text-anchor="start" x="307.5" y="-46" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">add_type_rule()</text>
</a>
</g>
<g id="a_node10_46"><a xlink:href="#" xlink:title="process_arg(self, arg, in_group, kwargs)">
<text text-anchor="start" x="307.5" y="-33.25" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process_arg()</text>
</a>
</g>
<g id="a_node10_47"><a xlink:href="#" xlink:title="process_argument(self, locals, in_group)">
<text text-anchor="start" x="307.5" y="-20.5" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">process_argument()</text>
</a>
</g>
<g id="a_node10_48"><a xlink:href="#" xlink:title="traceit(self, frame, event, arg)">
<text text-anchor="start" x="307.5" y="-7.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="10.00">traceit()</text>
</a>
</g>
</a>
</g>
</a>
</g>
</g>
<!-- Legend -->
<g id="node11" class="node">
<title>Legend</title>
<text text-anchor="start" x="458.88" y="-126.75" font-family="Patua One, Helvetica, sans-serif" font-weight="bold" font-size="10.00" fill="#b03a2e">Legend</text>
<text text-anchor="start" x="458.88" y="-116.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-116.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-weight="bold" font-size="8.00">public_method()</text>
<text text-anchor="start" x="458.88" y="-106.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-106.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-size="8.00">private_method()</text>
<text text-anchor="start" x="458.88" y="-96.75" font-family="Patua One, Helvetica, sans-serif" font-size="10.00">• </text>
<text text-anchor="start" x="464.88" y="-96.75" font-family="'Fira Mono', 'Source Code Pro', 'Courier', monospace" font-style="italic" font-size="8.00">overloaded_method()</text>
<text text-anchor="start" x="458.88" y="-87.7" font-family="Helvetica,sans-Serif" font-size="9.00">Hover over names to see doc</text>
</g>
</g>
</svg>
</p>
</div>
</div>
</div>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Configuration-Options">Configuration Options</h2><p>When we talk about the input to a program, we usually think of the <em>data</em> it processes. This is also what we have been fuzzing in the past chapters – be it with <a href="Fuzzer.html">random input</a>, <a href="MutationFuzzer.html">mutation-based fuzzing</a>, or <a href="GrammarFuzzer.html">grammar-based fuzzing</a>.  However, programs typically have several input sources, all of which can and should be tested – and included in test generation.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>One important source of input is the program's <em>configuration</em> – that is, a set of inputs that typically is set once when beginning to process data and then stays constant while processing data, while the program is running, or even while the program is deployed.  Such a configuration is frequently set in <em>configuration files</em> (for instance, as key/value pairs); the most ubiquitous method for command-line tools, though, are <em>configuration options</em> on the command line.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As an example, consider the <code>grep</code> utility to find textual patterns in files.  The exact mode by which <code>grep</code> works is governed by a multitude of options, which can be listed by providing a <code>--help</code> option:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="o">!</span>grep<span class="w"> </span>--help
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: grep [-abcdDEFGHhIiJLlMmnOopqRSsUVvwXxZz] [-A num] [-B num] [-C[num]]
	[-e pattern] [-f file] [--binary-files=value] [--color=when]
	[--context[=num]] [--directories=action] [--label] [--line-buffered]
	[--null] [pattern] [file ...]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>All these options need to be tested for whether they operate correctly.  In security testing, any such option may also trigger a yet unknown vulnerability.  Hence, such options can become <em>fuzz targets</em> on their own.  In this chapter, we analyze how to systematically test such options – and better yet, how to extract possible configurations right out of given program files, such that we do not have to specify anything.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Options-in-Python">Options in Python</h2><p>Let us stick to our common programming language here and examine how options are processed in Python.  The <code>argparse</code> module provides a parser for command-line arguments (and options) with great functionality – and great complexity.  You start by defining a parser (<code>argparse.ArgumentParser()</code>) to which individual arguments with various features are added, one after another.  Additional parameters for each argument can specify the type (<code>type</code>) of the argument (say, integers or strings), or the number of arguments (<code>nargs</code>).</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>By default, arguments are stored under their name in the <code>args</code> object coming from <code>parse_args()</code> – thus, <code>args.integers</code> holds the <code>integer</code> arguments added earlier.  Special actions (<code>actions</code>) allow storing specific values in given variables; the <code>store_const</code> action stores the given <code>const</code> in the attribute named by <code>dest</code>.  The following example takes a number of integer arguments (<code>integers</code>) as well as an operator (<code>--sum</code>, <code>--min</code>, or <code>--max</code>) to be applied on these integers.  The operators all store a function reference in the <code>accumulate</code> attribute, which is finally invoked on the integers parsed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/argparse.html" class="import" target="_blank">argparse</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">process_numbers</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'Process some integers.'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'integers'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'an integer for the accumulator'</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--sum'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'accumulate'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_const'</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">sum</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">'sum the integers'</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--min'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'accumulate'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_const'</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">min</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">'compute the minimum'</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--max'</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">'accumulate'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_const'</span><span class="p">,</span>
                       <span class="n">const</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">'compute the maximum'</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">accumulate</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">integers</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's how <code>process_numbers()</code> works.  We can, for instance, invoke the <code>--min</code> option on the given arguments to compute the minimum:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers</span><span class="p">([</span><span class="s2">"--min"</span><span class="p">,</span> <span class="s2">"100"</span><span class="p">,</span> <span class="s2">"200"</span><span class="p">,</span> <span class="s2">"300"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>100
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Or compute the sum of three numbers:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers</span><span class="p">([</span><span class="s2">"--sum"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>6
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When defined via <code>add_mutually_exclusive_group()</code> (as above), options are mutually exclusive.  Consequently, we can have only one operator:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://github.com/uds-se/fuzzingbook//tree/master/notebooks/shared/bookutils" class="import" target="_blank">bookutils.setup</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="ExpectError.html" class="import" target="_blank">ExpectError</a></span> <span class="kn">import</span> <span class="n">ExpectError</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">ExpectError</span><span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="n">print_traceback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">process_numbers</span><span class="p">([</span><span class="s2">"--sum"</span><span class="p">,</span> <span class="s2">"--max"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>usage: ipykernel_launcher.py [-h] (--sum | --min | --max) N [N ...]
ipykernel_launcher.py: error: argument --max: not allowed with argument --sum
SystemExit: 2 (expected)
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="A-Grammar-for-Configurations">A Grammar for Configurations</h2><p>How can we test a system with several options?  The easiest answer is to write a grammar for it.  The grammar <code>PROCESS_NUMBERS_EBNF_GRAMMAR</code> reflects the possible combinations of options and arguments:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Grammars.html" class="import" target="_blank">Grammars</a></span> <span class="kn">import</span> <span class="n">crange</span><span class="p">,</span> <span class="n">srange</span><span class="p">,</span> <span class="n">convert_ebnf_grammar</span><span class="p">,</span> <span class="n">extend_grammar</span><span class="p">,</span> <span class="n">is_valid_grammar</span>
<span class="kn">from</span> <span class="nn"><a href="Grammars.html" class="import" target="_blank">Grammars</a></span> <span class="kn">import</span> <span class="n">START_SYMBOL</span><span class="p">,</span> <span class="n">new_symbol</span><span class="p">,</span> <span class="n">Grammar</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">:</span> <span class="n">Grammar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"&lt;start&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;operator&gt; &lt;integers&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;operator&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"--sum"</span><span class="p">,</span> <span class="s2">"--min"</span><span class="p">,</span> <span class="s2">"--max"</span><span class="p">],</span>
    <span class="s2">"&lt;integers&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;integer&gt;"</span><span class="p">,</span> <span class="s2">"&lt;integers&gt; &lt;integer&gt;"</span><span class="p">],</span>
    <span class="s2">"&lt;integer&gt;"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"&lt;digit&gt;+"</span><span class="p">],</span>
    <span class="s2">"&lt;digit&gt;"</span><span class="p">:</span> <span class="n">crange</span><span class="p">(</span><span class="s1">'0'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">PROCESS_NUMBERS_GRAMMAR</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_EBNF_GRAMMAR</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can feed this grammar into our <a href="GrammarCoverageFuzzer.html">grammar coverage fuzzer</a> and have it cover one option after another:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="GrammarCoverageFuzzer.html" class="import" target="_blank">GrammarCoverageFuzzer</a></span> <span class="kn">import</span> <span class="n">GrammarCoverageFuzzer</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--max 9 5 8 210 80 9756431
--sum 9 4 99 1245 612370
--min 2 3 0 46 15798 7570926
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Of course, we can also invoke <code>process_numbers()</code> with these very arguments. To this end, we need to convert the string produced by the grammar back into a list of individual arguments, using <code>split()</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">PROCESS_NUMBERS_GRAMMAR</span><span class="p">,</span> <span class="n">min_nonterminals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">process_numbers</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>['--max', '8', '9', '3067', '44', '13852967057']
13852967057
['--sum', '9', '8', '63', '9278111', '59206197798']
59215475989
['--min', '4', '1', '4864', '33342', '7827970808951']
1
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Similarly, we can define grammars for any program to be tested; as well as define grammars for, say, configuration files.  Yet, the grammar has to be updated with every change to the program, which creates a maintenance burden.  Given that the information required for the grammar is already all encoded in the program, the question arises: <em>Can't we go and extract configuration options right out of the program in the first place?</em></p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Mining-Configuration-Options">Mining Configuration Options</h2><p>In this section, we try to extract option and argument information right out of a program, such that we do not have to specify a configuration grammar.  The aim is to have a configuration fuzzer that works on the options and arguments of an arbitrary program, as long as it follows specific conventions for processing its arguments.  In the case of Python programs, this means using the <code>argparse</code> module.</p>
<p>Our idea is as follows: We execute the given program up to the point where the arguments are actually parsed – that is, <code>argparse.parse_args()</code> is invoked.  Up to this point, we track all calls into the argument parser, notably those calls that define arguments and options (<code>add_argument()</code>).  From these, we construct the grammar.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Tracking-Arguments">Tracking Arguments</h3><p>Let us illustrate this approach with a simple experiment: We define a trace function (see <a href="Coverage.html">our chapter on coverage</a> for details) that is active while <code>process_numbers</code> is invoked.  If we have a call to a method <code>add_argument</code>, we access and print out the local variables (which at this point are the arguments to the method).</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/sys.html" class="import" target="_blank">sys</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/string.html" class="import" target="_blank">string</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">trace_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">"call"</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s2">"add_argument"</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="nb">locals</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>What we get is a list of all calls to <code>add_argument()</code>, together with the method arguments passed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_locals</span><span class="p">)</span>
<span class="n">process_numbers</span><span class="p">([</span><span class="s2">"--sum"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">])</span>
<span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>add_argument {'self': ArgumentParser(prog='ipykernel_launcher.py', usage=None, description='Process some integers.', formatter_class=&lt;class 'argparse.HelpFormatter'&gt;, conflict_handler='error', add_help=True), 'args': ('-h', '--help'), 'kwargs': {'action': 'help', 'default': '==SUPPRESS==', 'help': 'show this help message and exit'}}
add_argument {'self': ArgumentParser(prog='ipykernel_launcher.py', usage=None, description='Process some integers.', formatter_class=&lt;class 'argparse.HelpFormatter'&gt;, conflict_handler='error', add_help=True), 'args': ('integers',), 'kwargs': {'metavar': 'N', 'type': &lt;class 'int'&gt;, 'nargs': '+', 'help': 'an integer for the accumulator'}}
add_argument {'self': &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, 'args': ('--sum',), 'kwargs': {'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function sum&gt;, 'help': 'sum the integers'}}
add_argument {'self': &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, 'args': ('--min',), 'kwargs': {'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function min&gt;, 'help': 'compute the minimum'}}
add_argument {'self': &lt;argparse._MutuallyExclusiveGroup object at 0x11142f260&gt;, 'args': ('--max',), 'kwargs': {'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function max&gt;, 'help': 'compute the maximum'}}
6
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>From the <code>args</code> argument, we can access the individual options and arguments to be defined:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">trace_options</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">"call"</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s2">"add_argument"</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="nb">locals</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">[</span><span class="s1">'args'</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">trace_options</span><span class="p">)</span>
<span class="n">process_numbers</span><span class="p">([</span><span class="s2">"--sum"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">,</span> <span class="s2">"2"</span><span class="p">,</span> <span class="s2">"3"</span><span class="p">])</span>
<span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>('-h', '--help')
('integers',)
('--sum',)
('--min',)
('--max',)
6
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see that each argument comes as a tuple with one (say, <code>integers</code> or <code>--sum</code>) or two members (<code>-h</code> and <code>--help</code>), which denote alternate forms for the same option.  Our job will be to go through the arguments of <code>add_arguments()</code> and detect not only the names of options and arguments, but also whether they accept additional parameters, as well as the type of the parameters.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="A-Grammar-Miner-for-Options-and-Arguments">A Grammar Miner for Options and Arguments</h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now build a class that gathers all this information to create a grammar.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We use the <code>ParseInterrupt</code> exception to interrupt program execution after gathering all arguments and options:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">ParseInterrupt</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The class <code>OptionGrammarMiner</code> takes an executable function for which the grammar of options and arguments is to be mined:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Helper class for extracting option grammars"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Constructor.</span>
<span class="sd">        `function` - a function processing arguments using argparse()</span>
<span class="sd">        `log` - output diagnostics if True</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>mine_ebnf_grammar()</code> is where everything happens.  It creates a grammar of the form</p>

<pre><code>&lt;start&gt; ::= &lt;option&gt;* &lt;arguments&gt;
&lt;option&gt; ::= &lt;empty&gt;
&lt;arguments&gt; ::= &lt;empty&gt;</code></pre>
<p>in which the options and arguments will be collected.  It then sets a trace function (see <a href="Coverage.html">our chapter on coverage</a> for details) that is active while the previously defined <code>function</code> is invoked.  Raising <code>ParseInterrupt</code> (when <code>parse_args()</code> is invoked) ends execution.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="n">OPTION_SYMBOL</span> <span class="o">=</span> <span class="s2">"&lt;option&gt;"</span>
    <span class="n">ARGUMENTS_SYMBOL</span> <span class="o">=</span> <span class="s2">"&lt;arguments&gt;"</span>

    <span class="k">def</span> <span class="nf">mine_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Extract EBNF option grammar"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">START_SYMBOL</span><span class="p">:</span> <span class="p">[</span><span class="s2">"("</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span> <span class="o">+</span> <span class="s2">")*"</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span><span class="p">:</span> <span class="p">[],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span>

        <span class="n">old_trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traceit</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ParseInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">old_trace</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span>

    <span class="k">def</span> <span class="nf">mine_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Extract BNF option grammar"""</span>
        <span class="k">return</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The trace function checks for four methods: <code>add_argument()</code> is the most important function, resulting in processing arguments; <code>frame.f_locals</code> again is the set of local variables, which at this point is mostly the arguments to <code>add_argument()</code>.  Since mutually exclusive groups also have a method <code>add_argument()</code>, we set the flag <code>in_group</code> to differentiate.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Note that we make no specific efforts to differentiate between multiple parsers or groups; we simply assume that there is one parser, and at any point at most one mutually exclusive group.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">traceit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">!=</span> <span class="s2">"call"</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">"self"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">self_var</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s2">"self"</span><span class="p">]</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

        <span class="k">if</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">"add_argument"</span><span class="p">:</span>
            <span class="n">in_group</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">self_var</span><span class="p">))</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"Group"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_argument</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span> <span class="n">in_group</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">"add_mutually_exclusive_group"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">"add_argument_group"</span><span class="p">:</span>
            <span class="c1"># self.add_group(frame.f_locals, exclusive=False)</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">method_name</span> <span class="o">==</span> <span class="s2">"parse_args"</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParseInterrupt</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traceit</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The <code>process_arguments()</code> now analyzes the arguments passed and adds them to the grammar:</p>
<ul>
<li>If the argument starts with <code>-</code>, it gets added as an optional element to the <code>&lt;option&gt;</code> list</li>
<li>Otherwise, it gets added to the <code>&lt;argument&gt;</code> list.</li>
</ul>
<p>The optional <code>nargs</code> argument specifies how many arguments can follow.  If it is a number, we add the appropriate number of elements to the grammar; if it is an abstract specifier (say, <code>+</code> or <code>*</code>), we use it directly as EBNF operator.</p>
<p>Given the large number of parameters and optional behavior, this is a somewhat messy function, but it does the job.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">in_group</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">"args"</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">"kwargs"</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_arg</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">in_group</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">in_group</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'-'</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_group</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span>
            <span class="n">metavar</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="s2">" "</span> <span class="o">+</span> <span class="n">arg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ARGUMENTS_SYMBOL</span>
            <span class="n">metavar</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="s2">""</span>

        <span class="k">if</span> <span class="s2">"nargs"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"nargs"</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_parameter</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">metavar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
            <span class="n">nargs</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nargs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">+=</span> <span class="n">param</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">nargs</span> <span class="ow">in</span> <span class="s2">"?+*"</span>
            <span class="n">arg</span> <span class="o">+=</span> <span class="s1">'('</span> <span class="o">+</span> <span class="n">param</span> <span class="o">+</span> <span class="s1">')'</span> <span class="o">+</span> <span class="n">nargs</span>

        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPTION_SYMBOL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>add_parameter()</code> handles possible parameters of options.  If the argument has an <code>action</code> defined, it takes no parameter.  Otherwise, we identify the type of the parameter (as <code>int</code> or <code>str</code>) and augment the grammar with an appropriate rule.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/inspect.html" class="import" target="_blank">inspect</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">metavar</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">"action"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c1"># No parameter</span>
            <span class="k">return</span> <span class="s2">""</span>

        <span class="n">type_</span> <span class="o">=</span> <span class="s2">"str"</span>
        <span class="k">if</span> <span class="s2">"type"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">given_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"type"</span><span class="p">]</span>
            <span class="c1"># int types come as '&lt;class int&gt;'</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">given_type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">given_type</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="s2">"int"</span>

        <span class="k">if</span> <span class="n">metavar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">"metavar"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">metavar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"metavar"</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metavar</span> <span class="o">=</span> <span class="n">type_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_type_rule</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metavar</span> <span class="o">!=</span> <span class="n">type_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metavar_rule</span><span class="p">(</span><span class="n">metavar</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>

        <span class="n">param</span> <span class="o">=</span> <span class="s2">" &lt;"</span> <span class="o">+</span> <span class="n">metavar</span> <span class="o">+</span> <span class="s2">"&gt;"</span>

        <span class="k">return</span> <span class="n">param</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>add_type_rule()</code> adds a rule for parameter types to the grammar.  If the parameter is identified by a meta-variable (say, <code>N</code>), we add a rule for this as well to improve legibility.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_type_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">"int"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_int_rule</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_str_rule</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_int_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">"&lt;int&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"(-)?&lt;digit&gt;+"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">"&lt;digit&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="n">crange</span><span class="p">(</span><span class="s1">'0'</span><span class="p">,</span> <span class="s1">'9'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_str_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">"&lt;str&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;char&gt;+"</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">"&lt;char&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="n">srange</span><span class="p">(</span>
            <span class="n">string</span><span class="o">.</span><span class="n">digits</span>
            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span>
            <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_metavar_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metavar</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="s2">"&lt;"</span> <span class="o">+</span> <span class="n">metavar</span> <span class="o">+</span> <span class="s2">"&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"&lt;"</span> <span class="o">+</span> <span class="n">type_</span> <span class="o">+</span> <span class="s2">"&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The method <code>add_group()</code> adds a new mutually exclusive group to the grammar.  We define a new symbol (say, <code>&lt;group&gt;</code>) for the options added to the group, and use the <code>required</code> and <code>exclusive</code> flags to define an appropriate expansion operator.  The group is then prefixed to the grammar, as in</p>

<pre><code>&lt;start&gt; ::= &lt;group&gt;&lt;option&gt;* &lt;arguments&gt;
&lt;group&gt; ::= &lt;empty&gt;</code></pre>
<p>and filled with the next calls to <code>add_argument()</code> within the group.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionGrammarMiner</span><span class="p">(</span><span class="n">OptionGrammarMiner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">locals</span><span class="p">,</span> <span class="n">exclusive</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">[</span><span class="s2">"kwargs"</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">required</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"required"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">new_symbol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">,</span> <span class="s2">"&lt;group&gt;"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">"+"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">"?"</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclusive</span><span class="p">:</span>
            <span class="n">group_expansion</span> <span class="o">=</span> <span class="n">group</span> <span class="o">+</span> <span class="s2">"*"</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">START_SYMBOL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_expansion</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">START_SYMBOL</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_group</span> <span class="o">=</span> <span class="n">group</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>That's it!  With this, we can now extract the grammar from our <code>process_numbers()</code> program.  Turning on logging again reveals the variables we draw upon.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">miner</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span><span class="p">(</span><span class="n">process_numbers</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">process_numbers_grammar</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>('-h', '--help')
{'action': 'help', 'default': '==SUPPRESS==', 'help': 'show this help message and exit'}

('integers',)
{'metavar': 'N', 'type': &lt;class 'int'&gt;, 'nargs': '+', 'help': 'an integer for the accumulator'}

{'required': True}
('--sum',)
{'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function sum&gt;, 'help': 'sum the integers'}

('--min',)
{'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function min&gt;, 'help': 'compute the minimum'}

('--max',)
{'dest': 'accumulate', 'action': 'store_const', 'const': &lt;built-in function max&gt;, 'help': 'compute the maximum'}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here is the extracted grammar:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>{'&lt;start&gt;': ['&lt;group&gt;(&lt;option&gt;)*&lt;arguments&gt;'],
 '&lt;option&gt;': [' -h', ' --help'],
 '&lt;arguments&gt;': ['( &lt;integers&gt;)+'],
 '&lt;int&gt;': ['(-)?&lt;digit&gt;+'],
 '&lt;digit&gt;': ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
 '&lt;integers&gt;': ['&lt;int&gt;'],
 '&lt;group&gt;': [' --sum', ' --min', ' --max']}
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The grammar properly identifies the group found:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;start&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['&lt;group&gt;(&lt;option&gt;)*&lt;arguments&gt;']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;group&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[' --sum', ' --min', ' --max']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>It also identifies a <code>--help</code> option provided not by us, but by the <code>argparse</code> module:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;option&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>[' -h', ' --help']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The grammar also correctly identifies the types of the arguments:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;arguments&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['( &lt;integers&gt;)+']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;integers&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['&lt;int&gt;']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The rules for <code>int</code> are set as defined by <code>add_int_rule()</code></p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">process_numbers_grammar</span><span class="p">[</span><span class="s2">"&lt;int&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['(-)?&lt;digit&gt;+']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can take this grammar and convert it to BNF, such that we can fuzz with it right away:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">process_numbers_grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">process_numbers_grammar</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> --sum 9
 --max -h --help --help -16 -0
 --min --help 2745341 8
 --min 1 27
 --sum --help --help -2
 --sum --help 0 3 -77
 --sum -3
 --sum --help 429 8 10 0295 -694 1
 --max -h 91 -1425 99
 --sum -795 -94 8 -44
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Each and every invocation adheres to the rules as set forth in the <code>argparse</code> calls.  By mining options and arguments from existing programs, we can now fuzz these options out of the box – without having to specify a grammar.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Testing-Autopep8">Testing Autopep8</h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us try out the option grammar miner on real-world Python programs.  <code>autopep8</code> is a tool that automatically converts Python code to the <a href="https://www.python.org/dev/peps/pep-0008/">PEP 8 Style Guide for Python Code</a>.  (Actually, all Python code in this book runs through <code>autopep8</code> during production.)  <code>autopep8</code> offers a wide range of options, as can be seen by invoking it with <code>--help</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="o">!</span>autopep8<span class="w"> </span>--help
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>usage: autopep8 [-h] [--version] [-v] [-d] [-i] [--global-config filename]
                [--ignore-local-config] [-r] [-j n] [-p n] [-a]
                [--experimental] [--exclude globs] [--list-fixes]
                [--ignore errors] [--select errors] [--max-line-length n]
                [--line-range line line] [--hang-closing] [--exit-code]
                [files ...]

Automatically formats Python code to conform to the PEP 8 style guide.

positional arguments:
  files                 files to format or '-' for standard in

options:
  -h, --help            show this help message and exit
  --version             show program's version number and exit
  -v, --verbose         print verbose messages; multiple -v result in more
                        verbose messages
  -d, --diff            print the diff for the fixed source
  -i, --in-place        make changes to files in place
  --global-config filename
                        path to a global pep8 config file; if this file does
                        not exist then this is ignored (default:
                        /Users/zeller/.config/pep8)
  --ignore-local-config
                        don't look for and apply local config files; if not
                        passed, defaults are updated with any config files in
                        the project's root directory
  -r, --recursive       run recursively over directories; must be used with
                        --in-place or --diff
  -j n, --jobs n        number of parallel jobs; match CPU count if value is
                        less than 1
  -p n, --pep8-passes n
                        maximum number of additional pep8 passes (default:
                        infinite)
  -a, --aggressive      enable non-whitespace changes; multiple -a result in
                        more aggressive changes
  --experimental        enable experimental fixes
  --exclude globs       exclude file/directory names that match these comma-
                        separated globs
  --list-fixes          list codes for fixes; used by --ignore and --select
  --ignore errors       do not fix these errors/warnings (default:
                        E226,E24,W50,W690)
  --select errors       fix only these errors/warnings (e.g. E4,W)
  --max-line-length n   set maximum allowed line length (default: 79)
  --line-range line line, --range line line
                        only fix errors found within this inclusive range of
                        line numbers (e.g. 1 99); line numbers are indexed at
                        1
  --hang-closing        hang-closing option passed to pycodestyle
  --exit-code           change to behavior of exit code. default behavior of
                        return value, 0 is no differences, 1 is error exit.
                        return 2 when add this option. 2 is exists
                        differences.
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Autopep8-Setup">Autopep8 Setup</h3><p>We want to systematically test these options.  In order to deploy our configuration grammar miner, we need to find the source code of the executable:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/os.html" class="import" target="_blank">os</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">find_executable</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">get_exec_path</span><span class="p">():</span>
        <span class="n">qualified_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qualified_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">qualified_name</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">"autopep8"</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">autopep8_executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="n">autopep8_executable</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'/Users/zeller/.pyenv/versions/3.10.2/bin/autopep8'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Next, we build a function that reads the contents of the file and executes it.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">autopep8</span><span class="p">():</span>
    <span class="n">executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">"autopep8"</span><span class="p">)</span>

    <span class="c1"># First line has to contain "/usr/bin/env python" or like</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">first_line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"python"</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">executable</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Mining-an-Autopep8-Grammar">Mining an Autopep8 Grammar</h3><p>We can use the <code>autopep8()</code> function in our grammar miner:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_miner</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span><span class="p">(</span><span class="n">autopep8</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>and extract a grammar for it:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_ebnf_grammar</span> <span class="o">=</span> <span class="n">autopep8_miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This works because here, <code>autopep8</code> is not a separate process (and a separate Python interpreter), but we run the <code>autopep8()</code> function (and the <code>autopep8</code> code) in our current Python interpreter – up to the call to <code>parse_args()</code>, where we interrupt execution again.  At this point, the <code>autopep8</code> code has done nothing but setting up the argument parser – which is what we are interested in.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The grammar options mined reflect precisely the options seen when providing <code>--help</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[' -h', ' --help', ' --version', ' -v', ' --verbose', ' -d', ' --diff', ' -i', ' --in-place', ' --global-config &lt;filename&gt;', ' --ignore-local-config', ' -r', ' --recursive', ' -j &lt;n&gt;', ' --jobs &lt;n&gt;', ' -p &lt;n&gt;', ' --pep8-passes &lt;n&gt;', ' -a', ' --aggressive', ' --experimental', ' --exclude &lt;globs&gt;', ' --list-fixes', ' --ignore &lt;errors&gt;', ' --select &lt;errors&gt;', ' --max-line-length &lt;n&gt;', ' --line-range &lt;line&gt; &lt;line&gt;', ' --range &lt;line&gt; &lt;line&gt;', ' --indent-size &lt;int&gt;', ' --hang-closing', ' --exit-code']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Metavariables like <code>&lt;n&gt;</code> or <code>&lt;line&gt;</code> are placeholders for integers.  We assume all metavariables of the same name have the same type:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;line&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['&lt;int&gt;']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The grammar miner has inferred that the argument to <code>autopep8</code> is a list of files:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;arguments&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['( &lt;files&gt;)*']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>which in turn all are strings:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;files&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['&lt;str&gt;']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As we are only interested in testing options, not arguments, we fix the arguments to a single mandatory input.  (Otherwise, we'd have plenty of random file names generated.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;arguments&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">" &lt;files&gt;"</span><span class="p">]</span>
<span class="n">autopep8_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;files&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"foo.py"</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Creating-Autopep8-Options">Creating Autopep8 Options</h3></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now use the inferred grammar for fuzzing.  Again, we convert the EBNF grammar into a regular BNF grammar:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_grammar</span> <span class="o">=</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="n">autopep8_ebnf_grammar</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>And we can use the grammar for fuzzing all options:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> -r foo.py
 -h --experimental --hang-closing foo.py
 --list-fixes -v foo.py
 --aggressive -d foo.py
 --indent-size 9 --help foo.py
 --exit-code --recursive foo.py
 --diff --version -i foo.py
 --max-line-length 0 --in-place --verbose foo.py
 --ignore-local-config -a foo.py
 --select x -i --exit-code foo.py
 -j 8 --diff foo.py
 -d -v -d foo.py
 -p 6 -i foo.py
 -v --diff foo.py
 --ignore uA --recursive foo.py
 --jobs 5 -r foo.py
 --range 4 1 foo.py
 --ignore-local-config -i foo.py
 -r --exit-code foo.py
 -v -r foo.py
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us apply these options on the actual program.  We need a file <code>foo.py</code> that will serve as input: (Note that the following commands will overwrite the file <code>foo.py</code>, if it already exists in the current working directory. Be aware of this, if you downloaded the notebooks and are working locally.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">create_foo_py</span><span class="p">():</span>
    <span class="nb">open</span><span class="p">(</span><span class="s2">"foo.py"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">def twice(x = 2):</span>
<span class="s2">    return  x  +  x</span>
<span class="s2">"""</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">create_foo_py</span><span class="p">()</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"foo.py"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
def twice(x = 2):
    return  x  +  x
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We see how <code>autopep8</code> fixes the spacing:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="o">!</span>autopep8<span class="w"> </span>foo.py
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
def twice(x=2):
    return x + x
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now put things together.  We define a <code>ProgramRunner</code> that will run the <code>autopep8</code> executable with arguments coming from the mined <code>autopep8</code> grammar.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Fuzzer.html" class="import" target="_blank">Fuzzer</a></span> <span class="kn">import</span> <span class="n">ProgramRunner</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Running <code>autopep8</code> with the mined options reveals a surprisingly high number of passing runs.  (We see that some options depend on each other or are mutually exclusive, but this is handled by the program logic, not the argument parser, and hence out of our scope.)  The <code>GrammarCoverageFuzzer</code> ensures that each option is tested at least once.  (Digits and letters, too, by the way.)</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">f</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">autopep8_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">invocation</span> <span class="o">=</span> <span class="s2">"autopep8"</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"$ "</span> <span class="o">+</span> <span class="n">invocation</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">ProgramRunner</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">outcome</span> <span class="o">=</span> <span class="n">autopep8_runner</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>$ autopep8 foo.py
$ autopep8 --diff --max-line-length 4 --exit-code --range 5 8 -p 2 foo.py
$ autopep8 --ignore z --verbose -r --list-fixes foo.py
--recursive must be used with --in-place or --diff$ autopep8 --exclude 5 -h -i --aggressive --in-place foo.py
$ autopep8 --select a --help --experimental foo.py
$ autopep8 --indent-size -30 --recursive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --global-config &lt; -j 9 -v -a foo.py
parallel jobs requires --in-place$ autopep8 --line-range 7 1 --hang-closing -d foo.py
First value of --range should be less than or equal to the second$ autopep8 --pep8-passes 6 --hang-closing --version --ignore-local-config foo.py
$ autopep8 --jobs -2 --experimental --version foo.py
$ autopep8 --ignore Y: --select ! --global-config e foo.py
$ autopep8 --select 1 -a --recursive --aggressive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --ignore * --ignore `0 --global-config _ --verbose foo.py
[file:foo.py]
---&gt;  Applying global fix for E265
---&gt;  5 issue(s) to fix {'E251': {2}, 'E271': {3}, 'E221': {3}, 'E222': {3}}
---&gt;  3 issue(s) to fix {'E251': {2}, 'E221': {3}, 'E222': {3}}
---&gt;  1 issue(s) to fix {'E222': {3}}
---&gt;  0 issue(s) to fix {}
$ autopep8 --global-config ,\ --exclude r -v foo.py
[file:foo.py]
---&gt;  Applying global fix for E265
---&gt;  5 issue(s) to fix {'E251': {2}, 'E271': {3}, 'E221': {3}, 'E222': {3}}
---&gt;  3 issue(s) to fix {'E251': {2}, 'E221': {3}, 'E222': {3}}
---&gt;  1 issue(s) to fix {'E222': {3}}
---&gt;  0 issue(s) to fix {}
$ autopep8 --global-config xd6M --recursive foo.py
--recursive must be used with --in-place or --diff$ autopep8 --select R --exclude L --version --ignore-local-config foo.py
$ autopep8 --select " --verbose -h -d foo.py
$ autopep8 --diff -i -h foo.py
$ autopep8 --in-place --select w --version -i foo.py
$ autopep8 --ignore 49 --exclude lI -i foo.py
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our <code>foo.py</code> file now has been formatted in place a number of times:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"foo.py"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
def twice(x=2):
    return x + x
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We don't need it anymore, so we clean up things:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/os.html" class="import" target="_blank">os</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"foo.py"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Classes-for-Fuzzing-Configuration-Options">Classes for Fuzzing Configuration Options</h2><p>Let us now create reusable classes that we can use for testing arbitrary programs.  (Okay, make that "arbitrary programs that are written in Python and use the <code>argparse</code> module to process command-line arguments.")</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The class <code>OptionRunner</code> is a subclass of <code>ProgramRunner</code> that takes care of automatically determining the grammar, using the same steps we used for <code>autopep8</code>, above.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="Grammars.html" class="import" target="_blank">Grammars</a></span> <span class="kn">import</span> <span class="n">unreachable_nonterminals</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">ProgramRunner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Run a program while determining its option grammar"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                 <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">miner_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">OptionGrammarMiner</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Constructor.</span>
<span class="sd">        `program` - the (Python) program to be executed</span>
<span class="sd">        `arguments` - an (optional) string with arguments for `program`</span>
<span class="sd">        `log` - if True, enable logging in miner</span>
<span class="sd">        `miner_class` - the `OptionGrammarMiner` class to be used</span>
<span class="sd">                  (default: `OptionGrammarMiner`)</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">=</span> <span class="n">program</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">=</span> <span class="n">program</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">miner_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">miner_class</span> <span class="o">=</span> <span class="n">OptionGrammarMiner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miner_class</span> <span class="o">=</span> <span class="n">miner_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">find_contents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_grammar</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_arguments</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">program</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>First, we find the contents of the Python executable:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">+</span> <span class="s2">": not found"</span><span class="p">)</span>

        <span class="n">first_line</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_executable</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">first_line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">"python"</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_executable</span> <span class="o">+</span> <span class="s2">": not a Python executable"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_executable</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">invoker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We are passing the local variables as is, such that we can access `self`</span>
        <span class="c1"># We set __name__ to '__main__' to invoke the script as an executable</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">,</span> <span class="p">{</span><span class="s1">'__name__'</span><span class="p">:</span> <span class="s1">'__main__'</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executable</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Next, we determine the grammar using the <code>OptionGrammarMiner</code> class:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">miner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">miner_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invoker</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span> <span class="o">=</span> <span class="n">miner</span><span class="o">.</span><span class="n">mine_ebnf_grammar</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return extracted grammar in EBNF form"""</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span>

    <span class="k">def</span> <span class="nf">grammar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return extracted grammar in BNF form"""</span>
        <span class="k">return</span> <span class="n">convert_ebnf_grammar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The two service methods <code>set_arguments()</code> and <code>set_invocation()</code> help us to change the arguments and program, respectively.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionRunner</span><span class="p">(</span><span class="n">OptionRunner</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">[</span><span class="s2">"&lt;arguments&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">" "</span> <span class="o">+</span> <span class="n">args</span><span class="p">]</span>
        <span class="c1"># Delete rules for previous arguments</span>
        <span class="k">for</span> <span class="n">nonterminal</span> <span class="ow">in</span> <span class="n">unreachable_nonterminals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ebnf_grammar</span><span class="p">[</span><span class="n">nonterminal</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_invocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can instantiate the class on <code>autopep8</code> and immediately get the grammar:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">"autopep8"</span><span class="p">,</span> <span class="s2">"foo.py"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[' -h', ' --help', ' --version', ' -v', ' --verbose', ' -d', ' --diff', ' -i', ' --in-place', ' --global-config &lt;filename&gt;', ' --ignore-local-config', ' -r', ' --recursive', ' -j &lt;n&gt;', ' --jobs &lt;n&gt;', ' -p &lt;n&gt;', ' --pep8-passes &lt;n&gt;', ' -a', ' --aggressive', ' --experimental', ' --exclude &lt;globs&gt;', ' --list-fixes', ' --ignore &lt;errors&gt;', ' --select &lt;errors&gt;', ' --max-line-length &lt;n&gt;', ' --line-range &lt;line&gt; &lt;line&gt;', ' --range &lt;line&gt; &lt;line&gt;', ' --indent-size &lt;int&gt;', ' --hang-closing', ' --exit-code']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>An <code>OptionFuzzer</code> interacts with the given <code>OptionRunner</code> to obtain its grammar, which is then passed to its <code>GrammarCoverageFuzzer</code> superclass.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionFuzzer</span><span class="p">(</span><span class="n">GrammarCoverageFuzzer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Fuzz a (Python) program using its arguments"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="n">OptionRunner</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Constructor. `runner` is an OptionRunner."""</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">runner</span><span class="p">),</span> <span class="n">OptionRunner</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">runner</span>
        <span class="n">grammar</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">grammar</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When invoking <code>run()</code>, the <code>OptionFuzzer</code> creates a new invocation (using <code>fuzz()</code> from its grammar) and runs the now given (or previously set) runner with the arguments from the grammar.  Note that the runner specified in <code>run()</code> can differ from the one set during initialization; this allows for mining options from one program and applying it in another context.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">OptionFuzzer</span><span class="p">(</span><span class="n">OptionFuzzer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">runner</span><span class="p">),</span> <span class="n">OptionRunner</span><span class="p">)</span>
        <span class="n">invocation</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">executable</span><span class="p">()</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">set_invocation</span><span class="p">(</span><span class="n">invocation</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Example:-Autopep8">Example: Autopep8</h3><p>Let us apply our newly defined classes on the <code>autopep8</code> runner:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> foo.py
 --in-place --ignore-local-config --jobs 6 --recursive -i foo.py
 --help -a --indent-size -95 --pep8-passes 3 --exclude = -r foo.py
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We can now systematically test <code>autopep8</code> with these classes:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_fuzzer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>(CompletedProcess(args=['/Users/zeller/.pyenv/versions/3.10.2/bin/autopep8', '--hang-closing', '--exit-code', '-d', '--version', 'foo.py'], returncode=0, stdout='autopep8 1.6.0 (pycodestyle: 2.12.1)\n', stderr=''),
 'PASS')
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Example:-MyPy">Example: MyPy</h3><p>We can extract options for the <code>mypy</code> static type checker for Python:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">"mypy"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">mypy_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">"mypy"</span><span class="p">,</span> <span class="s2">"foo.py"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[' -h', ' --help', ' -v', ' --verbose', ' -V', ' --version', ' -O &lt;FORMAT&gt;', ' --output &lt;FORMAT&gt;', ' --config-file &lt;str&gt;', ' --warn-unused-configs', ' --no-warn-unused-configs', ' --no-namespace-packages', ' --namespace-packages', ' --ignore-missing-imports', ' --follow-untyped-imports', ' --follow-imports &lt;str&gt;', ' --python-executable', ' --no-site-packages', ' --no-silence-site-packages', ' --python-version &lt;x.y&gt;', ' --platform', ' --always-true', ' --always-false', ' --disallow-any-expr', ' --disallow-any-decorated', ' --disallow-any-explicit', ' --disallow-any-generics', ' --allow-any-generics', ' --disallow-any-unimported', ' --allow-any-unimported', ' --disallow-subclassing-any', ' --allow-subclassing-any', ' --disallow-untyped-calls', ' --allow-untyped-calls', ' --untyped-calls-exclude', ' --disallow-untyped-defs', ' --allow-untyped-defs', ' --disallow-incomplete-defs', ' --allow-incomplete-defs', ' --check-untyped-defs', ' --no-check-untyped-defs', ' --disallow-untyped-decorators', ' --allow-untyped-decorators', ' --implicit-optional', ' --no-implicit-optional', ' --strict-optional', ' --no-strict-optional', ' --force-uppercase-builtins', ' --no-force-uppercase-builtins', ' --force-union-syntax', ' --no-force-union-syntax', ' --warn-redundant-casts', ' --no-warn-redundant-casts', ' --warn-unused-ignores', ' --no-warn-unused-ignores', ' --no-warn-no-return', ' --warn-no-return', ' --warn-return-any', ' --no-warn-return-any', ' --warn-unreachable', ' --no-warn-unreachable', ' --report-deprecated-as-note', ' --no-report-deprecated-as-note', ' --allow-untyped-globals', ' --disallow-untyped-globals', ' --allow-redefinition', ' --disallow-redefinition', ' --no-implicit-reexport', ' --implicit-reexport', ' --strict-equality', ' --no-strict-equality', ' --extra-checks', ' --no-extra-checks', ' --strict', ' --disable-error-code', ' --enable-error-code', ' --show-error-context', ' --hide-error-context', ' --show-column-numbers', ' --hide-column-numbers', ' --show-error-end', ' --hide-error-end', ' --hide-error-codes', ' --show-error-codes', ' --show-error-code-links', ' --hide-error-code-links', ' --pretty', ' --no-pretty', ' --no-color-output', ' --color-output', ' --no-error-summary', ' --error-summary', ' --show-absolute-path', ' --hide-absolute-path', ' --soft-error-limit &lt;int&gt;', ' -i', ' --incremental', ' --no-incremental', ' --cache-dir', ' --sqlite-cache', ' --no-sqlite-cache', ' --cache-fine-grained', ' --skip-version-check', ' --skip-cache-mtime-checks', ' --pdb', ' --show-traceback', ' --tb', ' --raise-exceptions', ' --custom-typing-module &lt;MODULE&gt;', ' --old-type-inference', ' --new-type-inference', ' --enable-incomplete-feature', ' --custom-typeshed-dir &lt;DIR&gt;', ' --warn-incomplete-stub', ' --no-warn-incomplete-stub', ' --shadow-file', ' --fast-exit', ' --no-fast-exit', ' --allow-empty-bodies', ' --disallow-empty-bodies', ' --export-ref-info', ' --any-exprs-report &lt;DIR&gt;', ' --cobertura-xml-report &lt;DIR&gt;', ' --html-report &lt;DIR&gt;', ' --linecount-report &lt;DIR&gt;', ' --linecoverage-report &lt;DIR&gt;', ' --lineprecision-report &lt;DIR&gt;', ' --txt-report &lt;DIR&gt;', ' --xml-report &lt;DIR&gt;', ' --xslt-html-report &lt;DIR&gt;', ' --xslt-txt-report &lt;DIR&gt;', ' --quickstart-file &lt;str&gt;', ' --junit-xml &lt;str&gt;', ' --junit-format &lt;str&gt;', ' --find-occurrences &lt;CLASS.MEMBER&gt;', ' --scripts-are-modules', ' --install-types', ' --no-install-types', ' --non-interactive', ' --interactive', ' --stats', ' --inferstats', ' --dump-build-stats', ' --timing-stats &lt;str&gt;', ' --line-checking-stats &lt;str&gt;', ' --debug-cache', ' --dump-deps', ' --dump-graph', ' --semantic-analysis-only', ' --test-env', ' --local-partial-types', ' --logical-deps', ' --bazel', ' --package-root', ' --cache-map( &lt;str&gt;)+', ' --debug-serialize', ' --disable-bytearray-promotion', ' --disable-memoryview-promotion', ' --strict-concatenate', ' --explicit-package-bases', ' --no-explicit-package-bases', ' --fast-module-lookup', ' --no-fast-module-lookup', ' --exclude', ' -m', ' --module', ' -p', ' --package', ' -c', ' --command']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">mypy_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">mypy_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mypy_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> --namespace-packages foo.py
 --no-warn-no-return --enable-incomplete-feature -m --disallow-empty-bodies foo.py
 --dump-deps --disallow-subclassing-any --disallow-any-decorated --show-error-end --no-install-types --cache-fine-grained --sqlite-cache --no-warn-unreachable --no-warn-return-any --force-uppercase-builtins --debug-serialize --disable-bytearray-promotion --implicit-reexport --linecount-report l --fast-exit --allow-untyped-globals --no-color-output --color-output --show-error-code-links --inferstats --cache-map @ S --allow-any-generics --error-summary foo.py
 --allow-subclassing-any --no-incremental --fast-module-lookup --no-site-packages --old-type-inference --allow-redefinition --no-force-uppercase-builtins --incremental --new-type-inference foo.py
 --disallow-any-explicit --no-implicit-optional --no-warn-incomplete-stub foo.py
 --disallow-any-unimported --warn-unused-configs --hide-error-codes --allow-untyped-calls --follow-untyped-imports foo.py
 -h --no-report-deprecated-as-note --xslt-txt-report ze --command --dump-graph foo.py
 --find-occurrences 1 --strict-optional --hide-column-numbers --export-ref-info foo.py
 --soft-error-limit 06 --semantic-analysis-only foo.py
 --no-pretty --no-strict-equality --no-namespace-packages --tb --pdb --warn-redundant-casts --strict --install-types --disable-memoryview-promotion foo.py
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Example:-Notedown">Example: Notedown</h3><p>Here's the configuration options for the <code>notedown</code> Notebook to Markdown converter:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">assert</span> <span class="n">find_executable</span><span class="p">(</span><span class="s2">"notedown"</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/warnings.html" class="import" target="_blank">warnings</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
    <span class="c1"># Workaround: `notedown` can issue a `DeprecationWarning`</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">"ignore"</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">notedown_runner</span> <span class="o">=</span> <span class="n">OptionRunner</span><span class="p">(</span><span class="s2">"notedown"</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">notedown_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[' -h', ' --help', ' -o( &lt;str&gt;)?', ' --output( &lt;str&gt;)?', ' --from &lt;str&gt;', ' --to &lt;str&gt;', ' --run', ' --execute', ' --timeout &lt;int&gt;', ' --strip', ' --precode( &lt;str&gt;)+', ' --knit( &lt;str&gt;)?', ' --rmagic', ' --nomagic', ' --render', ' --template &lt;str&gt;', ' --match &lt;str&gt;', ' --examples', ' --version', ' --debug']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">notedown_fuzzer</span> <span class="o">=</span> <span class="n">OptionFuzzer</span><span class="p">(</span><span class="n">notedown_runner</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">notedown_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> --version O[
 --help --from tF --match C --execute
 --timeout -50 --template ! --debug --examples --rmagic --output M4kI --strip --render mQ
 --run -h --nomagic c
 --to eW --render '
 -o --knit ^%J --precode } --render --execute --render $
 --precode . s -h --run \
 --nomagic -h --execute #
 --execute --run ai
 --output --knit --run --version --execute A
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Combinatorial-Testing">Combinatorial Testing</h2><p>Our <code>CoverageGrammarFuzzer</code> does a good job in covering each and every option at least once, which is great for systematic testing.  However, as we also can see in our examples above, some options require each other, while others interfere with each other.  What we should do as good testers is not only to cover every option individually, but also <em>combinations</em> of options.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The Python <code>itertools</code> module gives us means to create combinations from lists.  We can, for instance, take the <code>notedown</code> options and create a list of all pairs.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">from</span> <span class="nn"><a href="https://docs.python.org/3/library/itertools.html" class="import" target="_blank">itertools</a></span> <span class="kn">import</span> <span class="n">combinations</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">option_list</span> <span class="o">=</span> <span class="n">notedown_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">]</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>There's quite a number of pairs:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>190
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(' -h', ' --help'), (' -h', ' -o( &lt;str&gt;)?'), (' -h', ' --output( &lt;str&gt;)?'), (' -h', ' --from &lt;str&gt;'), (' -h', ' --to &lt;str&gt;'), (' -h', ' --run'), (' -h', ' --execute'), (' -h', ' --timeout &lt;int&gt;'), (' -h', ' --strip'), (' -h', ' --precode( &lt;str&gt;)+'), (' -h', ' --knit( &lt;str&gt;)?'), (' -h', ' --rmagic'), (' -h', ' --nomagic'), (' -h', ' --render'), (' -h', ' --template &lt;str&gt;'), (' -h', ' --match &lt;str&gt;'), (' -h', ' --examples'), (' -h', ' --version'), (' -h', ' --debug'), (' --help', ' -o( &lt;str&gt;)?')]
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Testing every such pair of options frequently suffices to cover all interferences between options.  (Programs rarely have conditions involving three or more configuration settings.)  To this end, we <em>change</em> the grammar from having a list of options to having a list of <em>option pairs</em>, such that covering these will automatically cover all pairs.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We create a function <code>pairwise()</code> that takes a list of options as occurring in our grammar and returns a list of <em>pairwise options</em> – that is, our original options, but concatenated.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">def</span> <span class="nf">pairwise</span><span class="p">(</span><span class="n">option_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">option_1</span> <span class="o">+</span> <span class="n">option_2</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">option_1</span><span class="p">,</span> <span class="n">option_2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Here's the first 20 pairs:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">print</span><span class="p">(</span><span class="n">pairwise</span><span class="p">(</span><span class="n">option_list</span><span class="p">)[:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[' -h --help', ' -h -o( &lt;str&gt;)?', ' -h --output( &lt;str&gt;)?', ' -h --from &lt;str&gt;', ' -h --to &lt;str&gt;', ' -h --run', ' -h --execute', ' -h --timeout &lt;int&gt;', ' -h --strip', ' -h --precode( &lt;str&gt;)+', ' -h --knit( &lt;str&gt;)?', ' -h --rmagic', ' -h --nomagic', ' -h --render', ' -h --template &lt;str&gt;', ' -h --match &lt;str&gt;', ' -h --examples', ' -h --version', ' -h --debug', ' --help -o( &lt;str&gt;)?']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The new grammar <code>pairwise_notedown_grammar</code> is a copy of the <code>notedown</code> grammar, but with the list of options replaced with the above pairwise option list.</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">notedown_grammar</span> <span class="o">=</span> <span class="n">notedown_runner</span><span class="o">.</span><span class="n">grammar</span><span class="p">()</span>
<span class="n">pairwise_notedown_grammar</span> <span class="o">=</span> <span class="n">extend_grammar</span><span class="p">(</span><span class="n">notedown_grammar</span><span class="p">)</span>
<span class="n">pairwise_notedown_grammar</span><span class="p">[</span><span class="s2">"&lt;option&gt;"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairwise</span><span class="p">(</span><span class="n">notedown_grammar</span><span class="p">[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
<span class="k">assert</span> <span class="n">is_valid_grammar</span><span class="p">(</span><span class="n">pairwise_notedown_grammar</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Using the "pairwise" grammar to fuzz now covers one pair after another:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">notedown_pairwise_fuzzer</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span>
    <span class="n">pairwise_notedown_grammar</span><span class="p">,</span> <span class="n">max_nonterminals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">notedown_pairwise_fuzzer</span><span class="o">.</span><span class="n">fuzz</span><span class="p">())</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre> --nomagic --debug
 -h --help --examples --version l
 --execute --examples --run --execute
 --execute --debug --render --debug
 --help --render --strip --version
 -h --debug _U
 --execute --render --render --version Q
 --execute --rmagic -h --run
 --rmagic --version --help --execute d
 --strip --render --examples --debug ?
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Can we actually test all combinations of options?  Not in practice, as the number of combinations quickly grows as the length increases.  It decreases again as the number of options reaches the maximum (with 20 options, there is only 1 combination involving <em>all</em> options), but the absolute numbers are still staggering:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">for</span> <span class="n">combination_length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="n">tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">option_list</span><span class="p">,</span> <span class="n">combination_length</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combination_length</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuples</span><span class="p">))</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>1 20
2 190
3 1140
4 4845
5 15504
6 38760
7 77520
8 125970
9 167960
10 184756
11 167960
12 125970
13 77520
14 38760
15 15504
16 4845
17 1140
18 190
19 20
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Formally, the number of combinations of length $k$ in a set of options of length $n$ is the binomial coefficient
$$
{n \choose k} = \frac{n!}{k!(n - k)!}
$$</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>which for $k = 2$ (all pairs) gives us</p>
<p>$$
{n \choose 2} = \frac{n!}{2(n - 2)!} = \frac{n (n - 1)}{2}
$$</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For <code>autopep8</code> with its 30 options...</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>30
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>... we thus need 870 tests to cover all pairs:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span> <span class="o">*</span> \
    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>870
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For <code>mypy</code> with its 140+ options, though, we already end up with 20,000+ tests to be conducted:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>170
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span> <span class="o">*</span> \
    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mypy_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;option&gt;"</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>28730
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Even if each pair takes a second to run, we'd still be done in three hours of testing, though.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If your program has more options that you all want to get covered in combinations, it is advisable that you limit the number of configurations further – for instance by limiting combinatorial testing to those combinations that possibly can interact with each other; and covering all other (presumably orthogonal) options individually.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>This mechanism of creating configurations by extending grammars can be easily extended to other configuration targets.  One may want to explore a greater number of configurations, or expansions in specific contexts.  The <a href="#Exercises">exercises</a>, below, have a number of options ready for you.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Lessons-Learned">Lessons Learned</h2><ul>
<li>Besides regular input data, program <em>configurations</em> make an important testing target.</li>
<li>For a given program using a standard library to parse command-line options and arguments, one can automatically extract these and convert them into a grammar.</li>
<li>To cover not only single options, but combinations of options, one can expand the grammar to cover all pairs, or come up with even more ambitious targets.</li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Next-Steps">Next Steps</h2><p>If you liked the idea of mining a grammar from a program, do not miss:</p>
<ul>
<li><a href="GrammarMiner.html">how to mine grammars for input data</a></li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Our next steps in the book focus on:</p>
<ul>
<li><a href="Parser.html">how to parse and recombine inputs</a></li>
<li><a href="ProbabilisticGrammarFuzzer.html">how to assign weights and probabilities to specific productions</a></li>
<li><a href="Reducer.html">how to simplify inputs that cause a failure</a></li>
</ul>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Background">Background</h2><p>Although configuration data is just as likely to cause failures as other input data, it has received relatively little attention in test generation – possibly because, unlike "regular" input data, configuration data is not so much under control of external parties, and because, again unlike regular data, there is little variance in configurations.  Creating models for software configurations and using these models for testing is commonplace, as is the idea of pairwise testing.  For an overview, see [<a href="http://ix.cs.uoregon.edu/~michal/book/">Pezzè <em>et al</em>, 2008</a>]; for a discussion and comparison of state-of-the-art techniques, see [<a href="https://doi.org/10.1109/TSE.2015.2421279">J. Petke <em>et al</em>, 2015</a>].</p>
<p>More specifically, [<a href="http://www.fuzzing.org/">Sutton <em>et al</em>, 2007</a>] also discuss techniques to systematically cover command-line options.  Dai et al. [<a href="https://doi.org/10.4018/jsse.2010070103">Dai <em>et al</em>, 2010</a>] apply configuration fuzzing by changing variables associated with configuration files.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Exercises">Exercises</h2></div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-1:-#ifdef-Configuration-Fuzzing">Exercise 1: #ifdef Configuration Fuzzing</h3><p>In C programs, the <em>C preprocessor</em> can be used to choose which code parts should be compiled and which ones should not.  As an example, in the C code</p>
<div class="highlight"><pre><span/><span class="cp">#ifdef LONG_FOO</span>
<span class="kt">long</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
<p>the compiler will compile the function <code>foo()</code> with return type<code>long</code> if the <em>preprocessor variable</em> <code>LONG_FOO</code> is defined, and with return type <code>int</code> if not.  Such preprocessor variables are either set in the source files (using <code>#define</code>, as in <code>#define LONG_FOO</code>) or on the C compiler command line (using <code>-D&lt;variable&gt;</code> or <code>-D&lt;variable&gt;=&lt;value&gt;</code>, as in <code>-DLONG_FOO</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Such <em>conditional compilation</em> is used to configure C programs towards their environment.  System-specific code can contain lots of conditional compilation.  As an example, consider this excerpt of <code>xmlparse.c</code>, the XML parser that is part of the Python runtime library:</p>
<div class="highlight"><pre><span/><span class="cp">#if defined(_WIN32) &amp;&amp; !defined(LOAD_LIBRARY_SEARCH_SYSTEM32)</span>
<span class="cp"># define LOAD_LIBRARY_SEARCH_SYSTEM32  0x00000800</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(HAVE_GETRANDOM) &amp;&amp; !defined(HAVE_SYSCALL_GETRANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(HAVE_ARC4RANDOM_BUF) &amp;&amp; !defined(HAVE_ARC4RANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(XML_DEV_URANDOM) \</span>
<span class="cp">    &amp;&amp; !defined(_WIN32) \</span>
<span class="cp">    &amp;&amp; !defined(XML_POOR_ENTROPY)</span>
<span class="cp"># error</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(TIOCSWINSZ) || defined(__SCO__) || defined(__UNIXWARE__)</span>
<span class="cp">#define USE_SYSV_ENVVARS    </span><span class="cm">/* COLUMNS/LINES vs. TERMCAP */</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef XML_UNICODE_WCHAR_T</span>
<span class="cp">#define XML_T(x) (const wchar_t)x</span>
<span class="cp">#define XML_L(x) L ## x</span>
<span class="cp">#else</span>
<span class="cp">#define XML_T(x) (const unsigned short)x</span>
<span class="cp">#define XML_L(x) x</span>
<span class="cp">#endif</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">fun</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">XML_T</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>A typical configuration for the C preprocessor on the above code could be <code>cc -c -D_WIN32 -DXML_POOR_ENTROPY -DXML_UNICODE_WCHAR_T xmlparse.c</code>, defining the given preprocessor variables and selecting the appropriate code fragments.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Since the compiler can only compile one configuration at a time (implying that we can also only <em>test</em> one resulting executable at a time), your task is to find out which of these configurations actually compile.  To this end, proceed in three steps.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-1:-Extract-Preprocessor-Variables">Part 1: Extract Preprocessor Variables</h4><p>Write a <em>function</em> <code>cpp_identifiers()</code> that, given a set of lines (say, from <code>open(filename).readlines()</code>), extracts all preprocessor variables referenced in <code>#if</code> or <code>#ifdef</code> preprocessor instructions.  Apply <code>ifdef_identifiers()</code> on the sample C input above, such that</p>
<div class="highlight"><pre><span/><span class="n">cpp_identifiers</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">"xmlparse.c"</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
</pre></div>
<p>returns the set</p>
<div class="highlight"><pre><span/><span class="p">{</span><span class="s1">'_WIN32'</span><span class="p">,</span> <span class="s1">'LOAD_LIBRARY_SEARCH_SYSTEM32'</span><span class="p">,</span> <span class="s1">'HAVE_GETRANDOM'</span><span class="p">,</span> <span class="s1">'HAVE_SYSCALL_GETRANDOM'</span><span class="p">,</span> <span class="s1">'HAVE_ARC4RANDOM_BUF'</span><span class="p">,</span> <span class="o">...</span><span class="p">}</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-2:-Derive-an-Option-Grammar">Part 2: Derive an Option Grammar</h4><p>With the help of <code>cpp_identifiers()</code>, create a grammar which has C compiler invocations with a list of options, where each option takes the form <code>-D&lt;variable&gt;</code> for a preprocessor variable <code>&lt;variable&gt;</code>.  Using this grammar <code>cpp_grammar</code>, a fuzzer</p>
<div class="highlight"><pre><span/><span class="n">g</span> <span class="o">=</span> <span class="n">GrammarCoverageFuzzer</span><span class="p">(</span><span class="n">cpp_grammar</span><span class="p">)</span>
</pre></div>
<p>would create C compiler invocations such as</p>
<div class="highlight"><pre><span/><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">fuzz</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="p">[</span><span class="s1">'cc -DHAVE_SYSCALL_GETRANDOM xmlparse.c'</span><span class="p">,</span>
 <span class="s1">'cc -D__SCO__ -DRANDOM_BUF -DXML_UNICODE_WCHAR_T -D__UNIXWARE__ xmlparse.c'</span><span class="p">,</span>
 <span class="s1">'cc -DXML_POOR_ENTROPY xmlparse.c'</span><span class="p">,</span>
 <span class="s1">'cc -DRANDOM xmlparse.c'</span><span class="p">,</span>
 <span class="s1">'cc -D_WIN xmlparse.c'</span><span class="p">,</span>
 <span class="s1">'cc -DHAVE_ARC xmlparse.c'</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-3:-C-Preprocessor-Configuration-Fuzzing">Part 3: C Preprocessor Configuration Fuzzing</h4><p>Using the grammar just produced, use a <code>GrammarCoverageFuzzer</code> to</p>
<ol>
<li>Test each processor variable individually</li>
<li>Test each pair of processor variables, using <code>pairwise()</code>.</li>
</ol>
<p>What happens if you actually run the invocations?</p>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"xmlparse.c"</span><span class="p">)</span>
</pre></div>

</div>
</div>
    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">"xmlparse.o"</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"xmlparse.o"</span><span class="p">)</span>
</pre></div>

</div>
</div>
    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-2:-.ini-Configuration-Fuzzing">Exercise 2: .ini Configuration Fuzzing</h3><p>Besides command-line options, <em>configuration files</em> are another important source of configurations.  In this exercise, we will consider the very simple configuration language provided by the Python <code>ConfigParser</code> module, which is very similar to what is found in Microsoft Windows <em>.ini</em> files.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The following example for a <code>ConfigParser</code> input file stems right from <a href="https://docs.python.org/3/library/configparser.html">the ConfigParser documentation</a>:</p>

<pre><code>[DEFAULT]
ServerAliveInterval = 45
Compression = yes
CompressionLevel = 9
ForwardX11 = yes

[bitbucket.org]
User = hg

[topsecret.server.com]
Port = 50022
ForwardX11 = no</code></pre>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The above <code>ConfigParser</code> file can be created programmatically:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/configparser.html" class="import" target="_blank">configparser</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="p">[</span><span class="s1">'DEFAULT'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'ServerAliveInterval'</span><span class="p">:</span> <span class="s1">'45'</span><span class="p">,</span>
                     <span class="s1">'Compression'</span><span class="p">:</span> <span class="s1">'yes'</span><span class="p">,</span>
                     <span class="s1">'CompressionLevel'</span><span class="p">:</span> <span class="s1">'9'</span><span class="p">}</span>
<span class="n">config</span><span class="p">[</span><span class="s1">'bitbucket.org'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">config</span><span class="p">[</span><span class="s1">'bitbucket.org'</span><span class="p">][</span><span class="s1">'User'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'hg'</span>
<span class="n">config</span><span class="p">[</span><span class="s1">'topsecret.server.com'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">topsecret</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'topsecret.server.com'</span><span class="p">]</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">'Port'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'50022'</span>     <span class="c1"># mutates the parser</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">'ForwardX11'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'no'</span>  <span class="c1"># same here</span>
<span class="n">config</span><span class="p">[</span><span class="s1">'DEFAULT'</span><span class="p">][</span><span class="s1">'ForwardX11'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'yes'</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'example.ini'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'example.ini'</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">configfile</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[DEFAULT]
serveraliveinterval = 45
compression = yes
compressionlevel = 9
forwardx11 = yes

[bitbucket.org]
user = hg

[topsecret.server.com]
port = 50022
forwardx11 = no
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>and be read in again:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'example.ini'</span><span class="p">)</span>
<span class="n">topsecret</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'topsecret.server.com'</span><span class="p">]</span>
<span class="n">topsecret</span><span class="p">[</span><span class="s1">'Port'</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>'50022'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-1:-Read-Configuration">Part 1: Read Configuration</h4><p>Using <code>configparser</code>, create a program reading in the above configuration file and accessing the individual elements.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-2:-Create-a-Configuration-Grammar">Part 2: Create a Configuration Grammar</h4><p>Design a grammar that will automatically create configuration files suitable for your above program.  Fuzz your program with it.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-3:-Mine-a-Configuration-Grammar">Part 3: Mine a Configuration Grammar</h4><p>By dynamically tracking the individual accesses to configuration elements, you can again extract a basic grammar from the execution.  To this end, create a subclass of <code>ConfigParser</code> with a special method <code>__getitem__</code>:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="k">class</span> <span class="nc">TrackingConfigParser</span><span class="p">(</span><span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Accessing"</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>

</div>
</div>
    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>For a <code>TrackingConfigParser</code> object <code>p</code>, <code>p.__getitem__(key)</code> will be invoked whenever <code>p[key]</code> is accessed:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">tracking_config_parser</span> <span class="o">=</span> <span class="n">TrackingConfigParser</span><span class="p">()</span>
<span class="n">tracking_config_parser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'example.ini'</span><span class="p">)</span>
<span class="n">section</span> <span class="o">=</span> <span class="n">tracking_config_parser</span><span class="p">[</span><span class="s1">'topsecret.server.com'</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Accessing 'topsecret.server.com'
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Using <code>__getitem__()</code>, as above, implement a tracking mechanism that, while your program accesses the read configuration, automatically saves options accessed and values read.  Create a prototype grammar from these values; use it for fuzzing.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>At the end, don't forget to clean up:</p>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="kn">import</span> <span class="nn"><a href="https://docs.python.org/3/library/os.html" class="import" target="_blank">os</a></span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"example.ini"</span><span class="p">)</span>
</pre></div>

</div>
</div>
    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-3:-Extracting-and-Fuzzing-C-Command-Line-Options">Exercise 3: Extracting and Fuzzing C Command-Line Options</h3><p>In C programs, the <code>getopt()</code> function are frequently used to process configuration options.  A call</p>

<pre><code>getopt(argc, argv, "bf:")</code></pre>
<p>indicates that the program accepts two options <code>-b</code> and <code>-f</code>, with <code>-f</code> taking an argument (as indicated by the following colon).</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-1:-Getopt-Fuzzing">Part 1: Getopt Fuzzing</h4><p>Write a framework which, for a given C program, automatically extracts the argument to <code>getopt()</code> and derives a fuzzing grammar for it.  There are multiple ways to achieve this:</p>
<ol>
<li>Scan the program source code for occurrences of <code>getopt()</code> and return the string passed.  (Crude, but should frequently work.)</li>
<li>Insert your own implementation of <code>getopt()</code> into the source code (effectively replacing <code>getopt()</code> from the runtime library), which outputs the <code>getopt()</code> argument and exits the program.  Recompile and run.</li>
<li>(Advanced.) As above, but instead of changing the source code, hook into the <em>dynamic linker</em> which at runtime links the program with the C runtime library.  Set the library loading path (on Linux and Unix, this is the <code>LD_LIBRARY_PATH</code> environment variable) such that your own version of <code>getopt()</code> is linked first, and the regular libraries later.  Executing the program (without recompiling) should yield the desired result.</li>
</ol>
<p>Apply this on <code>grep</code> and <code>ls</code>; report the resulting grammars and results.</p>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h4 id="Part-2:-Fuzzing-Long-Options-in-C">Part 2: Fuzzing Long Options in C</h4><p>Same as Part 1, but also hook into the GNU variant <code>getopt_long()</code>, which accepts "long" arguments with double dashes such as <code>--help</code>.  Note that method 1, above, will not work here, since the "long" options are defined in a separately defined structure.</p>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h3 id="Exercise-4:-Expansions-in-Context">Exercise 4: Expansions in Context</h3><p>In our above option configurations, we have multiple symbols which all expand to the same integer.  For instance, the <code>--line-range</code> option of <code>autopep8</code> takes two <code>&lt;line&gt;</code> parameters which both expand into the same <code>&lt;int&gt;</code> symbol:</p>

<pre><code>&lt;option&gt; ::= ... | --line-range &lt;line&gt; &lt;line&gt; | ...
&lt;line&gt; ::= &lt;int&gt;
&lt;int&gt; ::= (-)?&lt;digit&gt;+
&lt;digit&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9</code></pre>
</div>
</div>
</div>
</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;line&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['&lt;int&gt;']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;int&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['(-)?&lt;digit&gt;+']
</pre>
</div>

</div>

<div class="input_code">
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre><span/><span class="n">autopep8_runner</span><span class="o">.</span><span class="n">ebnf_grammar</span><span class="p">()[</span><span class="s2">"&lt;digit&gt;"</span><span class="p">]</span>
</pre></div>

</div>
</div></div>
</div>
</div>

<div class="output_area">

<div class="output_text output_subarea output_execute_result">
<pre>['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
</pre>
</div>

</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Once the <code>GrammarCoverageFuzzer</code> has covered all variations of <code>&lt;int&gt;</code> (especially by covering all digits) for <em>one</em> option, though, it will no longer strive to achieve such coverage for the next option.  Yet, it could be desirable to achieve such coverage for each option separately.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>One way to achieve this with our existing <code>GrammarCoverageFuzzer</code> is again to change the grammar accordingly.  The idea is to <em>duplicate</em> expansions – that is, to replace an expansion of a symbol $s$ with a new symbol $s'$ whose definition is duplicated from $s$.  This way, $s'$ and $s$ are separate symbols from a coverage point of view and would be independently covered.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>As an example, consider again the above <code>--line-range</code> option.  If we want our tests to independently cover all elements of the two <code>&lt;line&gt;</code> parameters, we can duplicate the second <code>&lt;line&gt;</code> expansion into a new symbol <code>&lt;line'&gt;</code> with subsequent duplicated expansions:</p>

<pre><code>&lt;option&gt; ::= ... | --line-range &lt;line&gt; &lt;line'&gt; | ...
&lt;line&gt; ::= &lt;int&gt;
&lt;line'&gt; ::= &lt;int'&gt;
&lt;int&gt; ::= (-)?&lt;digit&gt;+
&lt;int'&gt; ::= (-)?&lt;digit'&gt;+
&lt;digit&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9
&lt;digit'&gt; ::= 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9</code></pre>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Design a function <code>inline(grammar, symbol)</code> that returns a duplicate of <code>grammar</code> in which every occurrence of <code>&lt;symbol&gt;</code> and its expansions become separate copies.  The above grammar could be a result of <code>inline(autopep8_runner.ebnf_grammar(), "&lt;line&gt;")</code>.</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>When copying, expansions in the copy should also refer to symbols in the copy.  Hence, when expanding <code>&lt;int&gt;</code> in</p>
<p><code>&lt;int&gt; ::= &lt;int&gt;&lt;digit&gt;</code></p>
<p>make that</p>
<p>```<int> ::= <int><digit/></int></int></p>
<p>&lt;int'&gt; ::= &lt;int'&gt;&lt;digit'&gt;
```</p>
<p>(and not <code>&lt;int'&gt; ::= &lt;int&gt;&lt;digit'&gt;</code> or <code>&lt;int'&gt; ::= &lt;int&gt;&lt;digit&gt;</code>).</p>
</div>
</div>
</div>
</div>

<div class="input_markdown">
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Be sure to add precisely one new set of symbols for each occurrence in the original grammar, and not to expand further in the presence of recursion.</p>

    
<p/><div class="solution_link"><a href="https://mybinder.org/v2/gh/uds-se/fuzzingbook/HEAD?labpath=docs%2Fnotebooks/ConfigurationFuzzer.ipynb#Exercises" target="_blank">Use the notebook</a> to work on the exercises and see solutions.</div>
</div>
</div>
</div>
</div>

        
<p class="imprint">
<img style="float:right" src="../Images/2f3faa36146c6fb38bbab67add09aa5f.png" alt="Creative Commons License" data-original-src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png"/>
The content of this project is licensed under the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
The source code that is part of the content, as well as the source code used to format and display that content is licensed under the <a href="https://github.com/uds-se/fuzzingbook/blob/master/LICENSE.md#mit-license">MIT License</a>.
<a href="https://github.com/uds-se/fuzzingbook/commits/master/notebooks/ConfigurationFuzzer.ipynb" target="_blank)">Last change: 2023-11-11 18:18:05+01:00</a> • 
<a href="#citation" id="cite" onclick="revealCitation()">Cite</a> •
<a href="https://cispa.de/en/impressum" target="_blank">Imprint</a>
</p>



<div id="citation" class="citation" style="display: none;">
<a name="citation"/>
<h2>How to Cite this Work</h2>
<p>
Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler: "<a href="https://www.fuzzingbook.org/html/ConfigurationFuzzer.html">Testing Configurations</a>".  In Andreas Zeller, Rahul Gopinath, Marcel Böhme, Gordon Fraser, and Christian Holler, "<a href="https://www.fuzzingbook.org/">The Fuzzing Book</a>", <a href="https://www.fuzzingbook.org/html/ConfigurationFuzzer.html">https://www.fuzzingbook.org/html/ConfigurationFuzzer.html</a>.  Retrieved 2023-11-11 18:18:05+01:00.
</p>
<pre>
@incollection{fuzzingbook2023:ConfigurationFuzzer,
    author = {Andreas Zeller and Rahul Gopinath and Marcel B{\"o}hme and Gordon Fraser and Christian Holler},
    booktitle = {The Fuzzing Book},
    title = {Testing Configurations},
    year = {2023},
    publisher = {CISPA Helmholtz Center for Information Security},
    howpublished = {\url{https://www.fuzzingbook.org/html/ConfigurationFuzzer.html}},
    note = {Retrieved 2023-11-11 18:18:05+01:00},
    url = {https://www.fuzzingbook.org/html/ConfigurationFuzzer.html},
    urldate = {2023-11-11 18:18:05+01:00}
}
</pre>
</div>

          
</body>
</html>